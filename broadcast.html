<script type="module">
/* ... (Firebase 초기화/DOM 참조 동일) ... */

const pcConfig = {
  iceServers: [
    { urls:'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' },
    { urls:'turn:openrelay.metered.ca:80?transport=tcp',  username:'openrelayproject', credential:'openrelayproject' }
  ],
  iceTransportPolicy: 'relay',
  bundlePolicy: 'max-bundle',
  iceCandidatePoolSize: 1
};

let pc, roomId, localStream=null, videoSender=null, answerApplied=false;

function log(t){ console.log('[BCAST]',t); statusEl.textContent=t; }

async function ensurePc() {
  if (pc) return pc;
  pc = new RTCPeerConnection(pcConfig);

  pc.oniceconnectionstatechange = ()=> log('ice: '+pc.iceConnectionState);
  pc.onconnectionstatechange    = ()=> log('pc: '+pc.connectionState);

  // 우리 ICE 후보 게시
  pc.onicecandidate = (e)=>{
    if(e.candidate){
      push(ref(db, `webrtc/${roomId}/offerCandidates`), e.candidate.toJSON());
    }
  };

  // 뷰어의 ICE 후보 반영
  onChildAdded(ref(db, `webrtc/${roomId}/answerCandidates`), (snap)=>{
    const c = snap.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
  });

  // 뷰어의 answer가 올라오면 반드시 적용 (미적용 시 재협상)
  onValue(ref(db, `webrtc/${roomId}/answer`), async (s)=>{
    const ans = s.val();
    if(!ans) return;
    try{
      if(!pc.currentRemoteDescription || pc.currentRemoteDescription.type!=='answer'){
        await pc.setRemoteDescription(new RTCSessionDescription(ans));
        answerApplied = true;
        log('answer set');
      }
    }catch(e){
      // SDP 순서 꼬임 보호: 500ms 뒤 재시도
      console.warn('setRemoteDescription retry', e);
      setTimeout(async()=>{
        try{
          await pc.setRemoteDescription(new RTCSessionDescription(ans));
          answerApplied = true;
          log('answer set (retry)');
        }catch(err){ console.error(err); }
      }, 500);
    }
  });

  return pc;
}

async function join(){
  roomId = room.value.trim();
  if(!roomId){ alert('Room ID'); return; }
  await ensurePc();

  joinBtn.disabled=true; leaveBtn.disabled=false;
  startCam.disabled=false; startShare.disabled=false; stopBtn.disabled=true; room.disabled=true;
  window.onbeforeunload = leave;
  log('joined: 카메라 또는 화면공유를 시작하세요.');
}

async function negotiate(){
  // 트릭클 지연(ICE 후보 어느정도 모아두고 올리기)
  await new Promise(r=>setTimeout(r, 150));
  const offer = await pc.createOffer({ offerToReceiveAudio:false, offerToReceiveVideo:false });
  await pc.setLocalDescription(offer);
  await set(ref(db, `webrtc/${roomId}/offer`), offer);
  log('offer published');

  // 6초 이내에 answer 적용이 안 되면 강제 재협상
  answerApplied = false;
  setTimeout(async ()=>{
    if(!answerApplied){
      log('no answer set → renegotiate');
      try{
        await pc.setLocalDescription(await pc.createOffer());
        await set(ref(db, `webrtc/${roomId}/offer`), pc.localDescription);
      }catch(e){ console.error('renegotiate failed', e); }
    }
  }, 6000);
}

async function attachStream(stream){
  preview.srcObject = stream;
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
  localStream = stream;
  const track = stream.getVideoTracks()[0];
  if(videoSender){ await videoSender.replaceTrack(track); } else { videoSender = pc.addTrack(track, stream); }
  stopBtn.disabled = true === false ? false : false; // no-op (보류)
}

async function useCamera(){
  try{
    await ensurePc();
    let stream;
    try{
      stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:{ideal:'environment'} }, audio:false });
    }catch{ stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false }); }
    await attachStream(stream);
    await negotiate();
    log('카메라 송출 중');
  }catch(e){ alert('카메라 실패: '+(e.message||e)); }
}

async function useScreen(){
  try{
    await ensurePc();
    const stream = await navigator.mediaDevices.getDisplayMedia({ video:{frameRate:30}, audio:false });
    await attachStream(stream);
    await negotiate();
    log('화면공유 송출 중');
  }catch(e){ alert('화면공유 실패: '+(e.message||e)); }
}

function stopTracks(){ try{ localStream?.getTracks().forEach(t=>t.stop()); }catch{} localStream=null; preview.srcObject=null; }

async function leave(){
  try{
    stopTracks(); try{pc?.close();}catch{}
    await remove(ref(db,`webrtc/${roomId}/offer`));
    await remove(ref(db,`webrtc/${roomId}/offerCandidates`));
    await remove(ref(db,`webrtc/${roomId}/answer`));
    await remove(ref(db,`webrtc/${roomId}/answerCandidates`));
  }catch{}
  joinBtn.disabled=false; leaveBtn.disabled=true; startCam.disabled=true; startShare.disabled=true; stopBtn.disabled=true; room.disabled=false;
  log('left');
}

/* 버튼 바인딩 */
joinBtn.onclick=join; leaveBtn.onclick=leave;
startCam.onclick=useCamera; startShare.onclick=useScreen; stopBtn.onclick=stopTracks;
</script>
