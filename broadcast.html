<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Broadcast (Phone ??WebRTC)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h1 { display:flex; align-items:center; gap:.5rem; }
    video { width: 100%; max-width: 720px; background:#000; border-radius:12px; }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; margin:.75rem 0; }
    input,button { padding:.5rem .75rem; border-radius:10px; border:1px solid #ddd; }
    button:disabled { opacity:.5; }
    .muted { color:#888; font-size:.9rem; }
  </style>
</head>
<body>
  <h1>?뱻 Phone Broadcaster</h1>
  <div class="row">
    <input id="roomId" placeholder="Room ID(?? 6?먮━)" />
    <button id="start">Start Broadcast</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <div class="muted" id="status">idle</div>
  <video id="preview" playsinline autoplay muted></video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import {
      getDatabase, ref, set, remove,
      push, onChildAdded, onValue
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const startBtn = document.getElementById('start');
    const stopBtn  = document.getElementById('stop');
    const roomInp  = document.getElementById('roomId');
    const videoEl  = document.getElementById('preview');
    const statusEl = document.getElementById('status');

    let pc, localStream, roomRef;

    function log(s){ statusEl.textContent = s; console.log('[BROADCAST]', s); }

    async function start() {
      const id = roomInp.value.trim();
      if (!id) return alert('Room ID瑜??낅젰?섏꽭??);
      roomRef = ref(db, `webrtc/${id}`);
      log('starting...');

      localStream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment', width:{ideal:1920}, height:{ideal:1080} },
        audio: false
      });
      videoEl.srcObject = localStream;

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: ['stun:stun.l.google.com:19302'] },
          { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
        ]
      });
      pc.onconnectionstatechange = () => log(`pc: ${pc.connectionState}`);
      pc.oniceconnectionstatechange = () => log(`ice: ${pc.iceConnectionState}`);

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      // ?щ윭 ICE ?꾨낫瑜??꾩쟻 ???
      pc.onicecandidate = (e) => {
        if (e.candidate) push(ref(db, `webrtc/${id}/offerCandidates`), e.candidate.toJSON());
      };

      // 酉곗뼱?먯꽌 ?ㅻ뒗 answer
      onValue(ref(db, `webrtc/${id}/answer`), async (snap) => {
        const v = snap.val();
        if (v && !pc.currentRemoteDescription) {
          await pc.setRemoteDescription(new RTCSessionDescription(v));
          log('remote answer set');
        }
      });

      // 酉곗뼱 ICE ?꾨낫??
      onChildAdded(ref(db, `webrtc/${id}/answerCandidates`), (snap)=>{
        const c = snap.val();
        if (c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
      });

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      await set(ref(db, `webrtc/${id}/offer`), offer);
      log('offer published');

      startBtn.disabled = true; stopBtn.disabled = false; roomInp.disabled = true;
      window.onbeforeunload = cleanup;
    }

    async function stop() { await cleanup(); }

    async function cleanup() {
      try { if (roomRef) await remove(roomRef); } catch {}
      try { pc?.close(); } catch {}
      try { localStream?.getTracks().forEach(t=>t.stop()); } catch {}
      startBtn.disabled = false; stopBtn.disabled = true; roomInp.disabled = false;
      log('stopped');
    }

    startBtn.onclick = start;
    stopBtn.onclick  = stop;
  </script>
</body>
</html>

