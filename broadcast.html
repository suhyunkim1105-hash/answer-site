<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Phone Broadcaster (final)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;max-width:900px;margin:0 auto;padding:16px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input,button{padding:10px 12px;border-radius:10px;border:1px solid #ccc}
    button{cursor:pointer}
    video{width:100%;max-height:60vh;background:#000;border-radius:12px;margin-top:10px}
    #status{margin-top:6px;color:#666;font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <h1>ðŸ“± Phone Broadcaster</h1>
  <div class="row">
    <input id="room" placeholder="Room ID (e.g. 1)" />
    <button id="start">Start Broadcast</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <div id="status">idle</div>
  <video id="video" autoplay playsinline muted></video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, get, remove, onChildAdded, onValue, push } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const roomInp = document.getElementById('room');
    const startBtn= document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const videoEl = document.getElementById('video');
    const statusEl= document.getElementById('status');

    let pc, roomId, localStream;

    const iceServers = [
      { urls: 'stun:stun.l.google.com:19302' },
      { urls: 'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' },
      { urls: 'turn:openrelay.metered.ca:80?transport=tcp',  username:'openrelayproject', credential:'openrelayproject' },
    ];

    function log(t){ console.log('[BROADCAST]', t); statusEl.textContent += (statusEl.textContent?'\n':'')+t; }

    async function start(){
      try{
        statusEl.textContent='idle';
        roomId = roomInp.value.trim();
        if(!roomId){ alert('Enter Room ID'); return; }

        // get camera
        localStream = await navigator.mediaDevices.getUserMedia({ video:true, audio:false });
        videoEl.srcObject = localStream;

        pc = new RTCPeerConnection({ iceServers });
        localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

        pc.onconnectionstatechange = ()=> log('pc: '+pc.connectionState);
        pc.oniceconnectionstatechange = ()=> log('ice: '+pc.iceConnectionState);

        // upload our ICE (offerCandidates)
        pc.onicecandidate = (e)=>{
          if(e.candidate){
            push(ref(db, `webrtc/${roomId}/offerCandidates`), e.candidate.toJSON());
          }
        };

        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        await set(ref(db, `webrtc/${roomId}/offer`), offer);
        log('offer published');

        // add remote ICE from viewer (answerCandidates)
        onChildAdded(ref(db, `webrtc/${roomId}/answerCandidates`), (snap)=>{
          const c = snap.val();
          if(c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
        });

        // apply viewer's answer
        onValue(ref(db, `webrtc/${roomId}/answer`), async (snap)=>{
          const answer = snap.val();
          if(answer && !pc.currentRemoteDescription){
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            log('answer set');
          }
        });

        startBtn.disabled=true; stopBtn.disabled=false; roomInp.disabled=true;
        window.onbeforeunload = stop;
      }catch(err){
        console.error(err);
        alert('Start failed: '+(err.message||err));
      }
    }

    async function stop(){
      try{
        await remove(ref(db, `webrtc/${roomId}`));
      }catch{}
      try{ if(pc) pc.close(); }catch{}
      try{ localStream?.getTracks().forEach(t=>t.stop()); }catch{}
      startBtn.disabled=false; stopBtn.disabled=true; roomInp.disabled=false;
      statusEl.textContent='stopped';
    }

    startBtn.onclick = start;
    stopBtn.onclick  = stop;
  </script>
</body>
</html>

