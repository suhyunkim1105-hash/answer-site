<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Phone Broadcaster</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif; padding:16px; max-width:700px; margin:0 auto; }
    h1 { margin:0 0 12px 0; font-size:22px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input, button { padding:10px 12px; border-radius:10px; border:1px solid #ccc; }
    button { cursor:pointer; }
    video { width:100%; border-radius:12px; background:#000; }
    .muted { color:#777; font-size:13px; margin:8px 0; }
    .ok { color:#0a7d2a; } .err{ color:#b00020; }
  </style>
</head>
<body>
  <h1>Phone Broadcaster</h1>

  <div class="row" style="margin-bottom:8px;">
    <input id="roomId" placeholder="Room ID (예: abc123)" />
    <button id="start">Start Broadcast</button>
    <button id="stop" disabled>Stop</button>
  </div>
  <div id="status" class="muted">idle</div>
  <video id="local" playsinline autoplay muted></video>

  <!-- Firebase & app -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, set, remove, onChildAdded, push, onValue } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const roomInp = document.getElementById('roomId');
    const startBtn= document.getElementById('start');
    const stopBtn = document.getElementById('stop');
    const statusEl= document.getElementById('status');
    const videoEl = document.getElementById('local');

    function log(s){ statusEl.textContent = s; console.log('[BROADCAST]', s); }

    let pc, stream, roomId, roomRef, unsubAnswer, unsubAnswerCand;

    async function getCameraStream() {
      // iOS 대응: 사용자 제스처 내부에서 호출 + muted/playsinline + play()
      const constraintsPrefRear = {
        audio: false,
        video: {
          facingMode: { ideal: 'environment' },
          width: { ideal: 1920 },
          height:{ ideal: 1080 }
        }
      };
      const constraintsFrontFallback = {
        audio: false,
        video: { facingMode: 'user' }
      };
      try {
        log('카메라 요청(후면 우선)…');
        return await navigator.mediaDevices.getUserMedia(constraintsPrefRear);
      } catch(e) {
        log('후면 실패, 전면으로 폴백…');
        return await navigator.mediaDevices.getUserMedia(constraintsFrontFallback);
      }
    }

    async function start() {
      try {
        roomId = roomInp.value.trim();
        if(!roomId){ alert('Room ID를 입력하세요'); return; }

        // 1) 카메라 열기 (iOS 필수 속성)
        videoEl.muted = true;                       // iOS 자동재생 허용
        videoEl.setAttribute('muted','');           // 일부 iOS 버전에서 필요
        videoEl.setAttribute('playsinline','');     // 전체화면 강제 방지
        videoEl.playsInline = true;

        stream = await getCameraStream();
        videoEl.srcObject = stream;
        await videoEl.play().catch(()=>{});         // iOS에서 play() 호출 필요
        log('카메라 시작');

        // 2) RTCPeerConnection
        pc = new RTCPeerConnection({
          iceServers: [
            { urls: ['stun:stun.l.google.com:19302'] },
            { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
          ]
        });
        stream.getTracks().forEach(t => pc.addTrack(t, stream));
        pc.onconnectionstatechange = () => log('pc: '+pc.connectionState);
        pc.oniceconnectionstatechange = () => log('ice: '+pc.iceConnectionState);

        pc.onicecandidate = (e) => {
          if (e.candidate) push(ref(db, `webrtc/${roomId}/offerCandidates`), e.candidate.toJSON());
        };

        // 3) Offer 만들고 RTDB에 올리기
        const offer = await pc.createOffer({ offerToReceiveAudio:false, offerToReceiveVideo:false });
        await pc.setLocalDescription(offer);
        await set(ref(db, `webrtc/${roomId}/offer`), offer);
        log('offer published');

        // 4) Viewer의 answer 기다리기
        const ansRef = ref(db, `webrtc/${roomId}/answer`);
        unsubAnswer = onValue(ansRef, async (snap) => {
          const answer = snap.val();
          if (answer && (!pc.currentRemoteDescription)) {
            await pc.setRemoteDescription(new RTCSessionDescription(answer));
            log('answer set');
          }
        });

        // 5) Viewer의 answerCandidates 수신
        unsubAnswerCand = onChildAdded(ref(db, `webrtc/${roomId}/answerCandidates`), (snap)=>{
          const c = snap.val();
          if (c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{});
        });

        startBtn.disabled = true; stopBtn.disabled = false; roomInp.disabled = true;
        window.onbeforeunload = stop;
      } catch(err) {
        console.error(err);
        log('에러: '+(err.message||err));
        alert('카메라 시작 실패: '+(err.message||err));
      }
    }

    async function stop() {
      try {
        if (unsubAnswer) unsubAnswer(); if (unsubAnswerCand) unsubAnswerCand();
      } catch {}
      try {
        if (pc) pc.close();
      } catch {}
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
      } catch {}
      try {
        // RTDB 정리
        if (roomId) {
          await remove(ref(db, `webrtc/${roomId}/offer`));
          await remove(ref(db, `webrtc/${roomId}/offerCandidates`));
          await remove(ref(db, `webrtc/${roomId}/answer`));
          await remove(ref(db, `webrtc/${roomId}/answerCandidates`));
        }
      } catch {}
      startBtn.disabled = false; stopBtn.disabled = true; roomInp.disabled = false;
      log('stopped');
    }

    startBtn.onclick = start;
    stopBtn.onclick  = stop;
  </script>
</body>
</html>
