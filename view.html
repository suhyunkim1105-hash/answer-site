<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ðŸ“¡ Viewer</title>
</head>
<body>
  <h1>ðŸ“¡ Viewer</h1>
  <input id="room" placeholder="Room ID (ì˜ˆ: 1)" />
  <button id="join">Join</button>
  <button id="leave">Leave</button>
  <div id="status">idle</div>
  <video id="video" autoplay playsinline style="width:600px; background:black"></video>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, get, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyA...ë„ˆ í‚¤...",
  authDomain: "answer-site-p2p.firebaseapp.com",
  databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "answer-site-p2p",
  storageBucket: "answer-site-p2p.appspot.com",
  messagingSenderId: "465268650182",
  appId: "1:465268650182:web:xxxx"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const roomInp = document.getElementById("room");
const joinBtn = document.getElementById("join");
const leaveBtn = document.getElementById("leave");
const video = document.getElementById("video");
const statusEl = document.getElementById("status");

let pc;

function log(m){ console.log(m); statusEl.textContent = m; }

async function join(){
  const id = roomInp.value.trim();
  if(!id){ return; }

  pc = new RTCPeerConnection();
  pc.ontrack = e => { video.srcObject = e.streams[0]; };

  const offerRef = ref(db, `webrtc/${id}/offer`);
  const snap = await get(offerRef);
  if(!snap.exists()){ log("no offer"); return; }

  const offer = snap.val();
  await pc.setRemoteDescription(offer);

  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await set(ref(db, `webrtc/${id}/answer`), answer);
  log("answer published");

  onChildAdded(ref(db, `webrtc/${id}/offerCandidates`), snap=>{
    const c = snap.val();
    if(c) pc.addIceCandidate(new RTCIceCandidate(c));
  });

  pc.onicecandidate = e=>{
    if(e.candidate){
      set(ref(db, `webrtc/${id}/answerCandidates/${crypto.randomUUID()}`), e.candidate.toJSON());
    }
  };
}

async function leave(){
  try { await remove(ref(db, `webrtc/${roomInp.value}/answer`)); } catch(e){}
  try { pc.close(); } catch(e){}
  log("left");
}

joinBtn.onclick = join;
leaveBtn.onclick = leave;
</script>
</body>
</html>


