<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Viewer (Laptop ‚Üê WebRTC)</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    h1 { display:flex; align-items:center; gap:.5rem; }
    video { width: 100%; max-width: 960px; background:#000; border-radius:12px; }
    .row { display:flex; gap:.5rem; flex-wrap:wrap; margin:.75rem 0; }
    input,button { padding:.5rem .75rem; border-radius:10px; border:1px solid #ddd; }
    button:disabled { opacity:.5; }
  </style>
</head>
<body>
  <h1>üñ•Ô∏è Viewer</h1>
  <div class="row">
    <input id="roomId" placeholder="Room ID(Î∏åÎ°úÎìúÏ∫êÏä§ÌÑ∞ÏôÄ ÎèôÏùº)" />
    <button id="join">Join</button>
    <button id="leave" disabled>Leave</button>
  </div>
  <!-- ‚ñ∂ iOS ÏûêÎèôÏû¨ÏÉù ÏúÑÌï¥ muted ÌïÑÏàò -->
  <video id="remote" playsinline autoplay muted></video>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // ‚ñ∂ ÎÑ§ firebaseConfig Í∑∏ÎåÄÎ°ú
    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    const joinBtn = document.getElementById('join');
    const leaveBtn= document.getElementById('leave');
    const roomInp = document.getElementById('roomId');
    const videoEl = document.getElementById('remote');

    // ‚ñ∂ iOS/Î™®Î∞îÏùº ÏûêÎèôÏû¨ÏÉù Î≥¥Ïû•
    videoEl.muted = true;
    videoEl.playsInline = true;

    let pc, remoteStream, roomRef;

    async function join() {
      const id = roomInp.value.trim();
      if (!id) return alert('Room IDÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî');
      roomRef = ref(db, `webrtc/${id}`);

      // BroadcasterÍ∞Ä Î®ºÏ†Ä StartÌï¥Ïïº offerÍ∞Ä Ï°¥Ïû¨
      const offerSnap = await new Promise(resolve => {
        onValue(ref(db, `webrtc/${id}/offer`), s => resolve(s), { onlyOnce: true });
      });
      const offer = offerSnap.val();
      if (!offer) return alert('Î∞©ÏÜ°Ïù¥ ÏïÑÏßÅ ÏãúÏûëÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. BroadcasterÏóêÏÑú Start ÌõÑ Îã§Ïãú ÏãúÎèÑÌïòÏÑ∏Ïöî.');

      pc = new RTCPeerConnection({
        iceServers: [
          { urls: ['stun:stun.l.google.com:19302'] },
          {
            urls: 'turn:openrelay.metered.ca:80',
            username: 'openrelayproject',
            credential: 'openrelayproject'
          }
        ]
      });

      remoteStream = new MediaStream();
      videoEl.srcObject = remoteStream;

      pc.ontrack = (e) => {
        e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
        // ‚ñ∂ Ìä∏Îûô Î∂ôÏúºÎ©¥ Ïû¨ÏÉù ÏãúÎèÑ(Î™®Î∞îÏùº Ï†ïÏ±Ö ÎåÄÏùë)
        videoEl.play().catch(()=>{ /* ÏÇ¨Ïö©Ïûê Ï†úÏä§Ï≤ò ÌõÑ ÏûêÎèô Ïû¨ÏãúÎèÑÎê† Ïàò ÏûàÏùå */ });
      };

      pc.onicecandidate = (e) => {
        if (e.candidate) set(ref(db, `webrtc/${id}/answerCandidates`), e.candidate.toJSON());
      };

      await pc.setRemoteDescription(new RTCSessionDescription(offer));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      await set(ref(db, `webrtc/${id}/answer`), answer);

      // Broadcaster ICE ÌõÑÎ≥¥ ÏàòÏã†
      onValue(ref(db, `webrtc/${id}/offerCandidates`), (snap)=>{
        const c = snap.val();
        if (c) pc.addIceCandidate(new RTCIceCandidate(c));
      });

      joinBtn.disabled = true; leaveBtn.disabled = false; roomInp.disabled = true;
      window.onbeforeunload = cleanup;
    }

    async function leave() { await cleanup(); }

    async function cleanup() {
      try { await remove(ref(db, `webrtc/${roomInp.value}/answer`)); } catch {}
      try { pc?.close(); } catch {}
      joinBtn.disabled = false; leaveBtn.disabled = true; roomInp.disabled = false;
    }

    joinBtn.onclick = join;
    leaveBtn.onclick = leave;
  </script>
</body>
</html>
