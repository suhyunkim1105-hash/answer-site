<!doctype html><html lang="ko"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Viewer (TCP-only TURN, robust)</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;max-width:960px;margin:0 auto;padding:16px}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
input,button{padding:10px 12px;border-radius:10px;border:1px solid #ccc}button{cursor:pointer}
video{width:100%;max-height:70vh;background:#000;border-radius:12px;margin-top:10px}
.muted{color:#777;font-size:13px;margin-top:6px;white-space:pre-wrap}
pre{white-space:pre-wrap;background:#f5f6f7;padding:10px;border-radius:10px;font-size:12px;max-height:220px;overflow:auto}
</style></head><body>
<h1>ğŸ¥ Viewer (TCP-only TURN, robust)</h1>
<div class="row">
  <input id="room" placeholder="Room ID (ì˜ˆ: r1)"/>
  <button id="join">Join</button>
  <button id="leave" disabled>Leave</button>
</div>
<div id="status" class="mUted">idle</div>
<video id="video" autoplay playsinline muted></video>
<pre id="log" class="mUted"></pre>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getDatabase, ref, get, set, remove, onChildAdded, onValue, off } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

const firebaseConfig = {
  apiKey:"AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
  authDomain:"answer-site-p2p.firebaseapp.com",
  databaseURL:"https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"answer-site-p2p",
  storageBucket:"answer-site-p2p.firebasestorage.app",
  messagingSenderId:"364227113735",
  appId:"1:364227113735:web:b18355cf0b16454663cba2",
  measurementId:"G-C8MRHK5ZGS"
};
const app=initializeApp(firebaseConfig), db=getDatabase(app);

const q=(id)=>document.getElementById(id);
const room=q('room'), joinBtn=q('join'), leaveBtn=q('leave');
const video=q('video'), statusEl=q('status'), logEl=q('log');

let pc, roomId, offerRef, offerCandRef; let wired=false, connectedOnce=false;

function log(t){ console.log('[VIEW]',t); statusEl.textContent=t; logEl.textContent+=String(t)+'\n'; logEl.scrollTop=1e9; }

const pcConfig={
  iceServers:[
    // TCP-only TURN (UDP ì™„ì „ ë°°ì œ)
    { urls:'turn:openrelay.metered.ca:443?transport=tcp', username:'openrelayproject', credential:'openrelayproject' },
    { urls:'turn:openrelay.metered.ca:80?transport=tcp',  username:'openrelayproject', credential:'openrelayproject' }
  ],
  iceTransportPolicy:'relay'
};

async function handleOffer(offer){
  if(!offer || wired) return;
  wired=true;
  log('offer seen â†’ setRemoteDescription');
  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  // H.264 ìš°ì„ (í˜¸í™˜ì„±)
  try{
    const t=pc.getTransceivers().find(x=>x.receiver && x.receiver.track && x.receiver.track.kind==='video') || pc.getTransceivers()[0];
    const caps=RTCRtpReceiver.getCapabilities('video');
    const prefs=[...caps.codecs].sort((a,b)=> (a.mimeType==='video/H264'?-1:0) - (b.mimeType==='video/H264'?-1:0));
    if(t?.setCodecPreferences) t.setCodecPreferences(prefs);
  }catch{}

  const answer=await pc.createAnswer();
  await pc.setLocalDescription(answer);
  await set(ref(db,`webrtc/${roomId}/answer`), answer);
  log('answer published');

  onChildAdded(offerCandRef,(snap)=>{ const c=snap.val(); if(c) pc.addIceCandidate(new RTCIceCandidate(c)).catch(()=>{}); });

  pc.onicecandidate=(e)=>{ if(e.candidate) set(ref(db,`webrtc/${roomId}/answerCandidates/${crypto.randomUUID()}`), e.candidate.toJSON()); };

  setTimeout(()=>{ if(!connectedOnce && pc?.iceConnectionState!=='connected'){ log('ice: restartIce()'); try{ pc.restartIce(); }catch{} } }, 6000);
}

async function join(){
  try{
    roomId=room.value.trim(); if(!roomId){ alert('Room ID'); return; }

    pc=new RTCPeerConnection(pcConfig);
    try{ pc.addTransceiver('video',{direction:'recvonly'}); }catch{}
    video.muted=true; video.autoplay=true; video.playsInline=true;

    pc.ontrack=(e)=>{ video.srcObject=e.streams[0]; };
    pc.oniceconnectionstatechange=()=>{ log('ice: '+pc.iceConnectionState); if(pc.iceConnectionState==='connected'){connectedOnce=true;} };
    pc.onconnectionstatechange=()=>log('pc: '+pc.connectionState);

    offerRef=ref(db,`webrtc/${roomId}/offer`);
    offerCandRef=ref(db,`webrtc/${roomId}/offerCandidates`);

    const snap=await get(offerRef);
    if(snap.exists()){ await handleOffer(snap.val()); } else { log('waiting offer...'); }

    onValue(offerRef,(s)=>{ if(s.exists()) handleOffer(s.val()); });

    joinBtn.disabled=true; leaveBtn.disabled=false; room.disabled=true;
    window.onbeforeunload=leave;

    // ê°„ë‹¨ í†µê³„(í”„ë ˆì„/ì´ˆ)ë¡œ â€œì˜ìƒ ìˆ˜ì‹  ì¤‘ì¸ì§€â€ í‘œì‹œ
    setInterval(async()=>{
      if(!pc) return;
      try{
        const stats=await pc.getStats();
        stats.forEach(r=>{
          if(r.type==='inbound-rtp' && r.kind==='video'){
            const fps=(r.framesPerSecond!=null)?r.framesPerSecond: (r.framesDecoded && r.timestamp? Math.round(r.framesDecoded) : null);
            if(fps!=null) statusEl.textContent='receiving videoâ€¦ ~'+fps+'fps';
          }
        });
      }catch{}
    },1500);
  }catch(e){ console.error(e); log('error: '+(e.message||e)); alert('Join ì‹¤íŒ¨: '+(e.message||e)); }
}

async function leave(){
  try{ off(offerRef); }catch{}
  try{ await remove(ref(db,`webrtc/${roomId}/answer`)); await remove(ref(db,`webrtc/${roomId}/answerCandidates`)); }catch{}
  try{ pc?.close(); }catch{}
  joinBtn.disabled=false; leaveBtn.disabled=true; room.disabled=false; wired=false; connectedOnce=false; log('left');
}

joinBtn.onclick=join; leaveBtn.onclick=leave;
</script>

<div class="muted" style="margin-top:10px">
â„¹ï¸ ì ˆì°¨: Broadcasterì—ì„œ <b>Join â†’ (ì¹´ë©”ë¼ ì‹œì‘ ë˜ëŠ” í™”ë©´ê³µìœ  ì‹œì‘)</b> í›„, ì´ í˜ì´ì§€ì—ì„œ Join.<br/>
ì •ìƒ ë¡œê·¸: <b>offer seen â†’ answer published â†’ ice: checking â†’ pc/ice: connected</b> (ì´í›„ ìœ„ ìƒíƒœì¤„ì— <i>receiving videoâ€¦</i>ê°€ ì£¼ê¸°ì ìœ¼ë¡œ ëœ¸)
</div>
</body></html>
