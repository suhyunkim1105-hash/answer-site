<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Answer Site</title>
  <style>
    :root { color-scheme: dark; }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, "Noto Sans KR", sans-serif;
      background: #0b0f17;
      color: #e8edf7;
    }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .card {
      background: #121a2a;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 14px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    h2 { margin: 0 0 10px; font-size: 18px; }
    .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    button {
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      background: #2b6cff;
      color: white;
    }
    button.secondary { background: #2a3350; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    input {
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: #e8edf7;
      padding: 10px 12px;
      width: 110px;
      font-weight: 700;
    }
    video {
      width: 100%;
      max-height: 55vh;
      border-radius: 14px;
      background: #000;
      border: 1px solid rgba(255,255,255,0.08);
    }
    textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.25);
      color: #e8edf7;
      padding: 10px 12px;
      box-sizing: border-box;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      line-height: 1.35;
      font-size: 13px;
    }
    .hint { opacity: 0.85; font-size: 13px; line-height: 1.5; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>카메라</h2>
      <div class="row" style="margin-bottom:10px;">
        <button id="btn-start">카메라 시작</button>
        <button id="btn-capture" class="secondary" disabled>현재 페이지 촬영</button>

        <span style="opacity:0.9;">현재 페이지</span>
        <input id="page-input" type="number" min="1" max="50" value="1" />
      </div>

      <video id="video" playsinline autoplay muted></video>
      <canvas id="capture-canvas" style="display:none;"></canvas>

      <div class="hint" style="margin-top:10px;">
        ① 시험지를 화면에 꽉 채우고<br/>
        ② 번호/보기까지 모두 나오게 맞춘 다음<br/>
        ③ <b>현재 페이지 촬영</b> 버튼을 누르면 돼.
      </div>
    </div>

    <div class="card">
      <h2>로그</h2>
      <textarea id="log" readonly></textarea>
    </div>

    <div class="card">
      <h2>OCR 확인</h2>
      <div class="hint" style="margin-bottom:8px;">
        아래에 OCR 결과 원문이 그대로 찍힘. 여기 보고 “글자가 잘 읽히는지” 즉시 확인해.
      </div>
      <textarea id="ocr-output" readonly></textarea>
    </div>

    <div class="card">
      <h2>정답</h2>
      <textarea id="answer-output" readonly></textarea>
    </div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('capture-canvas');
    const logEl = document.getElementById('log');
    const ocrEl = document.getElementById('ocr-output');
    const ansEl = document.getElementById('answer-output');
    const pageInput = document.getElementById('page-input');

    const btnStart = document.getElementById('btn-start');
    const btnCapture = document.getElementById('btn-capture');

    let stream = null;

    function nowHHMMSS() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,'0');
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      return `${hh}:${mm}:${ss}`;
    }

    function appendStatus(msg) {
      const line = `[${nowHHMMSS()}] STATUS: ${msg}`;
      logEl.value += (logEl.value ? '\n' : '') + line;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(line);
    }

    function updateOcrOutput(text, conf, hits) {
      const header = `[OCR conf=${conf ?? '-'} hits=${hits ?? '-'}]\n`;
      ocrEl.value = header + (text || '');
      ocrEl.scrollTop = 0;
    }

    function updateAnswerOutput(text, debug) {
      let out = (text || '').trim();
      if (debug) {
        out += `\n\n---\nDEBUG\npage: ${debug.page}\nmodel: ${debug.model}\nfinishReason: ${debug.finishReason || ''}\nstopToken: ${debug.stopToken || ''}`;
      }
      ansEl.value = out;
      ansEl.scrollTop = 0;
    }

    async function startCamera() {
      try {
        appendStatus('카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.');

        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        video.srcObject = stream;

        await new Promise((resolve) => {
          if (video.readyState >= 2) return resolve();
          video.onloadedmetadata = () => resolve();
        });

        appendStatus('카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.');
        btnCapture.disabled = false;
      } catch (err) {
        appendStatus('카메라 시작 실패: ' + (err && err.message ? err.message : String(err)));
        console.error(err);
      }
    }

    // dataURL -> base64 only
    function dataUrlToBase64(dataUrl) {
      if (!dataUrl) return '';
      const i = dataUrl.indexOf('base64,');
      if (i === -1) return '';
      return dataUrl.slice(i + 'base64,'.length);
    }

    async function captureAndSolveCurrentPage() {
      try {
        if (!stream) {
          appendStatus('카메라가 아직 켜지지 않았어.');
          return;
        }

        const page = parseInt(pageInput.value || '1', 10) || 1;

        appendStatus(`페이지 ${page} 촬영 중... 시험지를 흔들리지 않게 잡고 있어줘.`);

        const ctx = canvas.getContext('2d');

        // 원본 해상도로 캡처
        const vw = video.videoWidth || 1080;
        const vh = video.videoHeight || 1920;

        canvas.width = vw;
        canvas.height = vh;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // ★ 핵심: OCR 함수가 JSON(base64) 받는 구조라서 dataURL -> base64로 보내기
        const dataUrl = canvas.toDataURL('image/jpeg', 0.95);
        const b64 = dataUrlToBase64(dataUrl);

        console.log('capture size', JSON.stringify({
          width: canvas.width,
          height: canvas.height,
          length: b64 ? b64.length : 0
        }));

        appendStatus('OCR 처리 중...');

        // ★ 핵심: 서버가 뭘 기대하는지 몰라서 키를 여러 개로 같이 보냄(안전)
        const ocrRes = await fetch('/.netlify/functions/ocr', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page,
            // 가능한 케이스들을 모두 커버
            image: b64,
            imageBase64: b64,
            dataUrl: dataUrl
          })
        });

        let ocrJson = null;
        try {
          ocrJson = await ocrRes.json();
        } catch (e) {
          const t = await ocrRes.text().catch(() => '');
          ocrJson = { ok: false, error: 'OCR non-JSON response', body: t };
        }

        console.log('OCR response', ocrJson);

        if (!ocrJson.ok) {
          appendStatus(`OCR 실패: ${ocrJson.error || 'Unknown error'}`);
          return;
        }

        updateOcrOutput(ocrJson.text, ocrJson.conf, ocrJson.hits);
        appendStatus(`OCR 완료 (평균 신뢰도: ${ocrJson.conf}, 번호 패턴 수: ${ocrJson.hits}). 이제 정답을 생성할게.`);

        const solveRes = await fetch('/.netlify/functions/solve', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            page,
            ocrText: ocrJson.text
          })
        });

        let solveJson = null;
        try {
          solveJson = await solveRes.json();
        } catch (e) {
          const t = await solveRes.text().catch(() => '');
          solveJson = { ok: false, error: 'solve non-JSON response', body: t };
        }

        console.log('solve response', solveJson);

        if (!solveJson.ok) {
          appendStatus(`정답 생성 실패: ${solveJson.error || 'Unknown error'}`);
          return;
        }

        updateAnswerOutput(solveJson.text, solveJson.debug);
        appendStatus(`페이지 ${page} 정답을 생성했어. XURTH가 들리면 이 페이지는 끝이야.`);
      } catch (err) {
        appendStatus('촬영/처리 오류: ' + (err && err.message ? err.message : String(err)));
        console.error(err);
      }
    }

    btnStart.addEventListener('click', startCamera);
    btnCapture.addEventListener('click', captureAndSolveCurrentPage);

    // 초기 안내(중복 싫으면 이 줄 지워도 됨)
    appendStatus('카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.');
  </script>
</body>
</html>

