<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>autononsul - OCR + Share + TTS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0; padding:12px;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#0b0b0b; color:#fff;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    h1 { font-size:16px; margin:0 0 10px; }
    #status {
      font-size:12px; color:#c4f1ff;
      white-space:pre-wrap;
      padding:8px; border:1px solid #333;
      border-radius:10px; background:#070707;
      line-height: 1.35;
    }
    #videoBox {
      margin-top:10px; border:1px solid #333;
      border-radius:10px; overflow:hidden;
      background:#000;
    }
    video { width:100%; height:auto; display:block; }

    .row { display:flex; gap:8px; margin-top:10px; }
    button {
      flex:1;
      padding:10px 12px;
      font-size:14px;
      border-radius:10px;
      border:1px solid #555;
      background:#151515;
      color:#fff;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity:0.45; }

    textarea {
      width:100%; min-height:140px;
      margin-top:8px; padding:10px;
      border-radius:10px;
      border:1px solid #333;
      background:#060606; color:#fff;
      font-size:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
      line-height: 1.35;
    }

    .hint { font-size:11px; color:#aaa; margin-top:6px; line-height: 1.4; }
    .sectionTitle { margin-top:14px; font-size:13px; font-weight:600; }

    #shotPreviewBox {
      margin-top:8px;
      border:1px dashed #444;
      border-radius:10px;
      padding:8px;
      font-size:11px;
      color:#aaa;
    }
    #shotPreview {
      width:100%;
      border-radius:8px;
      margin-top:8px;
      display:none;
      background:#000;
    }

    #errOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.92); color:#fff;
      padding:14px; display:none; z-index:9999; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
    }
    #errOverlay button { margin-top:10px; width:auto; }

    .pill {
      display:inline-block;
      padding:2px 8px;
      border:1px solid #444;
      border-radius:999px;
      font-size:11px;
      color:#ddd;
      background:#111;
      margin-left:6px;
    }

    .miniNote {
      font-size: 11px;
      color: #9aa;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div id="errOverlay"></div>

  <h1>ì—°ì„¸ëŒ€ ë…¼ìˆ  OCR â†’ (ì‚¬ì§„+í…ìŠ¤íŠ¸ ê³µìœ ) â†’ TTS</h1>
  <div id="status">ë¡œë”©ë¨. ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</div>

  <div class="hint">
    - ëª©í‘œ í”Œë¡œìš°(ìš°ì„  1ë²ˆ ì‹œë„): <b>ì´¬ì˜+OCR</b> â†’ <b>ChatGPTë¡œ ê³µìœ (ì‚¬ì§„+í…ìŠ¤íŠ¸)</b> â†’ ChatGPTì—ì„œ <b>Send 1ë²ˆ</b><br/>
    - ë§Œì•½ ê³µìœ ì—ì„œ ì‚¬ì§„ì´ ì•ˆ ë¶™ìœ¼ë©´: <b>2ë²ˆ í”Œë¡œìš°</b>(í…ìŠ¤íŠ¸ë§Œ)ë¡œ ì „í™˜í•˜ë©´ ë¨<br/>
    - <b>TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼</b>
  </div>

  <div id="videoBox">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div id="shotPreviewBox">
    ìµœê·¼ ì´¬ì˜ ë¯¸ë¦¬ë³´ê¸° (ê³µìœ  ì‹œ ì‚¬ì§„ì´ í•¨ê»˜ ë¶™ëŠ”ì§€ í™•ì¸ìš©)
    <span class="pill" id="shotMeta">ìƒ· ì—†ìŒ</span>
    <img id="shotPreview" alt="ìµœê·¼ ì´¬ì˜ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"/>
    <div class="miniNote">
      â€» iOS/ì•± ì¡°í•©ì— ë”°ë¼ â€œí…ìŠ¤íŠ¸ë§Œ ê³µìœ â€ë¡œ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŒ(ê·¸ ê²½ìš° 2ë²ˆ í”Œë¡œìš°ë¡œ ì „í™˜).
    </div>
  </div>

  <div class="row">
    <button id="btnCapture">ğŸ“¸ ì´¬ì˜ + OCR (ìë™ 2íšŒ, ì‹¤íŒ¨ ì‹œ 3íšŒ)</button>
    <button id="btnShare" disabled>ğŸ“¤ ChatGPTë¡œ ê³µìœ (ì‚¬ì§„+í…ìŠ¤íŠ¸)</button>
  </div>

  <div class="row">
    <button id="btnCopyAll">ğŸ“‹ (ì‚¬ì§„ì œì™¸) OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
    <button id="btnClearOcr">ğŸ§¹ OCR í…ìŠ¤íŠ¸ ì§€ìš°ê¸°</button>
  </div>

  <div class="sectionTitle">â‘  OCR ëˆ„ì  í…ìŠ¤íŠ¸</div>
  <textarea id="ocrBox" placeholder="ì´¬ì˜+OCRì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— ëˆ„ì ë©ë‹ˆë‹¤."></textarea>

  <div class="sectionTitle">â‘¡ ë‹µì•ˆ(TTSìš©) ë°•ìŠ¤ (ChatGPT ë‹µì•ˆì„ ì—¬ê¸°ì— ë¶™ì—¬ë„£ê¸°)</div>
  <textarea id="ttsInput" placeholder="[ë¬¸ì œ 1] ... [ë¬¸ì œ 2] ... ë‹µì•ˆì„ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ë©´, ìë™ìœ¼ë¡œ ì½ê¸°ë¥¼ ì‹œì‘í•˜ë„ë¡ ì„¤ì •ë¼ ìˆìŠµë‹ˆë‹¤. (ì•ˆ ë˜ë©´ 'ì½ê¸° ì‹œì‘' ë²„íŠ¼ ëˆ„ë¥´ê¸°)"></textarea>

  <div class="row">
    <button id="btnTtsStart">ğŸ”Š ì½ê¸° ì‹œì‘(ë°˜ë³µ)</button>
    <button id="btnTtsStop">â¹ ì½ê¸° ì •ì§€</button>
  </div>

  <div class="hint">
    - TTSëŠ” <b>1ë°°ì†</b>ìœ¼ë¡œ ì½ê³ , ë‹¨ì–´ ì‚¬ì´ë¥¼ <b>ì•½ 5ì´ˆ ì¹¨ë¬µ</b>ìœ¼ë¡œ ë²Œë¦½ë‹ˆë‹¤.<br/>
    - ì¤„ë°”ê¿ˆì€ â€œì¤„ë°”ê¿ˆâ€, ë§ˆì¹¨í‘œëŠ” â€œë§ˆì¹¨í‘œâ€ë¼ê³  ì½ìŠµë‹ˆë‹¤. (ë„ì–´ì“°ê¸° ë‹¨ì–´ëŠ” ë§í•˜ì§€ ì•ŠìŒ)<br/>
    - ì•± ì „í™˜ í›„ ë¬´ìŒì´ ë˜ë©´: <b>ì½ê¸° ì‹œì‘</b> ë‹¤ì‹œ ëˆ„ë¥´ê¸° â†’ ê·¸ë˜ë„ ë¬´ìŒì´ë©´ <b>ìƒˆë¡œê³ ì¹¨</b><br/>
  </div>

<script>
(function(){
  const statusEl = document.getElementById("status");
  const video = document.getElementById("video");
  const btnCapture = document.getElementById("btnCapture");
  const btnShare = document.getElementById("btnShare");
  const btnCopyAll = document.getElementById("btnCopyAll");
  const btnClearOcr = document.getElementById("btnClearOcr");
  const ocrBox = document.getElementById("ocrBox");
  const ttsInput = document.getElementById("ttsInput");
  const btnTtsStart = document.getElementById("btnTtsStart");
  const btnTtsStop = document.getElementById("btnTtsStop");
  const errOverlay = document.getElementById("errOverlay");
  const shotPreview = document.getElementById("shotPreview");
  const shotMeta = document.getElementById("shotMeta");

  const OCR_URL = "/.netlify/functions/ocr";

  // ìº¡ì²˜ ìµœì í™”(ì†ë„/ì•ˆì •ì„±)
  // - í•´ìƒë„ë¥¼ ë„ˆë¬´ í¬ê²Œ ë³´ë‚´ë©´ ì—…ë¡œë“œ/ì„œë²„ ì²˜ë¦¬/ocr.spaceê°€ ëŠë ¤ì§ˆ ìˆ˜ ìˆìŒ
  // - ë„ˆë¬´ ì¤„ì´ë©´ ê¸€ìê°€ ë­‰ê°œì§ˆ ìˆ˜ ìˆìŒ
  const CAP_MAX_W = 1600;      // 1400~1800 ì‚¬ì´ ì¶”ì²œ
  const JPEG_QUALITY = 0.86;   // 0.80~0.90 ì‚¬ì´ ì¶”ì²œ

  // OCR ì¬ì‹œë„ ì •ì±…
  const OCR_TRY1_2 = 2;
  const OCR_TRY3 = 1;

  // ---- ì—ëŸ¬ ì˜¤ë²„ë ˆì´(í° í™”ë©´ ë°©ì§€)
  function showErrorOverlay(title, detail){
    try{
      errOverlay.style.display = "block";
      errOverlay.textContent = `[ERROR]\n${title}\n\n${detail || ""}\n\n(ì•„ë˜ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹«í˜)`;
      const btn = document.createElement("button");
      btn.textContent = "ë‹«ê¸°";
      btn.onclick = () => { errOverlay.style.display = "none"; errOverlay.innerHTML = ""; };
      errOverlay.appendChild(document.createElement("br"));
      errOverlay.appendChild(btn);
    }catch(e){}
  }
  window.addEventListener("error", (e) => {
    showErrorOverlay(e.message || "Unknown JS error", (e.error && e.error.stack) ? e.error.stack : "");
  });
  window.addEventListener("unhandledrejection", (e) => {
    const msg = (e && e.reason) ? (e.reason.message || String(e.reason)) : "Unhandled rejection";
    const stack = (e && e.reason && e.reason.stack) ? e.reason.stack : "";
    showErrorOverlay(msg, stack);
  });

  // ---- ì¹´ë©”ë¼
  let stream = null;
  async function startCamera(){
    try{
      statusEl.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
      video.srcObject = stream;
      statusEl.textContent = "ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ. í•œ ì¥ì´ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ ë§ì¶˜ ë’¤ 'ì´¬ì˜+OCR'ì„ ëˆ„ë¥´ì„¸ìš”.";
    }catch(e){
      statusEl.textContent = "ì¹´ë©”ë¼ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", String(e && e.message ? e.message : e));
    }
  }

  // ---- ìº¡ì²˜(dataURL) - ë¦¬ì‚¬ì´ì¦ˆ + JPEG ì••ì¶•
  function captureDataUrlOptimized(){
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;

    let outW = w;
    let outH = h;

    if (w > CAP_MAX_W){
      const ratio = CAP_MAX_W / w;
      outW = Math.round(w * ratio);
      outH = Math.round(h * ratio);
    }

    const canvas = document.createElement("canvas");
    canvas.width = outW;
    canvas.height = outH;
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(video, 0, 0, outW, outH);

    return canvas.toDataURL("image/jpeg", JPEG_QUALITY);
  }

  // ---- ìƒíƒœ ì €ì¥(ê³µìœ ìš©)
  let shotCount = 0;
  let lastShotDataUrl = null;
  let lastShotBlob = null;    // ê³µìœ ìš© íŒŒì¼
  let lastShareText = "";

  function buildSharePayload(ocrText){
    return (
`[OCR ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ì„¸íŠ¸]

- ì•„ë˜ OCR í…ìŠ¤íŠ¸ëŠ” ì‹œí—˜ì§€ì—ì„œ ì¶”ì¶œë¨
- ì´ë¯¸ì§€(ì´¬ì˜ì‚¬ì§„)ë„ í•¨ê»˜ ì²¨ë¶€ë¨(ê°€ëŠ¥í•œ ê²½ìš°)

[OCR TEXT START]
${ocrText}
[OCR TEXT END]
`
    );
  }

  async function dataUrlToBlob(dataUrl){
    // fetch(dataURL) íŒ¨í„´ì€ iOSì—ì„œë„ ëŒ€ì²´ë¡œ ë™ì‘í•˜ì§€ë§Œ,
    // ì¼ë¶€ í™˜ê²½ì—ì„œ ì‹¤íŒ¨ ê°€ëŠ¥ -> ì‹¤íŒ¨ ì‹œ fallback ì œê³µ.
    try{
      const r = await fetch(dataUrl);
      return await r.blob();
    }catch(e){
      return null;
    }
  }

  async function callOcrOnce(dataUrl){
    try{
      const res = await fetch(OCR_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          imageBase64: dataUrl,
          mode: "dual" // í•­ìƒ í•œê¸€+ì˜ì–´
        })
      });

      const json = await res.json().catch(() => null);
      if (!json || !json.ok){
        const msg = (json && (json.message || json.error)) || "OCR ì‹¤íŒ¨";
        return { ok:false, msg };
      }

      const text = (json.text || "").trim();
      const conf = (typeof json.conf === "number") ? json.conf : 0;
      if (!text) return { ok:false, msg:"OCR ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤." };

      return { ok:true, text, conf };
    }catch(e){
      return { ok:false, msg:(e.message || String(e)) };
    }
  }

  function pickBetter(best, cand){
    // conf ìš°ì„ , ê°™ìœ¼ë©´ ê¸¸ì´ê°€ ê¸´ ìª½
    if (!best || !best.ok) return cand;
    if (!cand || !cand.ok) return best;
    if ((cand.conf || 0) > (best.conf || 0)) return cand;
    if ((cand.conf || 0) === (best.conf || 0)){
      if ((cand.text || "").length > (best.text || "").length) return cand;
    }
    return best;
  }

  async function captureAndOcr(){
    const dataUrl = captureDataUrlOptimized();
    if (!dataUrl){
      statusEl.textContent = "ì˜ìƒ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. 1~2ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
      return;
    }

    btnCapture.disabled = true;
    btnShare.disabled = true;

    shotCount += 1;
    lastShotDataUrl = dataUrl;
    lastShotBlob = null;

    // ë¯¸ë¦¬ë³´ê¸°
    try{
      shotPreview.src = dataUrl;
      shotPreview.style.display = "block";
      shotMeta.textContent = `ìƒ· ${shotCount}`;
    }catch(e){}

    statusEl.textContent = `ìƒ· ${shotCount}: ì´¬ì˜ ì™„ë£Œ. OCR ìë™ 2íšŒ ì§„í–‰ ì¤‘...`;

    // OCR 2íšŒ + ë‘˜ë‹¤ ì‹¤íŒ¨í•˜ë©´ 3íšŒì°¨
    let best = null;
    let lastErr = "";

    for (let attempt = 1; attempt <= OCR_TRY1_2; attempt++){
      statusEl.textContent = `ìƒ· ${shotCount}: OCR ${attempt}íšŒì°¨ ì²˜ë¦¬ ì¤‘...`;
      const r = await callOcrOnce(dataUrl);
      if (!r.ok) lastErr = r.msg || lastErr;
      best = pickBetter(best, r);
    }

    if (!best || !best.ok){
      statusEl.textContent = `ìƒ· ${shotCount}: 2íšŒ ì‹¤íŒ¨ â†’ 3íšŒì°¨ ì¬ì‹œë„ ì¤‘...`;
      for (let i = 0; i < OCR_TRY3; i++){
        const r3 = await callOcrOnce(dataUrl);
        if (!r3.ok) lastErr = r3.msg || lastErr;
        best = pickBetter(best, r3);
      }
    }

    if (!best || !best.ok){
      statusEl.textContent =
        `ìƒ· ${shotCount}: OCR ì‹¤íŒ¨.\n` +
        `ì¡°ëª…/ê±°ë¦¬/ì´ˆì  ë‹¤ì‹œ ë§ì¶”ê³  ë‹¤ì‹œ 'ì´¬ì˜+OCR'ì„ ëˆ„ë¥´ì„¸ìš”.\n` +
        `(ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastErr || "ì •ë³´ ì—†ìŒ"})`;
      btnCapture.disabled = false;
      return;
    }

    // ëˆ„ì 
    const confStr = (typeof best.conf === "number") ? best.conf.toFixed(1) + "%" : "ì •ë³´ ì—†ìŒ";
    const header = `\n\n[ìƒ· ${shotCount}] ---------------------- (ì‹ ë¢°ë„ ëŒ€ëµ ${confStr})\n`;
    ocrBox.value = (ocrBox.value || "") + header + (best.text || "") + "\n";

    // ê³µìœ  í…ìŠ¤íŠ¸ ì¤€ë¹„
    lastShareText = buildSharePayload(ocrBox.value.trim());

    // ê³µìœ ìš© blob ì¤€ë¹„(ì‹¤íŒ¨í•´ë„ í…ìŠ¤íŠ¸ ê³µìœ ëŠ” ê°€ëŠ¥)
    lastShotBlob = await dataUrlToBlob(dataUrl);

    statusEl.textContent =
      `ìƒ· ${shotCount}: OCR ì„±ê³µ(ì‹ ë¢°ë„ ëŒ€ëµ ${confStr}).\n` +
      `ì´ì œ 'ChatGPTë¡œ ê³µìœ (ì‚¬ì§„+í…ìŠ¤íŠ¸)'ë¥¼ ëˆŒëŸ¬ì„œ ChatGPTë¡œ ë„˜ê²¨ë³´ì„¸ìš”.\n` +
      `â€» ChatGPTì—ì„œ SendëŠ” ì§ì ‘ 1ë²ˆ ëˆŒëŸ¬ì•¼ í•©ë‹ˆë‹¤.\n` +
      `â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;

    btnShare.disabled = false;
    btnCapture.disabled = false;
  }

  // ---- ê³µìœ  (ì‚¬ì§„+í…ìŠ¤íŠ¸)
  async function shareToChatGPT(){
    if (!lastShareText){
      statusEl.textContent = "ê³µìœ í•  í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € 'ì´¬ì˜+OCR'ì„ ëˆ„ë¥´ì„¸ìš”.";
      return;
    }

    if (!navigator.share){
      statusEl.textContent =
        "ì´ ë¸Œë¼ìš°ì €ëŠ” ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" +
        "ëŒ€ì‹ : 'OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬' â†’ ChatGPTì— ë¶™ì—¬ë„£ê¸°.\n" +
        "ì‚¬ì§„ì€ ë¯¸ë¦¬ë³´ê¸° ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥ í›„ ChatGPTì— ì²¨ë¶€.";
      return;
    }

    try{
      // íŒŒì¼ ê³µìœ  ê°€ëŠ¥í•œ ê²½ìš°ì—ë§Œ files ì²¨ë¶€
      let shareData = { title: "ì—°ì„¸ëŒ€ ë…¼ìˆ  OCR ì„¸íŠ¸", text: lastShareText };

      if (lastShotBlob){
        const file = new File([lastShotBlob], `shot_${shotCount}.jpg`, { type: lastShotBlob.type || "image/jpeg" });
        const candidate = { title: "ì—°ì„¸ëŒ€ ë…¼ìˆ  OCR ì„¸íŠ¸", text: lastShareText, files: [file] };

        if (navigator.canShare && navigator.canShare(candidate)){
          shareData = candidate;
        }else{
          // íŒŒì¼ ê³µìœ ê°€ ë§‰íŒ í™˜ê²½ì¼ ìˆ˜ ìˆìŒ
          statusEl.textContent =
            "í˜„ì¬ í™˜ê²½ì—ì„œ 'ì‚¬ì§„+í…ìŠ¤íŠ¸ ë™ì‹œ ê³µìœ 'ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n" +
            "ì¼ë‹¨ í…ìŠ¤íŠ¸ ê³µìœ ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.\n" +
            "ì‚¬ì§„ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥/ê³µìœ í•˜ì„¸ìš”.";
        }
      }else{
        statusEl.textContent =
          "ì‚¬ì§„ íŒŒì¼ ë³€í™˜ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤(í™˜ê²½ ì œí•œ ê°€ëŠ¥).\n" +
          "ì¼ë‹¨ í…ìŠ¤íŠ¸ ê³µìœ ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.\n" +
          "ì‚¬ì§„ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥/ê³µìœ í•˜ì„¸ìš”.";
      }

      await navigator.share(shareData);

      statusEl.textContent =
        "ê³µìœ  ì‹œíŠ¸ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤.\n" +
        "ChatGPTë¥¼ ì„ íƒí•œ ë’¤, ChatGPTì—ì„œ Send 1ë²ˆ ëˆŒëŸ¬ ì „ì†¡í•˜ì„¸ìš”.\n" +
        "â€» ìë™ ì „ì†¡ì€ iOS ì •ì±…ìƒ ë¶ˆê°€.\n" +
        "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
    }catch(e){
      statusEl.textContent =
        "ê³µìœ  ì‹¤íŒ¨: " + (e.message || String(e)) + "\n" +
        "ëŒ€ì‹ : 'OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬'ë¡œ ì§„í–‰í•˜ì„¸ìš”.\n" +
        "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
    }
  }

  // ---- OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬(ì‚¬ì§„ ì œì™¸)
  async function copyAllText(){
    const text = (ocrBox.value || "").trim();
    if (!text){
      statusEl.textContent = "ë³µì‚¬í•  OCR í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    const payload = buildSharePayload(text);

    try{
      if (navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(payload);
        statusEl.textContent = "OCR í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ChatGPTì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.";
      }else{
        const tmp = document.createElement("textarea");
        tmp.value = payload;
        tmp.style.position = "fixed";
        tmp.style.left = "-9999px";
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        document.body.removeChild(tmp);
        statusEl.textContent = "ë³µì‚¬ ì‹œë„ ì™„ë£Œ. ë¶™ì—¬ë„£ê¸° ì•ˆ ë˜ë©´ ì „ì²´ì„ íƒ í›„ ë³µì‚¬í•˜ì„¸ìš”.";
      }
    }catch(e){
      statusEl.textContent = "ë³µì‚¬ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨", String(e && e.stack ? e.stack : e));
    }
  }

  function clearOcr(){
    if (!confirm("OCR ëˆ„ì  í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì§€ìš°ê² ìŠµë‹ˆê¹Œ?")) return;
    ocrBox.value = "";
    lastShareText = "";
    btnShare.disabled = true;
    statusEl.textContent = "OCR í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.";
  }

  // ---- TTS (1ë°°ì† + ë‹¨ì–´ê°„ 5ì´ˆ ì¹¨ë¬µ + ì¤„ë°”ê¿ˆ/ë§ˆì¹¨í‘œ ë‹¨ì–´ + ë°˜ë³µ)
  let ttsPrimed = false;
  let ttsActive = false;
  let ttsStopRequested = false;
  let ttsTokens = [];
  let ttsIndex = 0;

  const WORD_GAP_MS = 5000;   // ë‹¨ì–´ ì‚¬ì´ ì¹¨ë¬µ(ìš”ì²­ëŒ€ë¡œ 5ì´ˆ)
  const LOOP_GAP_MS = 7000;   // í•œ ë°”í€´ ëë‚˜ê³  ë‹¤ìŒ ë°˜ë³µ ì „ ëŒ€ê¸°
  const RATE = 1.0;           // 1ë°°ì†

  let selectedVoice = null;

  function selectKoreanVoice(){
    try{
      const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      if (!voices || !voices.length) return null;

      const ko = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ko"));
      if (!ko.length) return null;

      // iOSì—ì„œ ìƒëŒ€ì ìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ì´ë¦„ì´ ìˆëŠ” ê²½ìš° ìš°ì„ (í™•ì‹¤í•˜ì§€ ì•ŠìŒ: ê¸°ê¸°ë§ˆë‹¤ ë‹¤ë¦„)
      const preferNames = ["Yuna", "ìœ ë‚˜", "Korean", "Seoyeon", "ì„œì—°"];
      for (const name of preferNames){
        const found = ko.find(v => (v.name || "").includes(name));
        if (found) return found;
      }

      // localService ìš°ì„ 
      const local = ko.find(v => v.localService);
      if (local) return local;

      return ko[0];
    }catch(e){
      return null;
    }
  }

  function primeTTSOnce(){
    if (ttsPrimed) return;
    ttsPrimed = true;

    try{
      // voices ë¡œë”© íƒ€ì´ë° ë¬¸ì œ ëŒ€ì‘
      selectedVoice = selectKoreanVoice();
      if (window.speechSynthesis){
        window.speechSynthesis.onvoiceschanged = () => {
          selectedVoice = selectKoreanVoice();
        };
      }

      const u = new SpeechSynthesisUtterance("ìŒì„± ì—°ê²°");
      u.lang = "ko-KR";
      u.rate = 1.0;
      if (selectedVoice) u.voice = selectedVoice;
      u.onend = () => { try{ window.speechSynthesis.cancel(); }catch(e){} };
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function buildTokens(text){
    // ê·œì¹™:
    // - ë§ˆì¹¨í‘œëŠ” "ë§ˆì¹¨í‘œ"ë¼ê³  ë§í•œë‹¤.
    // - ì¤„ë°”ê¿ˆì€ "ì¤„ë°”ê¿ˆ"ì´ë¼ê³  ë§í•œë‹¤.
    // - ë„ì–´ì“°ê¸°ë¼ëŠ” ë‹¨ì–´ëŠ” ë§í•˜ì§€ ì•ŠëŠ”ë‹¤(ëŒ€ì‹  ì¹¨ë¬µìœ¼ë¡œ ê°„ê²©).
    let t = String(text || "");
    t = t.replace(/\r/g, "");
    t = t.replace(/\./g, " ë§ˆì¹¨í‘œ ");
    // ë‹¤ë¥¸ ê¸°í˜¸ëŠ” ë§ë¡œ ë°”ê¾¸ì§€ ì•ŠìŒ(ê·¸ëŒ€ë¡œ ì½íˆê±°ë‚˜ ë¬´ì‹œë  ìˆ˜ ìˆìŒ)
    const lines = t.split(/\n+/).map(x => x.trim()).filter(Boolean);

    const out = [];
    for (let i = 0; i < lines.length; i++){
      if (i > 0) out.push("ì¤„ë°”ê¿ˆ");
      const words = lines[i].split(/\s+/).filter(Boolean);
      for (const w of words) out.push(w);
    }
    return out;
  }

  function speakNext(){
    if (!ttsActive || ttsStopRequested) return;
    if (!ttsTokens.length){
      ttsActive = false;
      return;
    }

    const token = ttsTokens[ttsIndex];

    const u = new SpeechSynthesisUtterance(token);
    u.lang = "ko-KR";
    u.rate = RATE;
    u.pitch = 1.0;
    if (selectedVoice) u.voice = selectedVoice;

    u.onend = () => {
      if (ttsStopRequested) return;

      ttsIndex++;
      if (ttsIndex >= ttsTokens.length){
        ttsIndex = 0;
        setTimeout(() => {
          if (!ttsActive || ttsStopRequested) return;
          speakNext();
        }, LOOP_GAP_MS);
      }else{
        setTimeout(() => {
          if (!ttsActive || ttsStopRequested) return;
          speakNext();
        }, WORD_GAP_MS);
      }
    };

    u.onerror = () => {
      if (ttsStopRequested) return;
      // iOSì—ì„œ ê°€ë” ë¬´ìŒ/ì—ëŸ¬ê°€ ë‚˜ë©´ ë‹¤ìŒ í† í°ìœ¼ë¡œ ë„˜ê²¨ì„œ íšŒë³µ ì‹œë„
      setTimeout(() => {
        if (!ttsActive || ttsStopRequested) return;
        ttsIndex = Math.min(ttsIndex + 1, ttsTokens.length - 1);
        speakNext();
      }, WORD_GAP_MS);
    };

    try{
      window.speechSynthesis.speak(u);
    }catch(e){
      statusEl.textContent =
        "TTS ì˜¤ë¥˜: " + (e.message || String(e)) + "\n" +
        "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
    }
  }

  function startTts(){
    if (!window.speechSynthesis){
      statusEl.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” TTSë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const text = (ttsInput.value || "").trim();
    if (!text){
      statusEl.textContent = "TTS ë°•ìŠ¤ì— ë‹µì•ˆì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.";
      return;
    }

    primeTTSOnce();

    // iOSì—ì„œ ì•± ì „í™˜ í›„ ê¼¬ì˜€ì„ ìˆ˜ ìˆìœ¼ë‹ˆ ì‹œì‘í•  ë•Œ cancel
    ttsStopRequested = false;
    ttsActive = false;
    try{ window.speechSynthesis.cancel(); }catch(e){}

    selectedVoice = selectKoreanVoice() || selectedVoice;

    ttsTokens = buildTokens(text);
    if (!ttsTokens.length){
      statusEl.textContent = "ì½ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    ttsIndex = 0;
    ttsActive = true;

    statusEl.textContent =
      "TTS ì‹œì‘: 1ë°°ì† + ë‹¨ì–´ ê°„ ì•½ 5ì´ˆ ì¹¨ë¬µ + ë°˜ë³µ.\n" +
      "ì•± ì „í™˜ í›„ ë¬´ìŒì´ë©´ 'ì½ê¸° ì‹œì‘' ë‹¤ì‹œ ëˆ„ë¥´ê¸° â†’ ê·¸ë˜ë„ ë¬´ìŒì´ë©´ ìƒˆë¡œê³ ì¹¨.\n" +
      "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";

    speakNext();
  }

  function stopTts(){
    ttsStopRequested = true;
    ttsActive = false;
    try{ window.speechSynthesis.cancel(); }catch(e){}
    statusEl.textContent = "TTS ì •ì§€.";
  }

  // ---- ì•± ì „í™˜ ê°ì§€(ë¬´ìŒ ë°©ì§€ ì•ˆë‚´)
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden"){
      // iOSëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ TTS/íƒ€ì´ë¨¸ê°€ ë©ˆì¶œ ìˆ˜ ìˆìŒ
      return;
    }

    // ë‹¤ì‹œ ëŒì•„ì˜¨ ê²½ìš°
    // ìë™ ì¬ê°œëŠ” iOS ì •ì±…ìƒ/ì•ˆì •ì„±ìƒ í•˜ì§€ ì•ŠìŒ(ë¬´ìŒ/ê¼¬ì„ ìœ ë°œ)
    // ëŒ€ì‹  ì‚¬ìš©ìì—ê²Œ ì•ˆë‚´
    statusEl.textContent =
      "ì•± ì „í™˜ í›„ ëŒì•„ì˜´.\n" +
      "TTSê°€ ì•ˆ ë‚˜ì˜¤ë©´ 'ì½ê¸° ì‹œì‘'ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”.\n" +
      "ê·¸ë˜ë„ ë¬´ìŒì´ë©´ ìƒˆë¡œê³ ì¹¨.\n" +
      "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
  });

  // ---- ë¶™ì—¬ë„£ê¸° ìë™ ì‹œì‘(ì‚¬ìš©ì ë™ì‘ ì´ë²¤íŠ¸ì´ë¯€ë¡œ iOSì—ì„œ í—ˆìš©ë  ê°€ëŠ¥ì„± ë†’ìŒ)
  ttsInput.addEventListener("paste", () => {
    setTimeout(() => {
      // ìë™ ì‹œì‘ì´ ë§‰í ìˆ˜ë„ ìˆìœ¼ë¯€ë¡œ ì‹¤íŒ¨í•´ë„ ê´œì°®ê²Œ ì„¤ê³„
      try{ startTts(); }catch(e){}
    }, 60);
  });

  // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”©
  btnCapture.addEventListener("click", captureAndOcr);
  btnShare.addEventListener("click", shareToChatGPT);
  btnCopyAll.addEventListener("click", copyAllText);
  btnClearOcr.addEventListener("click", clearOcr);
  btnTtsStart.addEventListener("click", startTts);
  btnTtsStop.addEventListener("click", stopTts);

  // ---- ì‹œì‘
  startCamera();

})();
</script>
</body>
</html>
