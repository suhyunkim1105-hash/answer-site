<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>answer-site</title>
  <style>
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif; background:#0b0f14; color:#e6eef6; }
    .wrap { max-width: 920px; margin: 0 auto; padding: 16px; }
    .card { background:#121a23; border:1px solid #1f2a36; border-radius:14px; padding:14px; margin-bottom:12px; }
    h2 { margin: 0 0 10px 0; font-size: 18px; }
    button { appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; }
    button.primary { background:#2d6cdf; color:white; }
    button.secondary { background:#243244; color:#e6eef6; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    input { background:#0f1620; color:#e6eef6; border:1px solid #233244; border-radius:10px; padding:10px; width: 80px; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    video, img { width: 100%; border-radius: 12px; background:#000; }
    pre { white-space: pre-wrap; word-break: break-word; background:#0f1620; border:1px solid #233244; border-radius:12px; padding:12px; margin: 10px 0 0 0; }
    .muted { color:#9bb0c6; font-size: 13px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>카메라</h2>
      <div class="row">
        <button id="btnStart" class="primary">카메라 시작</button>
        <button id="btnCapture" class="secondary" disabled>현재 페이지 촬영</button>
        <span class="muted">현재 페이지</span>
        <input id="pageInput" type="number" min="1" value="1" />
      </div>
      <div style="margin-top:12px;">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>
      <div class="muted" style="margin-top:10px;">
        ① 시험지를 화면에 꽉 채우고<br/>
        ② 글자/문항번호/보기까지 선명하게 보이게 맞춘 뒤<br/>
        ③ “현재 페이지 촬영”을 누르면 OCR → 정답 생성 순으로 진행.
      </div>
    </div>

    <div class="card">
      <h2>로그</h2>
      <pre id="log"></pre>
    </div>

    <div class="card">
      <h2>OCR 원문 확인</h2>
      <div class="muted">여기에서 OCR이 얼마나 제대로 뽑혔는지 즉시 확인해. (정답률 90%의 핵심)</div>
      <pre id="ocrBox">(아직 OCR 없음)</pre>
    </div>

    <div class="card">
      <h2>정답 출력</h2>
      <pre id="answerBox">(아직 정답 없음)</pre>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const btnStart = $("btnStart");
    const btnCapture = $("btnCapture");
    const pageInput = $("pageInput");
    const video = $("video");
    const canvas = $("canvas");
    const logEl = $("log");
    const ocrBox = $("ocrBox");
    const answerBox = $("answerBox");

    let stream = null;
    let busy = false;

    function log(msg) {
      const now = new Date();
      const ts = now.toTimeString().slice(0, 8);
      logEl.textContent += `[${ts}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function startCamera() {
      try {
        log("STATUS: 카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.");
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment",
            width: { ideal: 1080 },
            height: { ideal: 1920 }
          },
          audio: false
        });
        video.srcObject = stream;
        await video.play();
        btnCapture.disabled = false;
        log("STATUS: 카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.");
      } catch (e) {
        log("ERROR: 카메라 켜기 실패: " + (e && e.message ? e.message : String(e)));
      }
    }

    function captureToDataURL() {
      const w = video.videoWidth || 1080;
      const h = video.videoHeight || 1920;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d", { willReadFrequently: false });
      ctx.drawImage(video, 0, 0, w, h);

      // ✅ OCR에 유리하게 JPEG 품질 높게
      const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
      const approxBytes = Math.floor((dataUrl.length * 3) / 4);
      log(`capture size {"width":${w},"height":${h},"length":${approxBytes}}`);
      return dataUrl;
    }

    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });
      const text = await res.text();
      let json = null;
      try { json = JSON.parse(text); } catch { /* ignore */ }
      return { ok: res.ok, status: res.status, json, raw: text };
    }

    async function runOCR(dataUrl, page) {
      log("STATUS: OCR 처리 중...");
      const r = await postJSON("/.netlify/functions/ocr", { image: dataUrl, page });
      if (!r.ok || !r.json) {
        log(`STATUS: OCR 실패: ${r.json && r.json.error ? r.json.error : "Unknown error"}`);
        if (r.raw) log("OCR raw: " + r.raw.slice(0, 500));
        return null;
      }
      log("OCR response " + JSON.stringify(r.json));
      return r.json;
    }

    async function runSolve(ocrText, page) {
      log("STATUS: OCR 완료. 이제 정답을 생성할게.");
      const r = await postJSON("/.netlify/functions/solve", { ocrText, page });
      if (!r.ok || !r.json) {
        log(`STATUS: solve 실패: ${r.json && r.json.error ? r.json.error : "Unknown error"}`);
        if (r.raw) log("solve raw: " + r.raw.slice(0, 500));
        return null;
      }
      log("solve response " + JSON.stringify(r.json));
      return r.json;
    }

    async function captureFlow() {
      if (busy) {
        log("STATUS: 지금 처리 중이야(중복 촬영 방지).");
        return;
      }
      busy = true;
      btnCapture.disabled = true;

      try {
        const page = Number(pageInput.value || 1);
        log(`STATUS: 페이지 ${page} 촬영 중... 시험지를 흔들리지 않게 잡고 있어줘.`);
        const dataUrl = captureToDataURL();

        const ocr = await runOCR(dataUrl, page);
        if (!ocr || !ocr.ok) {
          // ocrBox 업데이트(실패 표시)
          ocrBox.textContent = `(OCR 실패)\n${ocr && ocr.error ? ocr.error : "Unknown"}`;
          return;
        }

        // ✅ OCR 원문 확인 박스
        ocrBox.textContent = (ocr.text || "").trim() || "(빈 OCR 텍스트)";
        // OCR 신뢰도/히트 같은 메타가 있으면 로그로만
        if (ocr.conf !== undefined || ocr.hits !== undefined) {
          log(`STATUS: OCR 완료 (평균 신뢰도: ${ocr.conf ?? "?"}, 번호 패턴 수: ${ocr.hits ?? "?"}). 이제 정답을 생성할게.`);
        }

        const solved = await runSolve(ocr.text || "", page);
        if (!solved || !solved.ok) {
          answerBox.textContent = `(solve 실패)\n${solved && solved.error ? solved.error : "Unknown"}`;
          return;
        }

        answerBox.textContent = (solved.text || "").trim() || "(빈 정답)";
        log(`STATUS: 페이지 ${page} 정답을 생성했어. XURTH가 들리면 이 페이지는 끝이야.`);
      } finally {
        busy = false;
        btnCapture.disabled = false;
      }
    }

    btnStart.addEventListener("click", startCamera);
    btnCapture.addEventListener("click", captureFlow);
  </script>
</body>
</html>
