<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>ë…¼ìˆ  ìë™ OCR ë°ëª¨</title>

<!-- Tesseract -->
<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
  body { font-family: sans-serif; margin: 20px; }
  video { width: 100%; max-height: 300px; background: #000; }
  textarea { width: 100%; height: 200px; margin-top: 10px; }
  #answerBox { white-space: pre-wrap; border: 1px solid #444; padding: 10px; }
</style>
</head>

<body>

<h2>ğŸ“· ì‹¤ì‹œê°„ ë…¼ìˆ  OCR + ë°°ìœ¨ ì¡°ì ˆ</h2>

<video id="video" autoplay playsinline></video>

<!-- ğŸ”¥ ë„ˆê°€ ì§ì ‘ ì¡°ì ˆí•˜ëŠ” zoom slider -->
<div>
  <label>ì¹´ë©”ë¼ ì¤Œ(ë°°ìœ¨):</label>
  <input type="range" id="zoomSlider" min="1" max="5" step="0.1" value="1" />
  <span id="zoomVal">1.0x</span>
</div>

<button id="startBtn">ì‹¤ì‹œê°„ OCR ì‹œì‘</button>
<button id="stopBtn">ì¤‘ì§€</button>
<button id="solveBtn">í’€ì´ ì‹œì‘</button>

<h3>OCR ê²°ê³¼</h3>
<textarea id="ocrOut"></textarea>

<h3>ë‹µì•ˆ</h3>
<div id="answerBox"></div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
/* -------------------------------------------------------
   ì „ì—­ ë³€ìˆ˜
------------------------------------------------------- */
let stream = null;
let ocrTimer = null;
let accumulatedText = "";     // ğŸ”¥ ëˆ„ì  OCR
const solveURL = "/.netlify/functions/solve";

/* -------------------------------------------------------
   ì¹´ë©”ë¼ ì‹œì‘
------------------------------------------------------- */
async function initCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    document.getElementById("video").srcObject = stream;
  } catch (e) {
    alert("ì¹´ë©”ë¼ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + e);
  }
}

/* -------------------------------------------------------
   ğŸ”¥ ë°°ìœ¨(ì¤Œ) ì¡°ì ˆ â€” ë„¤ê°€ ì§ì ‘ ì¡°ì ˆí•˜ëŠ” ê¸°ëŠ¥
   (iOS Safariì—ì„œ ì§€ì›ë˜ëŠ” ê¸°ê¸°ì—ì„œë§Œ ì‹¤ì œ ì¤Œ ì ìš©ë¨)
------------------------------------------------------- */
async function applyZoom() {
  if (!stream) return;
  const videoTrack = stream.getVideoTracks()[0];
  const caps = videoTrack.getCapabilities?.();
  const zoomSlider = document.getElementById("zoomSlider");
  const zoomVal = document.getElementById("zoomVal");

  let zoomLevel = Number(zoomSlider.value);
  zoomVal.textContent = zoomLevel.toFixed(1) + "x";

  if (caps && caps.zoom) {
    try {
      await videoTrack.applyConstraints({ advanced: [{ zoom: zoomLevel }] });
    } catch (e) {
      console.log("ì¤Œ ì ìš© ë¶ˆê°€:", e);
    }
  }
}

document.getElementById("zoomSlider").addEventListener("input", applyZoom);

/* -------------------------------------------------------
   ğŸ”¥ OCR í›„ì²˜ë¦¬ â€” í•œê¸€ + ìˆ«ì + ë™ê·¸ë¼ë¯¸ ìˆ«ìë§Œ ìœ ì§€
------------------------------------------------------- */
function normalizeOcrText(text) {
  let t = String(text || "");

  // ì˜ì–´ ì œê±°
  t = t.replace(/[A-Za-z]/g, "");

  // í•œê¸€, ìˆ«ì, ë™ê·¸ë¼ë¯¸ ìˆ«ìë§Œ ë‚¨ê¸°ê³  ë‚˜ë¨¸ì§€ëŠ” ì œê±°
  // ë™ê·¸ë¼ë¯¸ ìˆ«ì:
  // â‘ -â‘³: \u2460-\u2473
  // â€-â‰: \u2780-\u2789
  // ã‰ -ã‰¯: \u3260-\u327F
  t = t.replace(/[^ê°€-í£0-9\u2460-\u2473\u2780-\u2789\u3260-\u327F\s]/g, " ");

  // ì¤„ ë í•˜ì´í”ˆ ì œê±°
  t = t.replace(/-\s*\n\s*/g, "");

  // ê³µë°± ì •ë¦¬
  t = t.replace(/[ \t]+\n/g, "\n");
  t = t.replace(/\n[ \t]+/g, "\n");
  t = t.replace(/[ \t]{2,}/g, " ");

  // ì œì–´ ë¬¸ì ì œê±°
  t = t.replace(/[\u0000-\u001F\u007F]/g, "");

  return t.trim();
}

/* -------------------------------------------------------
   OCR 1íšŒ ì‹¤í–‰
------------------------------------------------------- */
async function doOCR() {
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const {
    data: { text }
  } = await Tesseract.recognize(canvas, "kor", {
    tessedit_pageseg_mode: 1
  });

  let cleaned = normalizeOcrText(text);

  // ğŸ”¥ ëˆ„ì 
  if (cleaned.length > 0) {
    accumulatedText += "\n" + cleaned;
  }

  document.getElementById("ocrOut").value = accumulatedText;
}

/* -------------------------------------------------------
   ë²„íŠ¼ ë™ì‘
------------------------------------------------------- */
document.getElementById("startBtn").onclick = () => {
  if (ocrTimer) return;
  ocrTimer = setInterval(doOCR, 2000); // 2ì´ˆ ê°„ê²© OCR
};

document.getElementById("stopBtn").onclick = () => {
  if (ocrTimer) {
    clearInterval(ocrTimer);
    ocrTimer = null;
  }
};

document.getElementById("solveBtn").onclick = async () => {
  const txt = accumulatedText.trim();
  if (txt.length < 500) {
    alert("ì§€ë¬¸ì´ ë„ˆë¬´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë” ì˜¤ë˜ ë¹„ì¶°ì£¼ì„¸ìš”.");
    return;
  }

  const resp = await fetch(solveURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ocrText: txt })
  });

  const ctype = resp.headers.get("content-type") || "";
  let body;

  if (ctype.includes("application/json")) {
    const data = await resp.json();
    body = data;
    document.getElementById("answerBox").textContent = data.answer || "";
  } else {
    body = await resp.text();
    document.getElementById("answerBox").textContent = body;
  }
};

/* -------------------------------------------------------
   ì´ˆê¸° ì¹´ë©”ë¼ ì‹¤í–‰
------------------------------------------------------- */
initCamera();
</script>

</body>
</html>



