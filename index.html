<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í¸ì… ì˜ì–´ ìë™ ì±„ì  (answer-site)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid #1f2937;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    header h1 {
      font-size: 16px;
      margin: 0;
    }
    header .badge {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 999px;
      background: #1f2937;
      color: #9ca3af;
    }
    main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.1fr);
      gap: 12px;
      padding: 12px;
    }
    @media (max-width: 900px) {
      main {
        grid-template-columns: 1fr;
      }
    }
    .panel {
      background: #020617;
      border-radius: 12px;
      border: 1px solid #1f2937;
      padding: 10px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .panel h2 {
      margin: 0;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      color: #e5e7eb;
    }
    .panel h2 span {
      font-size: 11px;
      color: #9ca3af;
      font-weight: normal;
    }
    .video-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
      background: #020617;
      border: 1px solid #1f2937;
      aspect-ratio: 9 / 16;
      max-height: 70vh;
    }
    video, canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 6px;
    }
    .controls input[type="number"] {
      width: 70px;
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid #374151;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
    }
    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: #2563eb;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn.secondary {
      background: #111827;
      color: #e5e7eb;
      border: 1px solid #374151;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .small-label {
      font-size: 11px;
      color: #9ca3af;
    }
    textarea {
      width: 100%;
      min-height: 120px;
      max-height: 260px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-size: 12px;
      padding: 8px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .log {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      max-height: 210px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    .answers-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      min-height: 80px;
      max-height: 210px;
      overflow-y: auto;
      white-space: pre-wrap;
    }
    footer {
      padding: 8px 12px;
      border-top: 1px solid #1f2937;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <header>
    <h1>í¸ì… ì˜ì–´ ìë™ ì±„ì  Â· ì¹´ë©”ë¼ â†’ OCR â†’ GPT</h1>
    <div class="badge">ì‹¤ì „ìš© Â· ì •ë‹µë§Œ ì¶œë ¥</div>
  </header>

  <main>
    <!-- ì™¼ìª½: ì¹´ë©”ë¼ -->
    <section class="panel">
      <h2>
        ì¹´ë©”ë¼ / ì´¬ì˜
        <span>ì‹œí—˜ì§€ ì „ì²´ê°€ ê½‰ ì°¨ê²Œ ë‚˜ì˜¤ë„ë¡ ë§ì¶”ê³  ì´¬ì˜</span>
      </h2>
      <div class="video-wrapper">
        <video id="video" autoplay playsinline muted></video>
      </div>
      <div class="controls">
        <label class="small-label">
          í˜ì´ì§€:
          <input type="number" id="pageInput" min="1" value="1" />
        </label>
        <button id="captureBtn" class="btn">ğŸ“¸ ì´¬ì˜ + í’€ì´</button>
        <button id="stopCamBtn" class="btn secondary">â¹ ì¹´ë©”ë¼ ë„ê¸°</button>
        <button id="startCamBtn" class="btn secondary">â–¶ ì¹´ë©”ë¼ ë‹¤ì‹œ ì¼œê¸°</button>
      </div>
      <div class="small-label">
        * B4 ì‹œí—˜ì§€ ê¸°ì¤€: ì‹œí—˜ì§€ê°€ í™”ë©´ ì•ˆì— ê½‰ ì°¨ë„ë¡, ê¸°ìš¸ì–´ì§€ì§€ ì•Šê²Œ ë§ì¶”ê³  ëˆŒëŸ¬ ì°ê¸°.
      </div>
    </section>

    <!-- ì˜¤ë¥¸ìª½: ë¡œê·¸ / OCR / ì •ë‹µ -->
    <section class="panel">
      <h2>
        ë¡œê·¸ Â· OCR í…ìŠ¤íŠ¸ Â· ì •ë‹µ
        <span>ì •ë‹µì€ í•­ìƒ â€œë²ˆí˜¸: ì•ŒíŒŒë²³â€ í˜•ì‹ìœ¼ë¡œë§Œ ì¶œë ¥</span>
      </h2>
      <div class="log" id="logBox"></div>

      <div>
        <div class="small-label">OCR ê²°ê³¼ í…ìŠ¤íŠ¸ (ê²€ì‚°ìš©)</div>
        <textarea id="ocrTextBox" placeholder="OCR ê²°ê³¼ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      </div>

      <div>
        <div class="small-label">ì •ë‹µ (GPT)</div>
        <div id="answersBox" class="answers-box"></div>
      </div>

      <div class="controls">
        <button id="speakBtn" class="btn secondary">ğŸ”Š ì •ë‹µ ì½ì–´ì£¼ê¸°</button>
        <button id="stopSpeakBtn" class="btn secondary">ğŸ”‡ TTS ì¤‘ì§€</button>
      </div>
    </section>
  </main>

  <footer>
    <div>ëª¨ë¸: <span id="modelInfo">ì•Œ ìˆ˜ ì—†ìŒ</span></div>
    <div>Tip: ê°™ì€ í˜ì´ì§€ëŠ” ì—¬ëŸ¬ ë²ˆ ì°ì–´ì„œ ì œì¼ ì˜ ë‚˜ì˜¨ ì‹œë„ë§Œ ì‚¬ìš©í•´ë„ ë¨.</div>
  </footer>

  <script>
    const video = document.getElementById("video");
    const captureBtn = document.getElementById("captureBtn");
    const stopCamBtn = document.getElementById("stopCamBtn");
    const startCamBtn = document.getElementById("startCamBtn");
    const pageInput = document.getElementById("pageInput");
    const logBox = document.getElementById("logBox");
    const ocrTextBox = document.getElementById("ocrTextBox");
    const answersBox = document.getElementById("answersBox");
    const speakBtn = document.getElementById("speakBtn");
    const stopSpeakBtn = document.getElementById("stopSpeakBtn");
    const modelInfo = document.getElementById("modelInfo");

    let mediaStream = null;

    function timeStamp() {
      const d = new Date();
      return d.toTimeString().slice(0, 8);
    }

    function appendLog(msg) {
      const line = `[${timeStamp()}] ${msg}`;
      logBox.textContent += (logBox.textContent ? "\n" : "") + line;
      logBox.scrollTop = logBox.scrollHeight;
      console.log(line);
    }

    async function startCamera() {
      try {
        if (mediaStream) return;
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment"
          },
          audio: false
        });
        video.srcObject = mediaStream;
        appendLog("STATUS: ì¹´ë©”ë¼ê°€ ì¼œì¡Œì–´. ì‹œí—˜ì§€ë¥¼ í™”ë©´ì— ê½‰ ì°¨ê²Œ ë§ì¶°ì¤˜.");
      } catch (err) {
        console.error(err);
        appendLog("ERROR: ì¹´ë©”ë¼ë¥¼ ì¼œëŠ” ë° ì‹¤íŒ¨í–ˆì–´. ê¶Œí•œ/ë¸Œë¼ìš°ì € ì„¤ì • í™•ì¸ í•„ìš”.");
      }
    }

    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
        video.srcObject = null;
        appendLog("STATUS: ì¹´ë©”ë¼ë¥¼ ê»ì–´.");
      }
    }

    async function captureAndSolve() {
      if (!mediaStream) {
        appendLog("ERROR: ì¹´ë©”ë¼ê°€ êº¼ì ¸ ìˆì–´. ë¨¼ì € ì¹´ë©”ë¼ë¥¼ ì¼œì¤˜.");
        return;
      }
      const page = Number(pageInput.value || "1");
      captureBtn.disabled = true;
      appendLog(`STATUS: í˜ì´ì§€ ${page} ì´¬ì˜ ì¤‘... ì‹œí—˜ì§€ë¥¼ í”ë“¤ë¦¬ì§€ ì•Šê²Œ ì¡ê³  ìˆì–´ì¤˜.`);

      const track = mediaStream.getVideoTracks()[0];
      const settings = track.getSettings ? track.getSettings() : {};
      const width = settings.width || video.videoWidth || 1080;
      const height = settings.height || video.videoHeight || 1920;

      const canvas = document.createElement("canvas");
      canvas.width = width;
      canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, width, height);

      const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
      appendLog(`STATUS: capture size {"width":${width},"height":${height},"length":${dataUrl.length}}`);
      appendLog("STATUS: OCR ì²˜ë¦¬ ì¤‘...");

      try {
        // 1) OCR
        const ocrRes = await fetch("/.netlify/functions/ocr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ image: dataUrl, page })
        });
        const ocrJson = await ocrRes.json();
        console.log("OCR response", ocrJson);
        if (!ocrJson.ok) {
          appendLog(`OCR ì‹¤íŒ¨: ${ocrJson.error || "Unknown"}`);
          captureBtn.disabled = false;
          return;
        }
        appendLog(`STATUS: OCR ì™„ë£Œ. ì´ì œ ì •ë‹µì„ ìƒì„±í• ê²Œ.`);
        ocrTextBox.value = ocrJson.text || "";

        // 2) Solve
        appendLog("STATUS: GPTë¡œ ì •ë‹µ ìƒì„± ì¤‘...");
        const solveRes = await fetch("/.netlify/functions/solve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ocrText: ocrJson.text, page })
        });
        const solveJson = await solveRes.json();
        console.log("solve response", solveJson);

        if (!solveJson.ok) {
          appendLog(`solve ì‹¤íŒ¨: ${solveJson.error || "Unknown"}`);
          answersBox.textContent = "";
          captureBtn.disabled = false;
          return;
        }

        answersBox.textContent = solveJson.text || "";
        appendLog("STATUS: ì •ë‹µì„ ìƒì„±í–ˆì–´.");

        if (solveJson.debug && solveJson.debug.model) {
          modelInfo.textContent = solveJson.debug.model;
        }

        // ìë™ TTS í•œ ë²ˆ ì‹¤í–‰ (ì›í•˜ë©´)
        speakAnswers(solveJson.text || "");
      } catch (err) {
        console.error(err);
        appendLog(`ERROR: ë„¤íŠ¸ì›Œí¬ ë˜ëŠ” í•¨ìˆ˜ í˜¸ì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆì–´.`);
      } finally {
        captureBtn.disabled = false;
      }
    }

    function speakAnswers(rawText) {
      if (!("speechSynthesis" in window)) {
        appendLog("INFO: ë¸Œë¼ìš°ì €ê°€ TTSë¥¼ ì§€ì›í•˜ì§€ ì•Šì•„.");
        return;
      }
      window.speechSynthesis.cancel();

      const lines = (rawText || "")
        .split(/\r?\n/)
        .map(l => l.trim())
        .filter(Boolean);

      if (!lines.length) {
        appendLog("INFO: ì½ì„ ì •ë‹µì´ ì—†ì–´.");
        return;
      }

      const parts = [];
      for (const line of lines) {
        const m = line.match(/^(\d{1,3})\s*[:\-\.]?\s*([A-E])/i);
        if (!m) continue;
        const num = m[1];
        const letter = m[2].toUpperCase();
        parts.push(`${num}ë²ˆ ${letter}`);
      }
      if (!parts.length) {
        appendLog("INFO: ì •ë‹µ í¬ë§·ì„ ì¸ì‹í•˜ì§€ ëª»í•´ì„œ ì½ì§€ ëª»í–ˆì–´.");
        return;
      }

      const text = parts.join(", ");
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }

    // ë²„íŠ¼ ì´ë²¤íŠ¸
    captureBtn.addEventListener("click", captureAndSolve);
    stopCamBtn.addEventListener("click", stopCamera);
    startCamBtn.addEventListener("click", startCamera);
    speakBtn.addEventListener("click", () => {
      const txt = answersBox.textContent || "";
      speakAnswers(txt);
    });
    stopSpeakBtn.addEventListener("click", () => {
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    });

    // ì´ˆê¸° ì¹´ë©”ë¼ ì‹œì‘
    startCamera();
  </script>
</body>
</html>
