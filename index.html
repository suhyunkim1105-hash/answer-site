<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>편입 영어 자동 풀이 테스트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: #050816;
      color: #f5f5f5;
    }
    h1 {
      font-size: 18px;
      margin-bottom: 8px;
    }
    button {
      border: none;
      padding: 10px 12px;
      margin: 4px 4px 4px 0;
      border-radius: 18px;
      font-size: 14px;
      cursor: pointer;
    }
    button.primary {
      background: #00c2ff;
      color: #000;
      font-weight: 600;
    }
    button.secondary {
      background: #222;
      color: #f5f5f5;
    }
    button.danger {
      background: #ff3366;
      color: #fff;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    #camera {
      width: 100%;
      max-height: 320px;
      background: #000;
      border-radius: 8px;
      margin: 8px 0;
      object-fit: contain;
    }
    #status {
      margin-top: 6px;
      font-size: 13px;
      white-space: pre-line;
    }
    .panel {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      background: #111827;
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .panel h2 {
      margin: 0 0 6px;
      font-size: 13px;
      color: #93c5fd;
    }
    #logPanel {
      max-height: 200px;
      overflow-y: auto;
      font-family: SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 4px;
      margin-top: 4px;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #1f2937;
    }
  </style>
</head>
<body>
  <h1>성균관대 편입 영어 자동 풀이 (페이지 단위)</h1>

  <div class="row">
    <span class="pill">현재 페이지: <span id="pageLabel">1</span></span>
    <span class="pill">TTS: <span id="ttsLabel">ON</span></span>
  </div>

  <video id="camera" autoplay playsinline muted></video>
  <canvas id="captureCanvas" style="display:none;"></canvas>

  <div class="row">
    <button id="btnStartCam" class="primary">카메라 켜기</button>
    <button id="btnStopCam" class="secondary">카메라 끄기</button>
  </div>
  <div class="row">
    <button id="btnCaptureSolve" class="primary">이 페이지 촬영 + 풀기</button>
    <button id="btnNextPage" class="secondary">다음 페이지 번호로 이동</button>
    <button id="btnResetPage" class="secondary">페이지 1로 초기화</button>
  </div>
  <div class="row">
    <button id="btnToggleTts" class="secondary">음성 안내 켜기/끄기</button>
  </div>

  <div id="status"></div>

  <div id="answerPanel" class="panel" style="display:none;">
    <h2>이 페이지 정답 / 안내</h2>
    <pre id="answerText"></pre>
  </div>

  <div id="ocrPanel" class="panel" style="display:none;">
    <h2>OCR 결과 (일부)</h2>
    <pre id="ocrText"></pre>
  </div>

  <div id="logPanel" class="panel">
    <h2>디버그 로그</h2>
    <pre id="log"></pre>
  </div>

  <p style="margin-top:10px; font-size:11px; opacity:0.8;">
    * 음성 읽기(TTS)는 브라우저의 Web Speech API를 사용해. iOS Safari에서는 버튼을 한 번
    눌러야 동작할 수 있어. <br/>
    * 한 페이지씩 <strong>이 페이지 촬영 + 풀기</strong>를 누르고, XURTH가 들리면 그 페이지는 끝난 거야.
  </p>

  <script>
    const video = document.getElementById("camera");
    const canvas = document.getElementById("captureCanvas");
    const statusEl = document.getElementById("status");
    const answerPanel = document.getElementById("answerPanel");
    const answerTextEl = document.getElementById("answerText");
    const ocrPanel = document.getElementById("ocrPanel");
    const ocrTextEl = document.getElementById("ocrText");
    const logEl = document.getElementById("log");
    const pageLabel = document.getElementById("pageLabel");
    const ttsLabel = document.getElementById("ttsLabel");

    const btnStartCam = document.getElementById("btnStartCam");
    const btnStopCam = document.getElementById("btnStopCam");
    const btnCaptureSolve = document.getElementById("btnCaptureSolve");
    const btnNextPage = document.getElementById("btnNextPage");
    const btnResetPage = document.getElementById("btnResetPage");
    const btnToggleTts = document.getElementById("btnToggleTts");

    let currentStream = null;
    let currentPage = 1;
    let ttsEnabled = true;

    function log(msg, obj) {
      const time = new Date().toISOString().substring(11, 19);
      const line =
        "[" + time + "] " + msg + (obj ? " " + JSON.stringify(obj) : "");
      logEl.textContent += line + "\n";
      logEl.scrollTop = logEl.scrollHeight;
      console.log("[front]", line);
    }

    function setStatus(msg) {
      statusEl.textContent = msg;
      log("STATUS: " + msg);
    }

    function speak(text) {
      if (!ttsEnabled) return;
      if (!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    async function startCamera() {
      try {
        if (currentStream) return;
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: "environment" },
          audio: false
        });
        video.srcObject = currentStream;
        setStatus("카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.");
        speak("카메라를 켰어요. 시험지를 화면에 잘 맞춰 주세요.");
      } catch (e) {
        setStatus("카메라 켜기 실패: " + e.message);
        log("camera error", { error: String(e) });
      }
    }

    function stopCamera() {
      if (currentStream) {
        currentStream.getTracks().forEach((t) => t.stop());
        currentStream = null;
      }
      video.srcObject = null;
      setStatus("카메라를 끔.");
      speak("카메라를 껐어요.");
    }

    function updatePageLabel() {
      pageLabel.textContent = String(currentPage);
    }

    btnStartCam.addEventListener("click", startCamera);
    btnStopCam.addEventListener("click", stopCamera);

    btnNextPage.addEventListener("click", () => {
      currentPage += 1;
      updatePageLabel();
      setStatus(`페이지 ${currentPage}로 이동했어.`);
      speak(`페이지 ${currentPage}로 이동했습니다.`);
      answerPanel.style.display = "none";
    });

    btnResetPage.addEventListener("click", () => {
      currentPage = 1;
      updatePageLabel();
      setStatus("페이지를 1로 초기화했어.");
      speak("페이지를 일 번으로 초기화했습니다.");
      answerPanel.style.display = "none";
    });

    btnToggleTts.addEventListener("click", () => {
      ttsEnabled = !ttsEnabled;
      ttsLabel.textContent = ttsEnabled ? "ON" : "OFF";
      if (ttsEnabled) {
        speak("음성 안내를 켰습니다.");
      }
    });

    btnCaptureSolve.addEventListener("click", async () => {
      if (!currentStream) {
        await startCamera();
        if (!currentStream) return;
      }

      try {
        btnCaptureSolve.disabled = true;
        setStatus(
          `페이지 ${currentPage} 촬영 중... 시험지를 흔들리지 않게 잡고 있어줘.`
        );
        speak(`${currentPage} 페이지를 촬영합니다.`);

        // --- 1) 캔버스로 캡처 -----------------
        const trackSettings = currentStream
          .getVideoTracks()[0]
          .getSettings();
        const w = trackSettings.width || 1280;
        const h = trackSettings.height || 720;

        const targetWidth = 1280;
        const scale = targetWidth / w;
        const targetHeight = Math.round(h * scale);

        canvas.width = targetWidth;
        canvas.height = targetHeight;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, targetWidth, targetHeight);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.7);
        log("capture size", { width: targetWidth, height: targetHeight, length: dataUrl.length });

        // --- 2) OCR 호출 -----------------------
        setStatus("OCR 처리 중...");
        const ocrResp = await fetch("/.netlify/functions/ocr", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ image: dataUrl })
        });

        const ocrData = await ocrResp.json().catch(() => ({}));
        log("OCR response", ocrData);

        if (!ocrData.ok) {
          const msg =
            "OCR 실패: " + (ocrData.error || "알 수 없는 오류") +
            (ocrData.detail ? " / detail: " + JSON.stringify(ocrData.detail) : "");
          setStatus(msg);
          speak("문자를 제대로 읽지 못했어요. 시험지 위치와 조명을 다시 맞추고 한 번 더 찍어 주세요.");
          ocrPanel.style.display = "none";
          btnCaptureSolve.disabled = false;
          return;
        }

        const ocrText = String(ocrData.text || "");
        const conf = Number(ocrData.conf ?? 0);
        const hits = Number(ocrData.hits ?? 0);

        setStatus(
          `OCR 완료 (평균 신뢰도: ${conf.toFixed(
            1
          )}, 번호 패턴 수: ${hits}). 이제 정답을 생성할게.`
        );
        if (conf < 50 || hits < 5) {
          speak(
            "글자 인식이 조금 불안해요. 그래도 일단 정답을 만들어 볼게요. 혹시 이상한 번호가 나오면 다시 찍어 주세요."
          );
        } else {
          speak("글자 인식이 괜찮아요. 정답을 계산하겠습니다.");
        }

        // OCR 일부만 보여주기
        ocrPanel.style.display = "block";
        ocrTextEl.textContent = ocrText.slice(0, 600);

        // --- 3) solve 함수 호출 -----------------
        const solveResp = await fetch("/.netlify/functions/solve", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ page: currentPage, text: ocrText })
        });

        const solveData = await solveResp.json().catch(() => ({}));
        log("solve response", solveData);

        if (!solveData.ok) {
          const msg =
            "풀이 실패: " + (solveData.error || "알 수 없는 오류");
          setStatus(msg);
          speak(
            "정답 계산에서 오류가 났어요. 잠깐 있다가 다시 시도해 주세요."
          );
          btnCaptureSolve.disabled = false;
          return;
        }

        const finalText = String(solveData.text || "").trim();
        answerPanel.style.display = "block";
        answerTextEl.textContent = finalText;

        setStatus(`페이지 ${currentPage} 정답을 생성했어. XURTH가 들리면 이 페이지는 끝이야.`);
        speak(
          `페이지 ${currentPage} 정답을 읽어 드릴게요.`
        );
        // 정답 전체를 음성으로 읽어 줌
        speak(finalText.replace(/XURTH/gi, "익스 우어 쓰"));

      } catch (e) {
        log("capture+solve error", { error: String(e) });
        setStatus("예상치 못한 오류: " + e.message);
        speak("알 수 없는 오류가 발생했어요. 다시 한 번 시도해 주세요.");
      } finally {
        btnCaptureSolve.disabled = false;
      }
    });

    // 초기 상태
    updatePageLabel();
    setStatus("카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.");
  </script>
</body>
</html>
