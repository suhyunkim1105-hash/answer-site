<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ì—°ì„¸ëŒ€ ì‚¬íšŒë…¼ìˆ  ìë™ í’€ì´ (ì‹¤í—˜ìš©)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      color-scheme: dark;
    }
    body {
      margin: 0;
      padding: 12px;
      font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", system-ui, sans-serif;
      background: #0b0c10;
      color: #f5f5f5;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
    }
    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }
    small {
      color: #aaaaaa;
    }
    .section {
      margin-top: 16px;
      padding: 12px;
      border-radius: 10px;
      background: #12141c;
      border: 1px solid #222638;
    }
    #preview {
      width: 100%;
      max-height: 340px;
      background: #000;
      border-radius: 8px;
    }
    #captureCanvas {
      display: none;
    }
    .btn-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    button {
      flex: 1;
      padding: 10px 8px;
      font-size: 15px;
      border-radius: 999px;
      border: 1px solid #3b82f6;
      background: #1d2333;
      color: #e5efff;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    #resetBtn {
      flex: 0.6;
      border-color: #64748b;
      color: #d0d8e6;
    }
    #status {
      margin-top: 6px;
      font-size: 13px;
      min-height: 1.4em;
    }
    .status.error {
      color: #fecaca;
    }
    #thumbs {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    .thumb {
      width: 80px;
      height: auto;
      border-radius: 4px;
      border: 1px solid #374151;
      object-fit: cover;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      background: #020617;
      color: #e5e7eb;
      border-radius: 8px;
      border: 1px solid #1f2937;
      padding: 8px;
      font-size: 14px;
      line-height: 1.5;
      resize: vertical;
    }
    details {
      margin-top: 8px;
      font-size: 13px;
    }
    summary {
      cursor: pointer;
      color: #9ca3af;
    }
    .tts-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    #ttsPlayBtn {
      flex: 1;
      border-color: #22c55e;
      background: #14532d;
    }
    #ttsStopBtn {
      flex: 0.8;
      border-color: #dc2626;
      background: #450a0a;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ì—°ì„¸ëŒ€ ì‚¬íšŒë…¼ìˆ  ìë™ í’€ì´ (ì‹¤í—˜ìš©)</h1>
    <small>ì…”í„°Â·í’€ê¸° ë²„íŠ¼ë§Œ ì§ì ‘ ëˆ„ë¥´ê³ , ì´í›„ OCR â†’ í’€ì´ â†’ ì›ê³ ì§€ ëª¨ë“œ TTSëŠ” ìë™ìœ¼ë¡œ ëŒì•„ê°€ê²Œ ì„¤ê³„.</small>

    <!-- ì¹´ë©”ë¼ / ì´¬ì˜ ì˜ì—­ -->
    <section class="section">
      <h2 style="font-size:16px;margin:0 0 6px;">1. ì‹œí—˜ì§€ ì´¬ì˜</h2>
      <video id="preview" autoplay playsinline></video>
      <canvas id="captureCanvas"></canvas>

      <div class="btn-row">
        <button id="captureBtn">ğŸ“· ì´¬ì˜</button>
        <button id="solveBtn">ğŸ§  í’€ê¸°</button>
        <button id="resetBtn">â™» ì´ˆê¸°í™”</button>
      </div>

      <div id="status" class="status"></div>

      <div id="thumbs"></div>
    </section>

    <!-- AI ë‹µì•ˆ + ì›ê³ ì§€ ëª¨ë“œ TTS -->
    <section class="section">
      <h2 style="font-size:16px;margin:0 0 6px;">2. AI ë‹µì•ˆ + ì›ê³ ì§€ TTS</h2>
      <textarea id="answerOutput" rows="16" spellcheck="false" placeholder="[ë¬¸ì œ 1] / [ë¬¸ì œ 2] ë‹µì•ˆì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."></textarea>
      <div class="tts-row">
        <button id="ttsPlayBtn">ğŸ”Š ì›ê³ ì§€ TTS ì¬ìƒ</button>
        <button id="ttsStopBtn">â¹ TTS ì •ì§€</button>
      </div>
    </section>

    <!-- ë””ë²„ê·¸ìš© OCR í…ìŠ¤íŠ¸ -->
    <section class="section">
      <details>
        <summary>OCR í…ìŠ¤íŠ¸ í™•ì¸ (ë””ë²„ê·¸ìš©)</summary>
        <textarea id="ocrTextDebug" rows="10" spellcheck="false"></textarea>
      </details>
    </section>
  </div>

  <script>
    // ---- ì „ì—­ ìƒíƒœ ----
    const images = []; // { dataUrl, ocrText }
    const MIN_SOLVE_CHARS = 1200;  // ê³µë°± ì œê±° ê¸°ì¤€ ìµœì†Œ ê¸€ììˆ˜
    const MAX_PAGES = 10;
    let isSolving = false;
    let gridLoop = false;
    let currentStream = null;

    // DOM ìš”ì†Œ
    const video = document.getElementById("preview");
    const captureBtn = document.getElementById("captureBtn");
    const solveBtn = document.getElementById("solveBtn");
    const resetBtn = document.getElementById("resetBtn");
    const statusBox = document.getElementById("status");
    const thumbsBox = document.getElementById("thumbs");
    const ocrDebugBox = document.getElementById("ocrTextDebug");
    const answerBox = document.getElementById("answerOutput");
    const ttsPlayBtn = document.getElementById("ttsPlayBtn");
    const ttsStopBtn = document.getElementById("ttsStopBtn");

    function setStatus(msg, isError) {
      if (!statusBox) return;
      statusBox.textContent = msg;
      statusBox.className = isError ? "status error" : "status";
      console.log(msg);
    }

    function toggleButtons(disabled) {
      captureBtn.disabled = disabled;
      solveBtn.disabled = disabled;
      resetBtn.disabled = disabled;
    }

    // â˜… í•´ìƒë„ ì˜¬ë¦° ë²„ì „ (ì•„ì´í°ì—ì„œ ê¸€ì í¬ê²Œ ì°íˆë„ë¡)
    async function initCamera() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        setStatus("ì´ ë¸Œë¼ìš°ì €ëŠ” ì¹´ë©”ë¼ APIë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.", true);
        return;
      }
      try {
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false,
        });
        video.srcObject = currentStream;
        await video.play();
        setStatus("ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ. ì‹œí—˜ì§€ê°€ í™”ë©´ ëŒ€ë¶€ë¶„ì„ ì°¨ì§€í•˜ë„ë¡ ë§ì¶˜ ë’¤ ì´¬ì˜í•˜ì„¸ìš”.");
      } catch (err) {
        console.error(err);
        setStatus("ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + err.message, true);
      }
    }

    function capturePage() {
      if (!currentStream) {
        setStatus("ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.", true);
        return;
      }
      if (images.length >= MAX_PAGES) {
        setStatus("ìµœëŒ€ ì´¬ì˜ ì¥ìˆ˜(" + MAX_PAGES + "ì¥)ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.", true);
        return;
      }

      const canvas = document.getElementById("captureCanvas");
      const w = video.videoWidth;
      const h = video.videoHeight;
      if (!w || !h) {
        setStatus("ì˜ìƒ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. 1~2ì´ˆ í›„ ë‹¤ì‹œ ì´¬ì˜í•´ ì£¼ì„¸ìš”.", true);
        return;
      }

      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

      const pageIndex = images.length;
      images.push({ dataUrl, ocrText: null });

      const img = document.createElement("img");
      img.src = dataUrl;
      img.alt = "page " + (pageIndex + 1);
      img.className = "thumb";
      thumbsBox.appendChild(img);

      setStatus("í˜ì´ì§€ " + (pageIndex + 1) + " ì´¬ì˜ ì™„ë£Œ (ì´ " + images.length + "ì¥).");
    }

    async function runOcrForImage(imageDataUrl, pageNo) {
      try {
        const resp = await fetch("/.netlify/functions/ocr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageDataUrl, language: "kor" }),
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || !data.ok) {
          const msg = data && data.error ? data.error : "HTTP " + resp.status;
          speakShort("í˜ì´ì§€ " + pageNo + " OCRì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°ì–´ ì£¼ì„¸ìš”.");
          throw new Error("í˜ì´ì§€ " + pageNo + " OCR ì‹¤íŒ¨: " + msg);
        }

        const text = data.text || "";
        if (!text.trim()) {
          speakShort("í˜ì´ì§€ " + pageNo + " OCR ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°ì–´ ì£¼ì„¸ìš”.");
          throw new Error("í˜ì´ì§€ " + pageNo + " OCR ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŒ");
        }
        return text;
      } catch (err) {
        speakShort("í˜ì´ì§€ " + pageNo + " OCRì— ì˜¤ë¥˜ê°€ ë‚¬ìŠµë‹ˆë‹¤.");
        throw err;
      }
    }

    async function callSolve(text) {
      const resp = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, force: false, prefix: "" }),
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        const msg =
          data && (data.error || data.detail)
            ? data.error || data.detail
            : "HTTP " + resp.status;
        throw new Error("solve í•¨ìˆ˜ ì—ëŸ¬: " + msg);
      }
      return data.answer || "";
    }

    function updateOcrDebug(text) {
      if (ocrDebugBox) {
        ocrDebugBox.value = text;
      }
    }

    function resetAll() {
      images.length = 0;
      thumbsBox.innerHTML = "";
      if (ocrDebugBox) ocrDebugBox.value = "";
      if (answerBox) answerBox.value = "";
      stopGridSpeech();
      setStatus("ì´ˆê¸°í™” ì™„ë£Œ. ë‹¤ì‹œ ì´¬ì˜ì„ ì‹œì‘í•˜ì„¸ìš”.");
    }

    async function solveAll() {
      if (isSolving) return;
      if (!images.length) {
        setStatus("ë¨¼ì € ì‹œí—˜ì§€ í˜ì´ì§€ë¥¼ ì´¬ì˜í•´ ì£¼ì„¸ìš”.", true);
        speakShort("ë¨¼ì € ì‹œí—˜ì§€ë¥¼ ì°ì–´ ì£¼ì„¸ìš”.");
        return;
      }

      isSolving = true;
      toggleButtons(true);
      stopGridSpeech();

      try {
        let combined = "";

        for (let i = 0; i < images.length; i++) {
          const pageNo = i + 1;
          if (!images[i].ocrText) {
            setStatus("í˜ì´ì§€ " + pageNo + " OCR ì²˜ë¦¬ ì¤‘...");
            const text = await runOcrForImage(images[i].dataUrl, pageNo);
            images[i].ocrText = text;
          }
          combined += "\n\n[í˜ì´ì§€ " + pageNo + "]\n" + (images[i].ocrText || "");
        }

        const compact = combined.replace(/\s+/g, "");
        if (compact.length < MIN_SOLVE_CHARS) {
          setStatus(
            "ì œì‹œë¬¸ í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ìŠµë‹ˆë‹¤(ê³µë°± ì œê±° ê¸°ì¤€ " +
              compact.length +
              "ì). ë” ë§ì€ í˜ì´ì§€ë¥¼ ì°ê±°ë‚˜, ì¹´ë©”ë¼ë¥¼ ë” ê°€ê¹ê²Œ í•´ì„œ ë‹¤ì‹œ ì´¬ì˜í•´ ì£¼ì„¸ìš”.",
            true
          );
          speakShort("í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì ì–´ì„œ í’€ì´ë¥¼ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì°ì–´ ì£¼ì„¸ìš”.");
          return;
        }

        setStatus("AIê°€ ë‹µì•ˆì„ ì‘ì„± ì¤‘ì…ë‹ˆë‹¤...");
        const answer = await callSolve(combined);
        if (answerBox) answerBox.value = answer;
        updateOcrDebug(combined);

        setStatus("ë‹µì•ˆ ìƒì„± ì™„ë£Œ. ì›ê³ ì§€ ëª¨ë“œ TTSë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.");
        speakGridLoop(answer);
      } catch (err) {
        console.error(err);
        setStatus("í’€ì´ ì¤‘ ì˜¤ë¥˜: " + err.message, true);
        speakShort("í’€ì´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      } finally {
        isSolving = false;
        toggleButtons(false);
      }
    }

    function speakShort(message) {
      if (!("speechSynthesis" in window)) {
        return;
      }
      const u = new SpeechSynthesisUtterance(message);
      u.lang = "ko-KR";
      u.rate = 1.0;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // ì›ê³ ì§€ ëª¨ë“œìš©: ë„ì–´ì“°ê¸°/ë¬¸ì¥ë¶€í˜¸ë¥¼ ê·¸ëŒ€ë¡œ ì½ì–´ ì£¼ê¸°
    function toGridSpeech(text) {
      let t = text.trim();
      t = t
        .replace(/\./g, " ì˜¨ì  ")
        .replace(/,/g, " ì‰¼í‘œ ")
        .replace(/\?/g, " ë¬¼ìŒí‘œ ")
        .replace(/!/g, " ëŠë‚Œí‘œ ");
      // ê³µë°±ì€ ëª¨ë‘ "ë„ìš°ê³ "ë¡œ ì¹˜í™˜
      t = t.replace(/\s+/g, " ë„ìš°ê³  ");
      return t;
    }

    function speakGridLoop(text) {
      if (!("speechSynthesis" in window)) {
        return;
      }
      const spoken = toGridSpeech(text);
      gridLoop = true;

      const makeUtterance = () => {
        const u = new SpeechSynthesisUtterance(spoken);
        u.lang = "ko-KR";
        u.rate = 0.6; // ëŠë¦¬ê²Œ
        u.onend = function () {
          if (gridLoop) {
            window.speechSynthesis.speak(makeUtterance());
          }
        };
        return u;
      };

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(makeUtterance());
    }

    function stopGridSpeech() {
      gridLoop = false;
      if ("speechSynthesis" in window) {
        window.speechSynthesis.cancel();
      }
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    captureBtn.addEventListener("click", capturePage);
    solveBtn.addEventListener("click", solveAll);
    resetBtn.addEventListener("click", resetAll);
    ttsPlayBtn.addEventListener("click", function () {
      if (!answerBox || !answerBox.value.trim()) return;
      speakGridLoop(answerBox.value);
    });
    ttsStopBtn.addEventListener("click", stopGridSpeech);

    window.addEventListener("load", initCamera);
  </script>
</body>
</html>
