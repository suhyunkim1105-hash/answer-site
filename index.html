<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site 카메라 + OCR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      padding: 16px;
      margin: 0;
      background: #111;
      color: #eee;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    p {
      font-size: 0.9rem;
      color: #bbb;
    }
    .section {
      margin-top: 16px;
    }
    video, img {
      width: 100%;
      max-width: 480px;
      background: #000;
      border-radius: 10px;
      display: block;
    }
    .buttons {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      flex: 1;
      min-width: 120px;
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      background: #2a2a2a;
      color: #fff;
    }
    button:active {
      opacity: 0.8;
    }
    #status {
      margin-top: 6px;
      font-size: 0.8rem;
      color: #aaa;
    }
    .zoom-wrapper {
      margin-top: 8px;
    }
    .zoom-wrapper label {
      font-size: 0.85rem;
      color: #ccc;
      display: block;
      margin-bottom: 4px;
    }
    input[type="range"] {
      width: 100%;
    }
    textarea {
      width: 100%;
      max-width: 480px;
      border-radius: 8px;
      border: 1px solid #444;
      background: #181818;
      color: #eee;
      padding: 8px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <h1>카메라 + OCR 테스트</h1>
  <p>카메라로 문제를 비추고, 캡처 + OCR 버튼을 누르면 영어 텍스트로 인식한다.</p>

  <!-- 카메라 프리뷰 -->
  <div class="section">
    <h2 style="font-size:1.1rem;">카메라 화면</h2>
    <video id="camera" autoplay playsinline muted></video>

    <div class="buttons">
      <button id="startBtn">카메라 켜기</button>
      <button id="captureBtn">지금 화면 캡처</button>
      <button id="captureOcrBtn">캡처 + OCR</button>
    </div>

    <!-- 줌 슬라이더 -->
    <div class="zoom-wrapper" id="zoomWrapper" style="display:none;">
      <label for="zoomRange">
        줌(배율) 조절: <span id="zoomValue"></span>
      </label>
      <input type="range" id="zoomRange" />
    </div>

    <div id="status"></div>
  </div>

  <!-- 캡처된 이미지 -->
  <div class="section">
    <h2 style="font-size:1.1rem;">캡처된 이미지</h2>
    <img id="capturedImage" alt="캡처된 화면" />
  </div>

  <!-- 인식된 텍스트 -->
  <div class="section">
    <h2 style="font-size:1.1rem;">인식된 텍스트 (OCR 결과)</h2>
    <textarea id="questionText" rows="8"
      placeholder="캡처 + OCR 버튼을 누르면 여기에 텍스트가 표시됩니다."></textarea>
  </div>

  <!-- 캔버스 (숨김) -->
  <canvas id="canvas" style="display:none;"></canvas>

  <!-- Tesseract.js (브라우저 OCR 라이브러리) -->
  <script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

  <script>
    const video = document.getElementById('camera');
    const startBtn = document.getElementById('startBtn');
    const captureBtn = document.getElementById('captureBtn');
    const captureOcrBtn = document.getElementById('captureOcrBtn');
    const canvas = document.getElementById('canvas');
    const capturedImage = document.getElementById('capturedImage');
    const statusEl = document.getElementById('status');

    const zoomWrapper = document.getElementById('zoomWrapper');
    const zoomRange = document.getElementById('zoomRange');
    const zoomValue = document.getElementById('zoomValue');
    const questionTextEl = document.getElementById('questionText');

    let stream = null;
    let videoTrack = null;
    let zoomCap = null;

    // 1) 카메라 켜기 (후면 + 고해상도 요청)
    async function startCamera() {
      try {
        if (stream) {
          statusEl.textContent = '이미 카메라가 켜져 있습니다.';
          return;
        }

        statusEl.textContent = '카메라 요청 중...';

        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: 'environment' },
            width: { ideal: 1920 },
            height: { ideal: 1080 },
          },
          audio: false,
        });

        video.srcObject = stream;

        video.addEventListener(
          'loadedmetadata',
          () => {
            statusEl.textContent =
              '실제 영상 해상도: ' +
              video.videoWidth + ' x ' + video.videoHeight;
            console.log('실제 영상 해상도:', video.videoWidth, video.videoHeight);
          },
          { once: true }
        );

        // 줌 지원 여부 검사
        videoTrack = stream.getVideoTracks()[0];
        const capabilities = videoTrack.getCapabilities
          ? videoTrack.getCapabilities()
          : {};

        if (capabilities.zoom) {
          zoomCap = capabilities.zoom;
          const settings = videoTrack.getSettings();

          zoomRange.min = zoomCap.min;
          zoomRange.max = zoomCap.max;
          zoomRange.step = zoomCap.step || 0.1;
          zoomRange.value = settings.zoom || zoomCap.min;

          zoomValue.textContent = parseFloat(zoomRange.value).toFixed(2) + 'x';

          zoomWrapper.style.display = 'block';
          statusEl.textContent += ' / 줌 지원됨';
        } else {
          zoomWrapper.style.display = 'none';
          statusEl.textContent += ' / 이 기기에서는 카메라 줌 미지원';
        }
      } catch (err) {
        console.error(err);
        alert('카메라를 불러올 수 없습니다. 브라우저 권한/설정을 확인하세요.');
        statusEl.textContent = '카메라 오류: ' + err.message;
      }
    }

    // 2) 줌 슬라이더 변경 시 카메라 줌 변경
    async function onZoomChange(e) {
      if (!videoTrack || !zoomCap) return;

      const value = parseFloat(e.target.value);
      zoomValue.textContent = value.toFixed(2) + 'x';

      try {
        await videoTrack.applyConstraints({
          advanced: [{ zoom: value }],
        });
      } catch (err) {
        console.error('줌 적용 오류:', err);
        statusEl.textContent = '줌 적용 중 오류 발생';
      }
    }

    // 공통: 현재 프레임을 캔버스/이미지로 캡처
    function captureToCanvasAndImage() {
      if (!video.videoWidth || !video.videoHeight) {
        alert('카메라가 아직 준비되지 않았습니다. 1~2초 뒤 다시 눌러보세요.');
        return false;
      }

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const dataUrl = canvas.toDataURL('image/png');
      capturedImage.src = dataUrl;

      return true;
    }

    // 3) 단순 캡처만
    function captureFrame() {
      const ok = captureToCanvasAndImage();
      if (!ok) return;
      statusEl.textContent = '프레임 캡처 완료.';
    }

    // 4) 캡처 + OCR
    async function captureAndOcr() {
      const ok = captureToCanvasAndImage();
      if (!ok) return;

      statusEl.textContent = 'OCR 처리 중... (조금 걸릴 수 있음)';
      questionTextEl.value = '';

      try {
        const result = await Tesseract.recognize(canvas, 'eng', {
          logger: (m) => console.log(m), // 진행상황 콘솔 출력
        });

        const text = (result.data.text || '').trim();
        questionTextEl.value = text;
        statusEl.textContent = 'OCR 완료.';
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'OCR 중 오류 발생';
        alert('OCR 중 오류가 발생했습니다.');
      }
    }

    startBtn.addEventListener('click', startCamera);
    captureBtn.addEventListener('click', captureFrame);
    captureOcrBtn.addEventListener('click', captureAndOcr);
    zoomRange.addEventListener('input', onZoomChange);
  </script>
</body>
</html>
