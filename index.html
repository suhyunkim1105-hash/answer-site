<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Answer Site</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { max-width: 820px; margin: 32px auto; padding: 0 16px; }
    textarea { width: 100%; min-height: 120px; padding: 12px; font-size: 16px; }
    button { padding: 10px 16px; font-size: 16px; cursor: pointer; }
    .row { display: flex; gap: 10px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .out { white-space: pre-wrap; background: #f6f7f8; padding: 12px; border-radius: 8px; min-height: 48px; }
    .muted { color: #666; font-size: 14px; }
    .error { color: #b00020; }
    .cam-wrap { position: relative; display: inline-block; max-width: 100%; }
    #preview { max-width: 100%; border-radius: 8px; display: none; }
    #roiCanvas {
      position: absolute; inset: 0; display: none;
      touch-action: none;
    }
    .hint { font-size: 13px; color:#555; }
  </style>
</head>
<body>
  <h1>정답 풀이 테스트</h1>
  <textarea id="q" placeholder="OCR 또는 직접 입력..."></textarea>
  <div class="row">
    <button id="send">보내기</button>
    <span id="status" class="muted"></span>
  </div>

  <h3>결과</h3>
  <div id="out" class="out"></div>

  <hr>
  <h3>카메라 · OCR · 음성</h3>
  <div class="row">
    <button id="camStart">카메라 켜기</button>
    <button id="camShot" disabled>캡처 → OCR</button>
    <button id="camStop" disabled>카메라 끄기</button>
    <button id="speak" disabled>정답 읽기(TTS)</button>
    <span id="ocrStatus" class="muted"></span>
  </div>

  <label><input type="checkbox" id="autoMode"> 자동 모드</label>
  <span id="autoStatus" class="muted"></span>
  <span id="autoDebug" class="muted"></span>

  <div class="cam-wrap">
    <video id="preview" autoplay playsinline></video>
    <canvas id="roiCanvas"></canvas>
  </div>
  <canvas id="frame" style="display:none"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const $q=document.getElementById('q'), $btn=document.getElementById('send'),
          $out=document.getElementById('out'), $status=document.getElementById('status');
    const $video=document.getElementById('preview'), $canvas=document.getElementById('frame'),
          $roiCanvas=document.getElementById('roiCanvas'), $camStart=document.getElementById('camStart'),
          $camShot=document.getElementById('camShot'), $camStop=document.getElementById('camStop'),
          $speak=document.getElementById('speak'), $ocrStatus=document.getElementById('ocrStatus');
    const $auto=document.getElementById('autoMode'), $autoStatus=document.getElementById('autoStatus'),
          $autoDebug=document.getElementById('autoDebug');

    let stream, roi=null;

    async function ask(){
      const question=($q.value||'').trim(); if(!question){$out.textContent='';$status.textContent='질문 없음';return;}
      $status.textContent='요청 중...'; $btn.disabled=true;
      try{
        const res=await fetch('/.netlify/functions/solve',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question})});
        const data=await res.json(); $out.textContent=data.answer||JSON.stringify(data,null,2);
        $status.textContent='완료';
      }catch(e){$status.textContent='에러:'+e;}finally{$btn.disabled=false;}
    }
    $btn.onclick=ask;

    async function startCamera(){
      try{
        stream=await navigator.mediaDevices.getUserMedia({video:true,audio:false});
        $video.srcObject=stream; $video.style.display='block'; await $video.play();
        $camShot.disabled=false; $camStop.disabled=false; $ocrStatus.textContent='카메라 ON';
        if($auto.checked) startAuto();
      }catch(e){$ocrStatus.textContent='카메라 실패:'+e.message;}
    }
    function stopCamera(){if(stream){stream.getTracks().forEach(t=>t.stop());} $video.srcObject=null;$video.style.display='none';$ocrStatus.textContent='OFF';stopAuto();}

    async function captureAndOCR(){
      const vw=$video.videoWidth,vh=$video.videoHeight;
      $canvas.width=vw;$canvas.height=vh;$canvas.getContext('2d').drawImage($video,0,0,vw,vh);
      $ocrStatus.textContent='OCR 중...';
      try{
        const {data}=await Tesseract.recognize($canvas,'kor+eng');
        let text=(data.text||'').trim();
        text=text.replace(/_{2,}/g,'[빈칸]').replace(/(\b[A-C]\b|\([A-C]\)|[①②③④⑤])/g,'[$1]');
        $q.value=text; $ocrStatus.textContent='OCR 완료 ✅';
      }catch(e){$ocrStatus.textContent='OCR 오류:'+e.message;}
    }

    function speakResult(){const t=$out.textContent.trim();if(!t)return;const u=new SpeechSynthesisUtterance(t);u.lang='ko-KR';speechSynthesis.speak(u);}
    $camStart.onclick=startCamera; $camStop.onclick=stopCamera; $camShot.onclick=captureAndOCR; $speak.onclick=speakResult;

    // ===== 자동 모드 (민감도 낮춤) =====
    let autoLoop,lastImageData,stableSince=0,cooldownUntil=0;
    let DIFF_THRESHOLD=0.35, CHECK_INTERVAL=1000, STABLE_MS=1500, COOLDOWN_MS=4000;
    const diffCanvas=document.createElement('canvas'), diffCtx=diffCanvas.getContext('2d');

    function frameDiffRatio(){
      const w=320,h=240; diffCanvas.width=w;diffCanvas.height=h; diffCtx.drawImage($video,0,0,w,h);
      const cur=diffCtx.getImageData(0,0,w,h).data; if(!lastImageData){lastImageData=cur;return 1;}
      let diff=0,total=w*h;
      for(let i=0;i<cur.length;i+=4){if(Math.abs(cur[i]-lastImageData[i])+Math.abs(cur[i+1]-lastImageData[i+1])+Math.abs(cur[i+2]-lastImageData[i+2])>100) diff++;}
      lastImageData=cur; return diff/total;
    }

    async function captureOCRAndAsk(){await captureAndOCR();if($q.value.trim())await ask();speakResult();}

    function startAuto(){
      if(!$video.srcObject){$ocrStatus.textContent='카메라 먼저 켜세요';$auto.checked=false;return;}
      autoLoop=setInterval(async()=>{
        const now=Date.now(), ratio=frameDiffRatio();
        if(now<cooldownUntil)return;
        if(ratio<DIFF_THRESHOLD){
          if(!stableSince) stableSince=now;
          if(now-stableSince>=STABLE_MS){$ocrStatus.textContent='자동 캡처 실행';cooldownUntil=now+COOLDOWN_MS;stableSince=0;await captureOCRAndAsk();}
          else{$ocrStatus.textContent=`안정중 ${(STABLE_MS-(now-stableSince))/1000}s`;}
        }else{stableSince=0;$ocrStatus.textContent='움직임 감지';}
        $autoDebug.textContent=`변화율:${ratio.toFixed(3)} 임계:${DIFF_THRESHOLD}`;
      },CHECK_INTERVAL);
      $autoStatus.textContent='자동 모드 ON';
    }
    function stopAuto(){clearInterval(autoLoop);autoLoop=null;$autoStatus.textContent='자동 모드 OFF';}
    $auto.onchange=()=>{$auto.checked?startAuto():stopAuto();}
  </script>
</body>
</html>
