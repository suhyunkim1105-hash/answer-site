<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>answer-site-p2p • OCR→solve→TTS 데모</title>
  <style>
    :root { --bg:#0b0b10; --card:#141420; --muted:#8b8ba7; --fg:#e7e7ff; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, Helvetica, Arial, Apple SD Gothic Neo, "Apple Color Emoji", "Segoe UI Emoji"; background:var(--bg); color:var(--fg); }
    .wrap { max-width: 980px; margin: 24px auto; padding: 16px; }
    .card { background: var(--card); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    h1 { font-size: 22px; margin: 0 0 6px; }
    p.hint { color: var(--muted); margin: 0 0 16px; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    video, canvas, img { width: 100%; border-radius: 14px; background:#000; }
    textarea { width:100%; min-height: 110px; border-radius: 12px; border:1px solid #2a2a3f; background:#0e0e17; color:var(--fg); padding:12px; }
    button { appearance:none; border:0; padding:12px 14px; border-radius: 12px; font-weight: 700; cursor: pointer; background:#3a3aff; color:white; }
    button.secondary { background:#2a2a3f; color:#e6e6ff; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .small { font-size: 12px; color: var(--muted); }
    .pill { display:inline-flex; align-items:center; gap:6px; background:#1a1a2a; border:1px solid #2a2a3f; color:#bdbdf2; padding:6px 10px; border-radius:999px; }
    .status { min-height: 20px; }
    .kbar { display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:start; }
    .out { background:#0e0e17; border:1px solid #2a2a3f; padding:12px; border-radius:12px; min-height:52px; font-size:14px; }
    .muted { color:#b2b2d6; }
  </style>
  <!-- Tesseract.js CDN (worker will fetch core from CDN). If blocked, replace with local copy. -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>OCR → solve → TTS</h1>
      <p class="hint">카메라 영상을 캡처해 OCR로 텍스트를 추출하고, <span class="mono">solve</span> API에 전송해 받은 <b>정답만</b> 음성으로 읽어준다.</p>

      <div class="grid">
        <div>
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <span class="pill">① 카메라</span>
            <div class="row">
              <button id="btnStartCam">카메라 시작</button>
              <button id="btnSnap" class="secondary">프레임 캡처</button>
            </div>
          </div>
          <video id="video" playsinline autoplay muted></video>
          <canvas id="frame" style="display:none"></canvas>
          <p class="small">※ 특정 앱(예: 전용 카메라 앱)의 스트림을 직접 받기 어렵다면, 화면공유(스크린 캡처)로도 대체 가능: <code>navigator.mediaDevices.getDisplayMedia()</code> 사용.</p>
        </div>
        <div>
          <div class="row" style="justify-content:space-between; margin-bottom:8px;">
            <span class="pill">② OCR 결과</span>
            <button id="btnOcr">OCR 실행</button>
          </div>
          <textarea id="ocrText" placeholder="여기에 OCR 텍스트가 나타난다. 필요시 수정해서 보낼 수 있다."></textarea>
          <div class="row" style="justify-content:space-between; margin-top:8px;">
            <span class="pill">③ solve 호출</span>
            <div class="row">
              <input id="apiUrl" class="mono" style="width:360px; padding:10px; border-radius:10px; border:1px solid #2a2a3f; background:#0e0e17; color:#cfcfff;" value="https://solve-bcpgmrhjuq-uc.a.run.app" />
              <button id="btnAsk">정답 요청</button>
            </div>
          </div>
          <div id="answer" class="out" style="margin-top:8px;"></div>
          <div class="row" style="margin-top:8px; justify-content:space-between;">
            <span class="pill">④ 음성 출력 (TTS)</span>
            <div class="row">
              <button id="btnSpeak">답 말하기</button>
              <button id="btnStopSpeak" class="secondary">정지</button>
            </div>
          </div>
          <p class="small muted">Web Speech API(브라우저 TTS)를 사용. 모바일 브라우저는 사용자 제스처 이후에만 재생 허용될 수 있음.</p>
        </div>
      </div>

      <div class="card" style="margin-top:14px;">
        <div class="kbar">
          <div>
            <div class="status" id="status"></div>
            <p class="small">TIP: OCR 정확도 향상 — (1) 해상도 높이기, (2) 명암 대비/초점, (3) 프레임 중앙에 문제 텍스트만, (4) 잡음·왜곡 최소화.</p>
          </div>
          <button id="btnShareScreen" class="secondary">화면공유로 대체</button>
          <button id="btnClear" class="secondary">초기화</button>
        </div>
      </div>

      <p class="small">보안: 이 페이지는 <b>백엔드 비밀키를 사용하지 않는다.</b> solve API만 호출한다. solve 서버에서만 OpenRouter 키를 사용하도록 유지.</p>
    </div>
  </div>

<script>
const $ = (s)=>document.querySelector(s);
const video = $('#video');
const canvas = $('#frame');
const ctx = canvas.getContext('2d');
const statusEl = $('#status');
const ocrText = $('#ocrText');
const answerEl = $('#answer');
const apiUrl = $('#apiUrl');
let stream;
let lastAnswer = '';

function setStatus(msg){ statusEl.textContent = msg; }

async function startCamera(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio:false });
    video.srcObject = stream;
    setStatus('카메라 시작됨');
  } catch(e){ setStatus('카메라 접근 실패: '+ e.message); }
}

function snapFrame(){
  if(!video.videoWidth){ setStatus('비디오 로딩 대기…'); return; }
  const w = video.videoWidth; const h = video.videoHeight;
  canvas.width = w; canvas.height = h;
  ctx.drawImage(video, 0, 0, w, h);
  setStatus('프레임 캡처 완료');
}

async function doOCR(){
  try {
    setStatus('OCR 실행 중…');
    const img = canvas.toDataURL('image/png');
    const result = await Tesseract.recognize(img, 'eng+kor', { logger: m => { /* console.log(m) */ } });
    const text = (result.data && result.data.text) ? result.data.text.trim() : '';
    ocrText.value = text;
    setStatus('OCR 완료');
  } catch(e){ setStatus('OCR 실패: '+ e.message); }
}

async function askSolve(){
  const q = ocrText.value.trim();
  if(!q){ setStatus('질문 텍스트가 비어 있음'); return; }
  const url = apiUrl.value.trim();
  if(!url){ setStatus('solve API URL이 비어 있음'); return; }
  try {
    setStatus('solve 호출 중…');
    const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ question: q }) });
    if(!res.ok){ throw new Error('HTTP '+res.status); }
    const data = await res.json();
    const ans = (data && (data.answer || data.result || data.output)) || JSON.stringify(data);
    lastAnswer = String(ans).trim();
    answerEl.textContent = lastAnswer;
    setStatus('정답 수신');
  } catch(e){ setStatus('solve 호출 실패: '+ e.message); }
}

function speak(){
  const text = (answerEl.textContent || lastAnswer || '').trim();
  if(!text){ setStatus('읽을 답이 없음'); return; }
  const u = new SpeechSynthesisUtterance(text);
  // 한국어/영어 섞일 수 있으므로 기본 보이스 사용
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function stopSpeak(){ window.speechSynthesis.cancel(); }

async function shareScreen(){
  try{
    stream = await navigator.mediaDevices.getDisplayMedia({ video:true, audio:false });
    video.srcObject = stream;
    setStatus('화면공유 시작됨 (앱 영상 창을 선택)');
  }catch(e){ setStatus('화면공유 실패: '+ e.message); }
}

function clearAll(){
  ocrText.value = ''; answerEl.textContent = ''; lastAnswer=''; setStatus('초기화 완료');
}

$('#btnStartCam').addEventListener('click', startCamera);
$('#btnSnap').addEventListener('click', snapFrame);
$('#btnOcr').addEventListener('click', doOCR);
$('#btnAsk').addEventListener('click', askSolve);
$('#btnSpeak').addEventListener('click', speak);
$('#btnStopSpeak').addEventListener('click', stopSpeak);
$('#btnShareScreen').addEventListener('click', shareScreen);
$('#btnClear').addEventListener('click', clearAll);
</script>
</body>
</html>
