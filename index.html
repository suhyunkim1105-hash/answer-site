<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site 카메라</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #050505;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .wrap {
      max-width: 600px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    h1 {
      font-size: 1.1rem;
      margin: 0 0 4px;
      font-weight: 600;
    }
    video {
      width: 100%;
      border-radius: 12px;
      background: #000;
      transform-origin: center center;
    }
    .row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
    }
    .row label {
      white-space: nowrap;
    }
    input[type="range"] {
      flex: 1;
    }
    button {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #2b2b2b;
      color: #fff;
      font-size: 0.85rem;
      cursor: pointer;
    }
    button:active {
      opacity: 0.85;
    }
    #status {
      font-size: 0.78rem;
      color: #c0c0c0;
      min-height: 1.2em;
      white-space: pre-line;
    }
    #passagePreview {
      font-size: 0.78rem;
      color: #a0a0a0;
      max-height: 4.5em;
      overflow: hidden;
      border-radius: 8px;
      padding: 6px;
      background: #141414;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>answer-site 카메라</h1>

    <video id="video" playsinline autoplay muted></video>
    <canvas id="captureCanvas" style="display:none"></canvas>

    <div class="row">
      <button id="startBtn">카메라 켜기</button>
    </div>

    <div class="row">
      <label for="zoomRange">줌</label>
      <input id="zoomRange" type="range" min="1" max="3" step="0.05" value="1" />
    </div>

    <div id="status"></div>
    <div id="passagePreview"></div>
  </div>

  <!-- Tesseract.js: OCR (영어+한국어) -->
  <script src="https://unpkg.com/tesseract.js@5.0.4/dist/tesseract.min.js"></script>

  <!-- Firebase + 원격 캡처 + OCR + AI 풀이 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ==== Firebase config (네 프로젝트 값) ====
    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const ROOM_ID = "room1";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const commandRef = ref(db, `rooms/${ROOM_ID}/command`);
    const resultRef  = ref(db, `rooms/${ROOM_ID}/result`);

    const video = document.getElementById("video");
    const canvas = document.getElementById("captureCanvas");
    const startBtn = document.getElementById("startBtn");
    const zoomRange = document.getElementById("zoomRange");
    const statusEl = document.getElementById("status");
    const passagePreviewEl = document.getElementById("passagePreview");

    let stream = null;
    let videoTrack = null;
    let remoteProcessing = false;
    let lastRemoteRequestId = null;
    let currentPassage = "";
    let currentPassageSnippet = "";
    const OCR_LANG = "eng+kor";

    // ===== 카메라 켜기 & 고해상도 =====
    async function startCamera() {
      try {
        if (stream) return;
        statusEl.textContent = "카메라 여는 중…";

        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: { ideal: "environment" },
            width:  { ideal: 1920 },
            height: { ideal: 1080 }
          },
          audio: false
        });

        video.srcObject = stream;
        await video.play();

        videoTrack = stream.getVideoTracks()[0];
        setupZoomControl();
        statusEl.textContent = "카메라 준비 완료.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "카메라 시작 오류: " + err.message;
        alert("카메라를 열 수 없습니다: " + err.message);
      }
    }

    startBtn.addEventListener("click", startCamera);

    // ===== 줌 컨트롤 =====
    function setupZoomControl() {
      if (!videoTrack) {
        zoomRange.disabled = true;
        return;
      }

      const caps = videoTrack.getCapabilities ? videoTrack.getCapabilities() : {};
      if (caps.zoom) {
        // 네이티브 줌 지원
        zoomRange.min = caps.zoom.min;
        zoomRange.max = caps.zoom.max;
        zoomRange.step = caps.zoom.step || 0.1;
        zoomRange.value = caps.zoom.min;

        zoomRange.oninput = async () => {
          const z = Number(zoomRange.value);
          try {
            await videoTrack.applyConstraints({ advanced: [{ zoom: z }] });
          } catch (e) {
            console.warn("zoom applyConstraints 실패", e);
          }
        };
      } else {
        // CSS 스케일 줌 (디지털 줌 느낌)
        zoomRange.min = 1;
        zoomRange.max = 3;
        zoomRange.step = 0.05;
        zoomRange.value = 1;
        video.style.transformOrigin = "center center";

        zoomRange.oninput = () => {
          const z = Number(zoomRange.value);
          video.style.transform = `scale(${z})`;
        };
      }
    }

    // ===== 프레임 캡처 (최대 해상도) =====
    async function captureFrame() {
      if (!video.videoWidth || !video.videoHeight) {
        await new Promise(r => setTimeout(r, 100));
      }
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, w, h);
      return canvas.toDataURL("image/jpeg", 0.9);
    }

    // ===== OCR (영어+한국어) =====
    async function runOcr(dataUrl) {
      statusEl.textContent = "텍스트 인식 중…(eng+kor)";
      const { data } = await Tesseract.recognize(dataUrl, OCR_LANG);
      const rawText = (data.text || "").trim();
      s
