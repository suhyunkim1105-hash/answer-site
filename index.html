<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>편입 영어 자동 채점 · answer-site</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    header {
      padding: 12px 16px;
      border-bottom: 1px solid #1f2937;
      background: #020617;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    header p {
      margin: 4px 0 0;
      font-size: 12px;
      color: #9ca3af;
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
    }
    .top-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .left, .right {
      background: #020617;
      border-radius: 8px;
      padding: 10px;
      border: 1px solid #1e293b;
    }
    .left {
      flex: 1 1 260px;
      min-width: 260px;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .right {
      flex: 2 1 340px;
      min-width: 340px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    video {
      width: 100%;
      max-height: 60vh;
      background: #020617;
      border-radius: 8px;
      border: 1px solid #1f2937;
      object-fit: contain;
    }
    canvas {
      display: none;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: #111827;
      color: #e5e7eb;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    button.primary {
      border-color: #2563eb;
      background: #1d4ed8;
    }
    label {
      font-size: 12px;
      color: #9ca3af;
    }
    input[type="number"] {
      width: 60px;
      padding: 3px;
      font-size: 12px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      max-height: 40vh;
      resize: vertical;
      background: #020617;
      color: #e5e7eb;
      border-radius: 6px;
      border: 1px solid #1f2937;
      padding: 6px;
      font-size: 12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .section-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    pre {
      margin: 0;
      padding: 6px;
      background: #020617;
      border-radius: 6px;
      border: 1px solid #1f2937;
      font-size: 12px;
      max-height: 40vh;
      overflow: auto;
      white-space: pre-wrap;
      word-break: break-all;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }
    .log {
      font-size: 11px;
      background: #020617;
    }
    footer {
      padding: 6px 10px;
      font-size: 11px;
      color: #6b7280;
      border-top: 1px solid #1f2937;
      background: #020617;
      text-align: right;
    }
  </style>
</head>
<body>
  <header>
    <h1>편입 영어 자동 채점 (카메라 → OCR → 정답)</h1>
    <p>서강대/한양대 등 편입 기출용 · 카메라로 시험지 찍으면 정답만 생성</p>
  </header>

  <main>
    <div class="top-row">
      <section class="left">
        <div class="section-title">카메라</div>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas"></canvas>
        <div class="controls">
          <button id="btn-start" class="primary">카메라 켜기</button>
          <button id="btn-capture">촬영 + OCR + 채점</button>
          <button id="btn-stop">카메라 종료</button>
        </div>
        <div class="controls">
          <label>
            페이지:
            <input id="page-number" type="number" min="1" value="1" />
          </label>
          <label>
            <input id="tts-toggle" type="checkbox" checked />
            정답 TTS 읽기
          </label>
        </div>
      </section>

      <section class="right">
        <div>
          <div class="section-title">OCR 원문 (검수 용)</div>
          <textarea id="ocr-text" placeholder="OCR 결과가 여기에 표시됩니다."></textarea>
        </div>
        <div>
          <div class="section-title">정답 출력</div>
          <pre id="answer-output">(아직 정답 없음)</pre>
        </div>
        <div>
          <div class="section-title">디버그 (questionNumbers / answers 등)</div>
          <pre id="debug-output">(디버그 없음)</pre>
        </div>
      </section>
    </div>

    <section class="log">
      <div class="section-title">로그</div>
      <textarea id="status-log" readonly></textarea>
    </section>
  </main>

  <footer>
    answer-site · Netlify Functions (ocr / solve)
  </footer>

  <script>
    const videoEl = document.getElementById("video");
    const canvasEl = document.getElementById("canvas");
    const ocrTextEl = document.getElementById("ocr-text");
    const answerOutputEl = document.getElementById("answer-output");
    const debugOutputEl = document.getElementById("debug-output");
    const statusLogEl = document.getElementById("status-log");
    const pageInputEl = document.getElementById("page-number");
    const btnStart = document.getElementById("btn-start");
    const btnCapture = document.getElementById("btn-capture");
    const btnStop = document.getElementById("btn-stop");
    const ttsToggleEl = document.getElementById("tts-toggle");

    let stream = null;
    let wakeLock = null;

    function nowTime() {
      const d = new Date();
      return d.toTimeString().slice(0, 8);
    }

    function appendLog(line) {
      if (statusLogEl.value) statusLogEl.value += "\n";
      statusLogEl.value += line;
      statusLogEl.scrollTop = statusLogEl.scrollHeight;
      console.log(line);
    }

    function logStatus(msg) {
      appendLog(`[${nowTime()}] STATUS: ${msg}`);
    }

    function logEvent(label, data) {
      let text;
      if (typeof data === "string") {
        text = data;
      } else {
        try {
          text = JSON.stringify(data);
        } catch {
          text = String(data);
        }
      }
      // 너무 길면 잘라서 로그
      if (text.length > 800) {
        text = text.slice(0, 800) + "...(trimmed)";
      }
      appendLog(`[${nowTime()}] ${label} ${text}`);
    }

    async function requestWakeLock() {
      if (!("wakeLock" in navigator)) return;
      try {
        wakeLock = await navigator.wakeLock.request("screen");
        logStatus("화면 꺼짐 방지(wake lock) 설정됨.");
        wakeLock.addEventListener("release", () => {
          logStatus("화면 꺼짐 방지(wake lock) 해제됨.");
        });
      } catch (err) {
        logStatus("wake lock 요청 실패: " + err);
      }
    }

    async function releaseWakeLock() {
      if (wakeLock) {
        try {
          await wakeLock.release();
        } catch (err) {
          // ignore
        }
        wakeLock = null;
      }
    }

    async function startCamera() {
      try {
        logStatus("카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.");
        await requestWakeLock();

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          alert("이 브라우저는 카메라를 지원하지 않습니다.");
          logStatus("브라우저가 getUserMedia 를 지원하지 않음.");
          return;
        }

        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }

        try {
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { exact: "environment" } },
            audio: false,
          });
        } catch {
          // 일부 기기에서 exact가 실패할 수 있으니 fallback
          stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: "environment" },
            audio: false,
          });
        }

        videoEl.srcObject = stream;
        await videoEl.play();
        logStatus("카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.");
      } catch (err) {
        logStatus("카메라 시작 실패: " + err);
        alert("카메라 시작에 실패했습니다: " + err);
      }
    }

    async function stopCamera() {
      try {
        if (stream) {
          stream.getTracks().forEach((t) => t.stop());
          stream = null;
        }
        await releaseWakeLock();
      } finally {
        logStatus("카메라 종료 및 화면 꺼짐 방지(wake lock) 해제됨.");
      }
    }

    function dataUrlLength(dataUrl) {
      try {
        const base64 = dataUrl.split(",")[1] || "";
        return atob(base64).length;
      } catch {
        return 0;
      }
    }

    function speak(text) {
      if (!ttsToggleEl.checked) return;
      if (!("speechSynthesis" in window)) return;
      try {
        window.speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = "ko-KR";
        window.speechSynthesis.speak(u);
      } catch {
        // ignore
      }
    }

    async function captureOcrAndSolve() {
      const page = Number(pageInputEl.value || "1") || 1;

      if (!videoEl.srcObject) {
        alert("먼저 카메라를 켜주세요.");
        return;
      }

      try {
        logStatus(`페이지 ${page} 촬영 중... 시험지를 흔들리지 않게 잡고 있어줘.`);

        const vw = videoEl.videoWidth || 1080;
        const vh = videoEl.videoHeight || 1920;

        canvasEl.width = vw;
        canvasEl.height = vh;

        const ctx = canvasEl.getContext("2d");
        ctx.drawImage(videoEl, 0, 0, vw, vh);

        const dataUrl = canvasEl.toDataURL("image/jpeg", 0.92);
        const len = dataUrlLength(dataUrl);
        logEvent("capture size", { width: vw, height: vh, length: len });

        // ---------- OCR 호출 ----------
        logStatus("OCR 처리 중...");
        let ocrJson;
        try {
          const ocrRes = await fetch("/.netlify/functions/ocr", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: dataUrl, page }),
          });
          ocrJson = await ocrRes.json();
        } catch (err) {
          logStatus("OCR 네트워크 오류: " + err);
          alert("OCR 호출 중 오류가 발생했습니다.");
          return;
        }

        logEvent("OCR response", ocrJson);

        if (!ocrJson || !ocrJson.ok) {
          logStatus("OCR 실패: " + (ocrJson && ocrJson.error ? ocrJson.error : "Unknown"));
          return;
        }

        const ocrText = String(ocrJson.text || "");
        ocrTextEl.value = ocrText;

        const avgConf = ocrJson.avgConfidence ?? 0;
        const qPattern = ocrJson.questionPatternCount ?? 0;
        logStatus(
          `OCR 완료 (평균 신뢰도: ${avgConf}, 번호 패턴 수: ${qPattern}). 이제 정답을 생성할게.`
        );

        // ---------- solve 호출 ----------
        logStatus("정답 생성 중...");
        let solveJson;
        try {
          const solveRes = await fetch("/.netlify/functions/solve", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ page, ocrText }),
          });
          solveJson = await solveRes.json();
        } catch (err) {
          logStatus("solve 네트워크 오류: " + err);
          alert("solve 호출 중 오류가 발생했습니다.");
          return;
        }

        logEvent("solve response", solveJson);

        if (!solveJson || !solveJson.ok) {
          logStatus("solve 실패: " + (solveJson && solveJson.error ? solveJson.error : "Unknown"));
          return;
        }

        const answerText = String(solveJson.text || "").trim();
        answerOutputEl.textContent = answerText || "(정답 없음)";
        debugOutputEl.textContent = solveJson.debug
          ? JSON.stringify(solveJson.debug, null, 2)
          : "(디버그 없음)";

        logStatus(`페이지 ${page} 정답을 생성했어.`);

        if (answerText) {
          const spoken = answerText
            .split(/\r?\n/)
            .map((line) => {
              const m = line.match(/^(\d+)\s*:\s*([A-E])/i);
              if (!m) return null;
              const q = m[1];
              const ch = m[2].toUpperCase();
              return `${q}번 ${ch}번`;
            })
            .filter(Boolean)
            .join(", ");
          if (spoken) {
            speak("정답을 읽을게. " + spoken);
          }
        }
      } catch (err) {
        logStatus("전체 처리 중 오류: " + err);
      }
    }

    // 이벤트 핸들러 연결
    btnStart.addEventListener("click", startCamera);
    btnCapture.addEventListener("click", captureOcrAndSolve);
    btnStop.addEventListener("click", stopCamera);

    // 페이지 이탈 시 카메라/웨이크락 정리
    window.addEventListener("pagehide", () => {
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      releaseWakeLock();
    });

    // 초기 TTS 테스트
    logStatus("음성 테스트를 재생했어. 이후 문제풀이 정답도 소리로 읽어줄게.");
    speak("음성 테스트입니다. 문제 정답도 이렇게 읽어 줄게요.");
  </script>
</body>
</html>
