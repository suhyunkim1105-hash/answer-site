<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>OCR 누적 테스트</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui,
        sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 12px;
    }
    .card {
      background: #ffffff;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    label {
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    input[type="number"],
    input[type="text"] {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      width: 80px;
    }
    input[type="checkbox"] {
      transform: scale(1.1);
    }
    button {
      padding: 8px 14px;
      border-radius: 20px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    #btn-audio {
      background: #222;
      color: #fff;
    }
    #btn-start {
      background: #007aff;
      color: #fff;
    }
    #btn-stop {
      background: #e10600;
      color: #fff;
    }
    video {
      width: 100%;
      max-height: 420px;
      border-radius: 12px;
      background: #000;
      object-fit: contain;
    }
    .status {
      font-size: 14px;
      margin-top: 8px;
    }
    textarea {
      width: 100%;
      box-sizing: border-box;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 8px;
      background: #fafafa;
      resize: vertical;
    }
    .section-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>OCR 누적 테스트</h1>

  <!-- 컨트롤 -->
  <div class="card">
    <div class="row">
      <button id="btn-audio">오디오 활성화(1회)</button>
      <button id="btn-start">시작</button>
      <button id="btn-stop">중지</button>
    </div>

    <div class="row">
      <label>시작 페이지
        <input id="start-page" type="number" value="1" min="1" />
      </label>
      <label>샷/페이지
        <input id="shots-per-page" type="number" value="3" min="1" max="10" />
      </label>
      <label>카운트다운(초)
        <input id="countdown" type="number" value="5" min="1" max="20" />
      </label>
    </div>

    <div class="row">
      <label>최대 페이지(비우면 DONE으로 종료)
        <input id="max-page" type="number" placeholder="" min="1" />
      </label>
    </div>

    <div class="row">
      <label>최대 가로(px)
        <input id="max-width" type="number" value="1600" min="400" />
      </label>
      <label>JPEG 품질(0~1)
        <input id="jpeg-quality" type="text" value="0.85" />
      </label>
    </div>

    <div class="row">
      <label>
        <input id="opt-tts-status" type="checkbox" checked />
        화면에 "페이지/샷/진행상태" 표시 + TTS 안내
      </label>
    </div>
    <div class="row">
      <label>
        <input id="opt-best-only" type="checkbox" checked />
        페이지당 3샷 OCR 후 "가장 좋은 1개" 자동 채택
      </label>
    </div>
  </div>

  <!-- 카메라 프리뷰 -->
  <div class="card">
    <div class="section-title">카메라 프리뷰</div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <div id="run-status" class="status">
      실행중: N / 총 OCR 호출: 0 / 완료 페이지: 0 / 단계: 대기
    </div>
  </div>

  <!-- 로그 -->
  <div class="card">
    <div class="section-title">로그</div>
    <textarea id="log" rows="10" readonly></textarea>
  </div>

  <!-- 누적 OCR 텍스트 -->
  <div class="card">
    <div class="section-title">누적 OCR 텍스트(베스트만)</div>
    <textarea id="ocr-output" rows="10" readonly></textarea>
  </div>

  <!-- 정답 출력 -->
  <div class="card">
    <div class="section-title">정답 출력</div>
    <textarea id="answer-output" rows="4" readonly></textarea>
  </div>

  <script>
    // ==============================
    // 전역 상태
    // ==============================
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");

    let stream = null;
    let running = false;
    let doneDetected = false;
    let currentPage = 1;
    let totalOcrCalls = 0;

    const bestTextByPage = {};
    const bestScoreByPage = {};

    // ==============================
    // 유틸 함수
    // ==============================
    function sleep(ms) {
      return new Promise((res) => setTimeout(res, ms));
    }

    function timestamp() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, "0");
      return `[${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(
        d.getSeconds()
      )}]`;
    }

    function addLog(message) {
      const logEl = document.getElementById("log");
      const line = `${timestamp()} ${message}`;
      logEl.value += (logEl.value ? "\n" : "") + line;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function updateRunStatus(stepText) {
      const el = document.getElementById("run-status");
      if (!el) return;
      const donePages = Object.keys(bestTextByPage).length;
      el.textContent = `실행중: ${
        running ? "Y" : "N"
      } / 총 OCR 호출: ${totalOcrCalls} / 완료 페이지: ${donePages} / 단계: ${
        stepText || (running ? "진행중" : "대기")
      }`;
    }

    function speakKor(text) {
      const opt = document.getElementById("opt-tts-status");
      if (!opt.checked) return;
      if (!("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
    }

    function getSettings() {
      const startPage = parseInt(
        document.getElementById("start-page").value || "1",
        10
      );
      const shotsPerPage = parseInt(
        document.getElementById("shots-per-page").value || "3",
        10
      );
      const countdown = parseInt(
        document.getElementById("countdown").value || "5",
        10
      );
      const maxPageVal = document
        .getElementById("max-page")
        .value.trim();
      const maxPage = maxPageVal ? parseInt(maxPageVal, 10) : null;
      const maxWidth = parseInt(
        document.getElementById("max-width").value || "1600",
        10
      );
      const quality = parseFloat(
        document.getElementById("jpeg-quality").value || "0.85"
      );
      const ttsStatus = document.getElementById("opt-tts-status").checked;
      const bestOnly = document.getElementById("opt-best-only").checked;
      return {
        startPage,
        shotsPerPage,
        countdown,
        maxPage,
        maxWidth,
        quality,
        ttsStatus,
        bestOnly,
      };
    }

    // ==============================
    // 카메라 제어
    // ==============================
    async function startCamera() {
      if (stream) return;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        alert("이 기기에서는 카메라를 사용할 수 없습니다.");
        throw new Error("getUserMedia not supported");
      }
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false,
      });
      video.srcObject = stream;
      await video.play();
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach((t) => t.stop());
        stream = null;
      }
      if (video) {
        video.srcObject = null;
      }
    }

    // ==============================
    // OCR 한 번 호출
    // ==============================
    async function doSingleOcr(page, shot, settings) {
      if (!stream) {
        addLog("카메라 스트림이 없습니다.");
        return { ok: false, text: "", score: 0 };
      }

      const videoWidth = video.videoWidth || 1280;
      const videoHeight = video.videoHeight || 720;
      const scale =
        settings.maxWidth > 0
          ? Math.min(1, settings.maxWidth / videoWidth)
          : 1;
      const targetWidth = Math.round(videoWidth * scale);
      const targetHeight = Math.round(videoHeight * scale);

      canvas.width = targetWidth;
      canvas.height = targetHeight;
      ctx.drawImage(video, 0, 0, targetWidth, targetHeight);

      const dataUrl = canvas.toDataURL("image/jpeg", settings.quality);
      const base64 = dataUrl.split(",")[1];

      totalOcrCalls++;
      updateRunStatus("OCR 호출 중");

      try {
        const resp = await fetch("/.netlify/functions/ocr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageBase64: base64 }),
        });
        const data = await resp.json();
        const text = data && data.text ? String(data.text) : "";
        const len = text.length;
        const score = len; // 단순 길이 기준 스코어

        addLog(`OCR OK page=${page} shot=${shot} len=${len} score=${score}`);

        return { ok: true, text, score };
      } catch (err) {
        console.error(err);
        addLog(
          "OCR 호출 오류: " +
            (err && err.message ? err.message : String(err))
        );
        return { ok: false, text: "", score: 0 };
      }
    }

    // ==============================
    // 누적 텍스트 생성
    // ==============================
    function getBestOcrTextAllPages() {
      const outArea = document.getElementById("ocr-output");
      const pages = Object.keys(bestTextByPage)
        .map((n) => parseInt(n, 10))
        .sort((a, b) => a - b);

      let result = "";
      for (const p of pages) {
        const text = bestTextByPage[p] || "";
        result += `[PAGE ${p}]\n${text.trim()}\n\n`;
      }
      if (result) {
        result += "DONE";
      }
      outArea.value = result;
      return result;
    }

    // ==============================
    // /solve 호출 + 정답 TTS 4번
    // ==============================
    async function callSolve(ocrText) {
      addLog("정답 계산 시작 (/solve 호출)");

      try {
        const res = await fetch("/.netlify/functions/solve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ocrText }),
        });

        const raw = await res.text(); // JSON이든 문자열이든 전부 문자열로

        const answerBox = document.getElementById("answer-output");
        if (answerBox) {
          if ("value" in answerBox) {
            answerBox.value = raw;
          } else {
            answerBox.textContent = raw;
          }
        }

        speakAnswers(raw);
      } catch (err) {
        console.error(err);
        addLog(
          "정답 계산 중 오류: " +
            (err && err.message ? err.message : String(err))
        );
      }
    }

    function speakAnswers(text) {
      if (!("speechSynthesis" in window)) {
        addLog("이 브라우저는 TTS를 지원하지 않습니다.");
        return;
      }

      const cleaned = (text || "")
        .replace(/\s+/g, " ")
        .replace(/정답[:\s]*/gi, "")
        .trim();

      if (!cleaned) {
        addLog("읽을 정답 텍스트가 없습니다.");
        return;
      }

      // 정답 읽기 전에 기존 큐 비우기
      window.speechSynthesis.cancel();

      for (let i = 0; i < 4; i++) {
        const u = new SpeechSynthesisUtterance(cleaned);
        u.lang = "ko-KR";
        u.rate = 0.9; // 조금 천천히
        u.pitch = 1.0;
        window.speechSynthesis.speak(u);
      }

      addLog("정답 TTS 4회 재생 시작");
    }

    // ==============================
    // 자동 루프
    // ==============================
    async function runAutoLoop(settings) {
      while (running && !doneDetected) {
        for (let shot = 1; shot <= settings.shotsPerPage; shot++) {
          if (!running || doneDetected) break;

          const msg = `페이지 ${currentPage} / 샷 ${shot} 카운트다운 시작 (${settings.countdown}s)`;
          addLog(msg);
          updateRunStatus("카운트다운");
          speakKor(
            `페이지 ${currentPage}, 샷 ${shot}, ${settings.countdown}초 후 촬영합니다.`
          );

          await sleep(settings.countdown * 1000);
          if (!running || doneDetected) break;

          const result = await doSingleOcr(currentPage, shot, settings);
          if (!result.ok) continue;

          const { text, score } = result;

          if (
            !bestScoreByPage[currentPage] ||
            score > bestScoreByPage[currentPage]
          ) {
            bestScoreByPage[currentPage] = score;
            bestTextByPage[currentPage] = text;
          }

          if (/DONE\b/i.test(text)) {
            doneDetected = true;
            addLog(`DONE 감지 (page=${currentPage}, shot=${shot})`);
            break;
          }
        }

        if (bestScoreByPage[currentPage]) {
          addLog(
            `페이지 ${currentPage} 완료 (best score=${bestScoreByPage[currentPage]})`
          );
        }

        if (!running || doneDetected) break;

        currentPage++;

        if (settings.maxPage && currentPage > settings.maxPage) {
          addLog("최대 페이지 도달. OCR 종료");
          break;
        }
      }

      running = false;
      stopCamera();
      updateRunStatus("OCR 종료");
      speakKor("OCR가 종료되었습니다.");

      const bestTextAll = getBestOcrTextAllPages();
      if (!bestTextAll.trim()) {
        addLog("누적 OCR 텍스트가 없어 정답 계산을 건너뜁니다.");
        return;
      }

      speakKor("정답을 계산하고 읽어 드리겠습니다.");
      await callSolve(bestTextAll);
    }

    // ==============================
    // 시작 / 중지
    // ==============================
    async function startAuto() {
      if (running) {
        addLog("이미 실행 중입니다.");
        return;
      }

      const settings = getSettings();

      // 상태 초기화
      running = true;
      doneDetected = false;
      currentPage = settings.startPage;
      totalOcrCalls = 0;
      for (const k in bestTextByPage) delete bestTextByPage[k];
      for (const k in bestScoreByPage) delete bestScoreByPage[k];
      document.getElementById("ocr-output").value = "";
      document.getElementById("answer-output").value = "";

      updateRunStatus("카메라 준비중");
      speakKor("OCR를 시작합니다. 첫 페이지를 준비해 주세요.");

      try {
        await startCamera();
        addLog("카메라 OK");
      } catch (err) {
        addLog(
          "카메라 시작 실패: " +
            (err && err.message ? err.message : String(err))
        );
        alert("카메라 권한을 확인해 주세요.");
        running = false;
        updateRunStatus("카메라 오류");
        return;
      }

      addLog("AUTO START");
      updateRunStatus("OCR 진행중");

      await runAutoLoop(settings);
    }

    function stopAuto() {
      if (!running) {
        addLog("이미 정지 상태입니다.");
        return;
      }
      running = false;
      addLog("STOP 요청");
      speakKor("중지 요청을 받았습니다. 잠시 후 종료됩니다.");
    }

    function handleAudioInit() {
      if (!("speechSynthesis" in window)) {
        alert("이 브라우저는 음성 안내를 지원하지 않습니다.");
        return;
      }
      window.speechSynthesis.cancel();
      const u = new SpeechSynthesisUtterance(
        "오디오 안내가 활성화되었습니다."
      );
      u.lang = "ko-KR";
      u.rate = 1.0;
      window.speechSynthesis.speak(u);
      addLog("오디오 안내 활성화");
    }

    // ==============================
    // 이벤트 바인딩
    // ==============================
    document
      .getElementById("btn-audio")
      .addEventListener("click", handleAudioInit);
    document
      .getElementById("btn-start")
      .addEventListener("click", () => startAuto());
    document
      .getElementById("btn-stop")
      .addEventListener("click", () => stopAuto());
  </script>
</body>
</html>

