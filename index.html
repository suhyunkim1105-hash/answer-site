<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site - 편입 영어 자동 채점</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #111;
      color: #f5f5f5;
    }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      font-size: 20px;
      margin: 0 0 8px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }

    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      background: #2b7cff;
      color: #fff;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .danger {
      background: #ff3b30;
    }

    video, canvas {
      max-width: 100%;
      border-radius: 8px;
      background: #000;
    }

    .col {
      flex: 1 1 280px;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    textarea {
      width: 100%;
      min-height: 120px;
      resize: vertical;
      border-radius: 6px;
      border: 1px solid #444;
      padding: 8px;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 12px;
      background: #000;
      color: #f5f5f5;
    }

    .label {
      font-size: 13px;
      opacity: 0.8;
    }

    .status {
      font-size: 12px;
      white-space: pre-wrap;
      background: #000;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 8px;
      max-height: 240px;
      overflow-y: auto;
    }

    .answers {
      font-family: "SF Mono", Menlo, Consolas, monospace;
      white-space: pre-wrap;
      font-size: 14px;
      background: #000;
      border-radius: 6px;
      border: 1px solid #333;
      padding: 8px;
      min-height: 60px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>편입 영어 자동 채점 (카메라 → OCR → GPT)</h1>
    <div class="row">
      <button id="btnStartCamera">카메라 켜기</button>
      <button id="btnCapture" disabled>촬영 + OCR + 채점</button>
      <button id="btnStopCamera" class="danger" disabled>카메라 끄기</button>
    </div>

    <div class="row">
      <div class="col">
        <div class="label">카메라 미리보기</div>
        <video id="video" autoplay playsinline muted></video>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>
      <div class="col">
        <div class="label">OCR 결과(텍스트 확인용)</div>
        <textarea id="ocrText" placeholder="OCR 결과 텍스트가 여기에 표시됩니다."></textarea>
        <div class="label">정답 출력</div>
        <div id="answers" class="answers"></div>
        <button id="btnReadAnswers">정답 숫자로 TTS 재생</button>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <div class="label">로그</div>
        <div id="log" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    // ===== 공통 유틸 =====
    function appendLog(msg) {
      const logEl = document.getElementById("log");
      const time = new Date().toTimeString().slice(0, 8);
      logEl.textContent += `[${time}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
      console.log(msg);
    }

    function speak(text, options = {}) {
      const { rate = 1.0, pitch = 1.0, lang = "ko-KR" } = options;
      try {
        const synth = window.speechSynthesis;
        if (!synth) {
          appendLog("⚠️ 이 브라우저는 speechSynthesis(TTS)를 지원하지 않습니다.");
          return;
        }
        const utter = new SpeechSynthesisUtterance(text);
        utter.rate = rate;
        utter.pitch = pitch;
        utter.lang = lang;
        synth.cancel(); // 이전 말하기 중단
        synth.speak(utter);
      } catch (e) {
        console.error(e);
        appendLog("⚠️ TTS 재생 중 오류 발생.");
      }
    }

    // ===== 정답 A~E를 1~5 숫자로 읽어주는 모듈 =====
    (function () {
      const choiceMap = {
        "A": "1",
        "B": "2",
        "C": "3",
        "D": "4",
        "E": "5"
      };

      function formatAnswersForTts(rawAnswerText) {
        if (!rawAnswerText || typeof rawAnswerText !== "string") return "";

        const lines = rawAnswerText
          .split(/\r?\n/)
          .map(line => line.trim())
          .filter(line => line.length > 0);

        const spoken = [];

        for (const line of lines) {
          // "1: D", "1 - D", "01: B" 등 포맷 처리
          const m = line.match(/^(\d+)\s*[:\-]\s*([A-Ea-e])/);
          if (!m) {
            // 인식 못한 줄은 그대로 읽어도 됨 (혹시 몰라서)
            spoken.push(line);
            continue;
          }
          const qNum = m[1].replace(/^0+/, "") || m[1]; // 01 -> 1
          const letter = m[2].toUpperCase();
          const num = choiceMap[letter] || letter;

          // 예: "19번, 2번 정답입니다."
          spoken.push(`${qNum}번, ${num}번 정답입니다.`);
        }

        return spoken.join(" ");
      }

      function readAnswersAsNumbers(rawAnswerText) {
        const toSpeak = formatAnswersForTts(rawAnswerText);
        if (!toSpeak) {
          appendLog("⚠️ 읽을 정답이 없습니다.");
          return;
        }
        appendLog(`TTS(숫자) 재생: ${toSpeak}`);
        speak(toSpeak, { rate: 1.0, pitch: 1.0, lang: "ko-KR" });
      }

      // 전역으로 노출
      window.readAnswersAsNumbers = readAnswersAsNumbers;
    })();

    // ===== 카메라 & OCR & SOLVE 파이프라인 =====
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const ocrTextEl = document.getElementById("ocrText");
    const answersEl = document.getElementById("answers");

    const btnStartCamera = document.getElementById("btnStartCamera");
    const btnCapture = document.getElementById("btnCapture");
    const btnStopCamera = document.getElementById("btnStopCamera");
    const btnReadAnswers = document.getElementById("btnReadAnswers");

    let stream = null;
    let currentPage = 1;

    async function startCamera() {
      try {
        appendLog("STATUS: 카메라를 켜는 중...");
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "environment"
          },
          audio: false
        });
        video.srcObject = stream;
        btnCapture.disabled = false;
        btnStopCamera.disabled = false;
        appendLog("STATUS: 카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.");
      } catch (e) {
        console.error(e);
        appendLog("ERROR: 카메라를 켜지 못했습니다. 권한/브라우저 설정을 확인해줘.");
      }
    }

    function stopCamera() {
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
        video.srcObject = null;
      }
      btnCapture.disabled = true;
      btnStopCamera.disabled = true;
      appendLog("STATUS: 카메라를 껐어.");
    }

    async function captureAndSolve() {
      if (!stream) {
        appendLog("⚠️ 카메라가 켜져 있지 않습니다.");
        return;
      }
      try {
        const track = stream.getVideoTracks()[0];
        const settings = track.getSettings();
        const width = settings.width || video.videoWidth || 1080;
        const height = settings.height || video.videoHeight || 1920;

        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, width, height);

        const dataUrl = canvas.toDataURL("image/jpeg", 0.9);
        appendLog(
          `STATUS: 페이지 ${currentPage} 촬영 중... capture size {width:${width},height:${height},length:${dataUrl.length}}`
        );

        // 1) OCR 호출
        appendLog("STATUS: OCR 처리 중...");
        const ocrRes = await fetch("/.netlify/functions/ocr", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            image: dataUrl,
            page: currentPage
          })
        });

        const ocrJson = await ocrRes.json();
        if (!ocrJson.ok) {
          appendLog(`OCR 실패: ${ocrJson.error || "Unknown"}`);
          return;
        }

        const text = String(ocrJson.text || "");
        const page = ocrJson.page ?? currentPage;
        ocrTextEl.value = text;
        appendLog(
          `OCR response ${JSON.stringify({
            ok: ocrJson.ok,
            page,
            text: text.slice(0, 200) + (text.length > 200 ? "..." : "")
          })}`
        );
        appendLog(
          `STATUS: OCR 완료 (페이지 ${page}). 이제 정답을 생성할게.`
        );

        // 2) solve 호출
        const solveRes = await fetch("/.netlify/functions/solve", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            ocrText: text,
            page
          })
        });

        const solveJson = await solveRes.json();
        if (!solveJson.ok) {
          appendLog(
            `STATUS: solve 실패: ${solveJson.error || "Unknown error"}`
          );
          if (solveJson.dataPreview) {
            appendLog(`solve dataPreview: ${solveJson.dataPreview.slice(0, 200)}...`);
          }
          return;
        }

        const answerText = String(solveJson.text || "").trim();
        answersEl.textContent = answerText || "(정답 없음)";
        appendLog(
          `solve response ${JSON.stringify({
            ok: solveJson.ok,
            text: answerText,
            debug: solveJson.debug || null
          }).slice(0, 400)}`
        );
        appendLog(`STATUS: 페이지 ${page} 정답을 생성했어.`);

        // 3) 정답을 숫자로 바로 읽기
        if (answerText) {
          window.readAnswersAsNumbers(answerText);
        }

        currentPage += 1;
      } catch (e) {
        console.error(e);
        appendLog(`ERROR: captureAndSolve 중 예외 발생: ${e.message || e}`);
      }
    }

    // ===== 이벤트 바인딩 =====
    btnStartCamera.addEventListener("click", startCamera);
    btnStopCamera.addEventListener("click", stopCamera);
    btnCapture.addEventListener("click", captureAndSolve);

    btnReadAnswers.addEventListener("click", () => {
      const txt = answersEl.textContent || "";
      window.readAnswersAsNumbers(txt);
    });

    // 초기 로그
    appendLog("STATUS: 카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.");
  </script>
</body>
</html>

