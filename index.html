<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>autononsul - OCR/solve</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <style>
    * { box-sizing: border-box; }
    body { margin:0; padding:12px; font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background:#0b0b0b; color:#fff; }
    h1 { font-size:16px; margin:0 0 10px; }
    #status { font-size:12px; color:#c4f1ff; white-space:pre-wrap; padding:8px; border:1px solid #333; border-radius:10px; background:#070707; }
    #videoBox { margin-top:10px; border:1px solid #333; border-radius:10px; overflow:hidden; background:#000; }
    video { width:100%; height:auto; display:block; }
    .row { display:flex; gap:8px; margin-top:10px; }
    button { flex:1; padding:10px 12px; font-size:14px; border-radius:10px; border:1px solid #555; background:#151515; color:#fff; }
    button:active { transform: scale(0.98); }
    textarea { width:100%; min-height:140px; margin-top:8px; padding:10px; border-radius:10px; border:1px solid #333; background:#060606; color:#fff; font-size:12px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; white-space:pre-wrap; }
    .hint { font-size:11px; color:#aaa; margin-top:6px; }
    #errOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.92); color:#fff; padding:14px;
      display:none; z-index:9999; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
    }
    #errOverlay button { margin-top:10px; width:auto; }
    .smallRow { display:flex; gap:8px; margin-top:8px; align-items:center; }
    select { padding:8px; border-radius:10px; border:1px solid #444; background:#111; color:#fff; }
    label { font-size:12px; color:#bbb; }
  </style>
</head>

<body>
  <div id="errOverlay"></div>

  <h1>ì—°ì„¸ëŒ€ ë…¼ìˆ  ìë™ OCR/í’€ì´</h1>
  <div id="status">í˜ì´ì§€ ë¡œë”©ë¨. ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</div>

  <div id="videoBox">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="smallRow">
    <label>OCR ëª¨ë“œ</label>
    <select id="ocrMode">
      <option value="dual" selected>dual(í•œê¸€+ì˜ì–´)</option>
      <option value="kor">kor(í•œê¸€ ìš°ì„ )</option>
      <option value="eng">eng(ì˜ì–´ ìš°ì„ )</option>
    </select>
    <label style="margin-left:auto;">í˜ì´ì§€</label>
    <select id="pageSel"></select>
  </div>

  <div class="row">
    <button id="btnShutter">ğŸ“¸ ì…”í„°</button>
    <button id="btnSolve">ğŸ“ í’€ê¸°</button>
  </div>

  <div class="hint">
    - ì—ëŸ¬ê°€ ë‚˜ë©´ í° í™”ë©´ ëŒ€ì‹  ì—ëŸ¬ ì˜¤ë²„ë ˆì´ê°€ ëœ¬ë‹¤.<br/>
    - ì…”í„°ëŠ” â€œí•œ ìª½ ì „ì²´ê°€ ê½‰ ì°¨ê²Œâ€ ë³´ì—¬ì£¼ê³  ëˆŒëŸ¬ë¼. (A3ë©´ íŠ¹íˆ)
  </div>

  <textarea id="ocrBox" placeholder="OCR ëˆ„ì  í…ìŠ¤íŠ¸"></textarea>
  <textarea id="answerBox" placeholder="AI ë‹µì•ˆ"></textarea>

<script>
(function(){
  const statusEl = document.getElementById("status");
  const video = document.getElementById("video");
  const btnShutter = document.getElementById("btnShutter");
  const btnSolve = document.getElementById("btnSolve");
  const ocrBox = document.getElementById("ocrBox");
  const answerBox = document.getElementById("answerBox");
  const errOverlay = document.getElementById("errOverlay");
  const ocrModeSel = document.getElementById("ocrMode");
  const pageSel = document.getElementById("pageSel");

  const OCR_URL = "/.netlify/functions/ocr";
  const SOLVE_URL = "/.netlify/functions/solve";

  // --- í˜ì´ì§€ ì„ íƒ(1~12)
  const MAX_PAGE = 12;
  for (let i=1; i<=MAX_PAGE; i++){
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    pageSel.appendChild(opt);
  }
  pageSel.value = "1";

  // --- ì—ëŸ¬ ì˜¤ë²„ë ˆì´(í° í™”ë©´ ë°©ì§€)
  function showErrorOverlay(title, detail){
    try{
      errOverlay.style.display = "block";
      errOverlay.textContent = `[ERROR]\n${title}\n\n${detail || ""}\n\n(ì•„ë˜ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹«í˜)`;
      const btn = document.createElement("button");
      btn.textContent = "ë‹«ê¸°";
      btn.onclick = () => { errOverlay.style.display = "none"; errOverlay.innerHTML = ""; };
      errOverlay.appendChild(document.createElement("br"));
      errOverlay.appendChild(btn);
    }catch(e){}
  }

  window.addEventListener("error", (e) => {
    showErrorOverlay(e.message || "Unknown JS error", (e.error && e.error.stack) ? e.error.stack : "");
  });
  window.addEventListener("unhandledrejection", (e) => {
    const msg = (e && e.reason) ? (e.reason.message || String(e.reason)) : "Unhandled rejection";
    const stack = (e && e.reason && e.reason.stack) ? e.reason.stack : "";
    showErrorOverlay(msg, stack);
  });

  // --- TTS í/ë°˜ë³µ (ìƒˆ ë‹µì•ˆì´ ì™€ë„ â€œì¤‘ê°„ì— ëŠì§€ ì•Šê³ â€ ë‹¤ìŒì— ì¬ìƒ)
  let ttsPrimed = false;
  let speaking = false;
  let pendingText = null;
  let lastSpokenText = "";
  let repeatMode = true; // ìµœì¢…ë‹µì•ˆ ë°˜ë³µ ì¬ìƒ
  const RATE = 0.72;     // ëŠë¦¬ê²Œ

  function toWongojiSpeech(text){
    let t = String(text || "");
    t = t.replace(/\r/g, "");
    t = t.replace(/\n+/g, " ì¤„ë°”ê¿ˆ ");
    t = t.replace(/ /g, " ë„ìš°ê³  ");
    t = t.replace(/\./g, " ë§ˆì¹¨í‘œ ");
    t = t.replace(/,/g, " ì‰¼í‘œ ");
    t = t.replace(/!/g, " ëŠë‚Œí‘œ ");
    t = t.replace(/\?/g, " ë¬¼ìŒí‘œ ");
    return t;
  }

  function speakQueued(text){
    try{
      if (!text) return;
      if (!window.speechSynthesis) return;

      if (speaking){
        pendingText = text;
        return;
      }

      speaking = true;
      lastSpokenText = text;

      const u = new SpeechSynthesisUtterance(toWongojiSpeech(text));
      u.lang = "ko-KR";
      u.rate = RATE;
      u.pitch = 1.0;

      u.onend = () => {
        speaking = false;

        if (pendingText){
          const next = pendingText;
          pendingText = null;
          setTimeout(() => speakQueued(next), 400);
          return;
        }

        if (repeatMode && lastSpokenText){
          setTimeout(() => speakQueued(lastSpokenText), 900);
        }
      };

      u.onerror = () => { speaking = false; };

      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  function primeTTS(){
    if (ttsPrimed) return;
    ttsPrimed = true;
    try{
      const u = new SpeechSynthesisUtterance("ìŒì„± ì—°ê²°");
      u.lang = "ko-KR";
      u.rate = 1.0;
      u.onend = () => { window.speechSynthesis.cancel(); };
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // --- ì¹´ë©”ë¼
  let stream = null;
  async function startCamera(){
    try{
      statusEl.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" }, width: { ideal: 1920 }, height: { ideal: 1080 } },
        audio: false
      });
      video.srcObject = stream;
      statusEl.textContent = "ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ";
    }catch(e){
      statusEl.textContent = "ì¹´ë©”ë¼ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", String(e && e.message ? e.message : e));
    }
  }

  // --- í”„ë ˆì„ ìº¡ì³(dataURL)
  function captureDataUrl(){
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;

    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", 0.9);
  }

  // --- OCR
  async function doOCR(){
    const pageIndex = Number(pageSel.value || "1");
    const mode = ocrModeSel.value || "dual";

    const dataUrl = captureDataUrl();
    if (!dataUrl){
      statusEl.textContent = "ì˜ìƒ ì¤€ë¹„ ì¤‘(1~2ì´ˆ ë’¤ ì¬ì‹œë„)";
      speakQueued("ì¹´ë©”ë¼ ì˜ìƒì´ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      return;
    }

    statusEl.textContent = `í˜ì´ì§€ ${pageIndex} OCR ìš”ì²­ ì¤‘...`;
    try{
      const res = await fetch(OCR_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ imageBase64: dataUrl, pageIndex, mode })
      });

      const json = await res.json().catch(() => null);
      if (!json || !json.ok){
        const msg = (json && (json.message || json.error)) || "OCR ì‹¤íŒ¨";
        statusEl.textContent = `ì‹¤íŒ¨: ${msg}`;
        speakQueued("ì˜¤ì”¨ì•Œ ì‹¤íŒ¨. ë‹¤ì‹œ ì´¬ì˜í•˜ì„¸ìš”.");
        return;
      }

      const label = (typeof json.pageIndex === "number") ? json.pageIndex : pageIndex;
      const block = `\n\n[í˜ì´ì§€ ${label}]-------------------\n${json.text || ""}`;
      ocrBox.value = (ocrBox.value || "") + block;

      statusEl.textContent = `OCR ì„±ê³µ (í˜ì´ì§€ ${label}) / ì‹ ë¢°ë„(ëŒ€ëµ): ${(json.conf || 0).toFixed(1)}%`;
      speakQueued("ì˜¤ì”¨ì•Œ ì„±ê³µ");
    }catch(e){
      statusEl.textContent = "OCR ìš”ì²­ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("OCR ìš”ì²­ ì‹¤íŒ¨", String(e && e.stack ? e.stack : e));
    }
  }

  // --- Solve
  async function doSolve(){
    primeTTS();

    const text = (ocrBox.value || "").trim();
    if (!text){
      statusEl.textContent = "ë¨¼ì € ì…”í„°ë¡œ OCRì„ ìŒ“ì•„ì£¼ì„¸ìš”.";
      speakQueued("ë¨¼ì € ì˜¤ì”¨ì•Œì„ ì§„í–‰í•˜ì„¸ìš”.");
      return;
    }

    statusEl.textContent = "AI í’€ì´ ìš”ì²­ ì¤‘...";
    try{
      const res = await fetch(SOLVE_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text, targetChars: 1000, tolerance: 120 })
      });

      const json = await res.json().catch(() => null);
      if (!json || !json.ok){
        const msg = (json && (json.message || json.error)) || "solve ì‹¤íŒ¨";
        statusEl.textContent = `í’€ì´ ì‹¤íŒ¨: ${msg}`;
        speakQueued("í’€ì´ ì‹¤íŒ¨");
        return;
      }

      const answer = (json.answer || "").trim();
      answerBox.value = answer || "(ë¹ˆ ì‘ë‹µ)";
      statusEl.textContent = "í’€ì´ ì™„ë£Œ. (ì›ê³ ì§€ ëª¨ë“œë¡œ ëŠë¦¬ê²Œ ë°˜ë³µ ë‚­ë…)";

      speakQueued(answer);
    }catch(e){
      statusEl.textContent = "í’€ì´ ìš”ì²­ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("solve ìš”ì²­ ì‹¤íŒ¨", String(e && e.stack ? e.stack : e));
    }
  }

  btnShutter.addEventListener("click", doOCR);
  btnSolve.addEventListener("click", doSolve);

  startCamera();
})();
</script>
</body>
</html>
