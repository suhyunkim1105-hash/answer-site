<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìë™ OCR â†’ ìë™ í’€ì´ â†’ ìŒì„± ì¶œë ¥</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body { margin:0; padding:12px; background:#000; color:#fff; font-family:sans-serif; }
video { width:100%; max-height:45vh; background:#000; }
textarea, pre {
  width:100%; background:#000; color:#fff;
  border:1px solid #444; padding:8px;
  white-space:pre-wrap;
}
label { font-size:13px; }
</style>
</head>

<body>

<h3>ğŸ“· ìë™ OCR (ëˆ„ì ) â†’ ìë™ í’€ì´ â†’ ìŒì„±</h3>

<video id="video" autoplay playsinline></video>

<label>
OCR ì¤Œì•„ì›ƒ ë°°ìœ¨ (0.8 = ê°€ì¥ ë„“ê²Œ):
<input type="range" id="zoom" min="0.8" max="1.0" step="0.01" value="0.8">
<span id="zoomVal">0.80</span>
</label>

<h4>ëˆ„ì  OCR</h4>
<textarea id="ocrBox" rows="8" readonly></textarea>

<h4>ë‹µì•ˆ</h4>
<pre id="answerBox"></pre>

<canvas id="canvas" style="display:none;"></canvas>

<script>
/* ================== ì„¤ì • ================== */
const OCR_INTERVAL = 3000;
const SOLVE_LEN = 2000;
const SOLVE_URL = "/.netlify/functions/solve";

/* ================== ìƒíƒœ ================== */
let accumulated = "";
let solved = false;
let cropFactor = 0.8;
let stream;

/* ================== ì¹´ë©”ë¼ ================== */
async function startCamera(){
  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }, audio:false
  });
  video.srcObject = stream;
}
startCamera();

/* ================== OCR ì •ê·œí™” ================== */
function normalize(text){
  let t = String(text||"");
  t = t.replace(/[A-Za-z]/g,"");
  t = t.replace(/[^ê°€-í£0-9\u2460-\u2473\u2780-\u2789\u3260-\u327F\s]/g," ");
  t = t.replace(/[ \t]{2,}/g," ");
  return t.trim();
}

/* ================== OCR ìº¡ì²˜ ================== */
function capture(){
  const c = canvas, ctx = c.getContext("2d");
  const vw = video.videoWidth, vh = video.videoHeight;
  const cw = Math.floor(vw * cropFactor);
  const ch = Math.floor(vh * cropFactor);
  const cx = (vw - cw)/2, cy = (vh - ch)/2;
  c.width = cw; c.height = ch;
  ctx.drawImage(video, cx, cy, cw, ch, 0, 0, cw, ch);
  return c;
}

/* ================== ìë™ OCR ================== */
async function autoOCR(){
  if (solved) return;

  const c = capture();
  const res = await Tesseract.recognize(c, "kor");
  const clean = normalize(res.data.text);

  if (clean.length > 20 && !accumulated.includes(clean)){
    accumulated += "\n" + clean;
    ocrBox.value = accumulated.trim();
  }

  if (!solved && accumulated.replace(/\s/g,"").length >= SOLVE_LEN){
    solved = true;
    autoSolve();
  }
}
setInterval(autoOCR, OCR_INTERVAL);

/* ================== ìë™ í’€ì´ ================== */
async function autoSolve(){
  answerBox.textContent = "í’€ì´ ìƒì„± ì¤‘â€¦";

  const r = await fetch(SOLVE_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({ ocrText: accumulated.slice(0,8000) })
  });

  const txt = await r.text();
  answerBox.textContent = txt;
  speak(txt);
}

/* ================== TTS ================== */
function speak(text){
  if (!("speechSynthesis" in window)) return;
  speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "ko-KR";
  speechSynthesis.speak(u);
}

/* ================== ì¤Œ ìŠ¬ë¼ì´ë” ================== */
zoom.oninput = () => {
  cropFactor = parseFloat(zoom.value);
  zoomVal.textContent = cropFactor.toFixed(2);
};

/* iOS ìŒì„± unlock */
document.body.addEventListener("touchstart", ()=>speak(""), { once:true });
</script>

</body>
</html>

