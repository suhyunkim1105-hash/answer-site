<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>answer-site | Camera OCR</title>
<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<style>
body { margin: 0; background: #000; }
#video { width: 100vw; height: 100vh; object-fit: cover; }
</style>
</head>
<body>

<video id="video" autoplay></video>

<script>
// ---------------------- Firebase ----------------------
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_DOMAIN",
  databaseURL: "YOUR_DB_URL",
  projectId: "YOUR_PID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------------- Camera Init ----------------------
const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({
  video: { facingMode: "environment" }
}).then(stream => {
  video.srcObject = stream;
});

// ---------------------- OCR Function ----------------------
async function captureAndOcr(command) {
  const canvas = document.createElement("canvas");
  const w = video.videoWidth;
  const h = video.videoHeight;

  // 중앙부 70% 크롭
  const cropW = w * 0.7;
  const cropH = h * 0.7;
  const cropX = (w - cropW) / 2;
  const cropY = (h - cropH) / 2;

  canvas.width = cropW;
  canvas.height = cropH;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);

  const dataUrl = canvas.toDataURL("image/png");
  const result = await Tesseract.recognize(dataUrl, "eng+kor", {
    logger: m => console.log(m)
  });

  const text = result.data.text.trim();

  db.ref("p2p/latestResult").set({
    target: command.target,
    text,
    timestamp: Date.now()
  });
}

// ---------------------- Listen for Commands ----------------------
db.ref("p2p/latestCommand").on("value", snap => {
  const cmd = snap.val();
  if (!cmd) return;

  if (cmd.action === "capture") {
    captureAndOcr(cmd);
  }
});
</script>

</body>
</html>

