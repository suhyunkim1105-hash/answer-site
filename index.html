<!-- index.html (통째로 복붙) -->
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>answer-site</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0b1020; color:#e9eefc; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background:#0f1835; border:1px solid rgba(255,255,255,.08); border-radius: 18px; padding: 16px; margin-bottom: 14px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h2 { margin:0 0 10px 0; font-size: 18px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    button { background:#2b6cff; border:none; color:white; padding:10px 14px; border-radius: 12px; font-weight: 700; cursor:pointer; }
    button.secondary { background:#243055; }
    button.danger { background:#7a2d2d; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    input, select {
      background:#0b1020; color:#e9eefc;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 10px; padding:10px 12px;
    }
    .previewWrap {
      height: 70vh;
      min-height: 360px;
      border-radius: 18px;
      overflow:hidden;
      background:#050a18;
      border:1px solid rgba(255,255,255,.08);
    }
    video { width:100%; height:100%; object-fit: contain; background:#000; }
    .hint { opacity:.85; font-size: 13px; line-height: 1.55; margin-top: 10px; }
    pre { margin:0; white-space: pre-wrap; word-break: break-word; font-size: 12px; line-height: 1.45; }
    textarea {
      width:100%; min-height: 160px; resize: vertical;
      background:#0b1020; color:#e9eefc;
      border:1px solid rgba(255,255,255,.14);
      border-radius: 12px; padding:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 12px;
    }
    .small { font-size: 12px; opacity: .85; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.14); font-size:12px; opacity:.9; }
    .sp { height: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h2>카메라</h2>

      <div class="row">
        <button id="btnStart">카메라 시작</button>
        <button id="btnShot" class="secondary">현재 페이지 촬영 → OCR → 정답</button>

        <span class="small">페이지</span>
        <input id="page" type="number" value="1" min="1" style="width:90px" />

        <span class="small">JPEG 품질</span>
        <select id="jpegQ">
          <option value="0.85">0.85 (작게/빠름)</option>
          <option value="0.92" selected>0.92 (추천)</option>
          <option value="0.97">0.97 (크게/선명)</option>
        </select>

        <span id="statusPill" class="pill">IDLE</span>
      </div>

      <div class="sp"></div>

      <div class="previewWrap">
        <video id="video" playsinline autoplay muted></video>
      </div>

      <div class="hint">
        ① 시험지를 화면에 최대한 꽉 채우기(글자/번호/보기 선명)<br/>
        ② 흔들림 최소화(특히 문법 06–10 줄)<br/>
        ③ “촬영→OCR→정답” 한 번에 진행<br/>
        <span class="small">※ 촬영 버튼 연타 금지(자동으로 잠금)</span>
      </div>
    </div>

    <div class="card">
      <h2>로그</h2>
      <div class="row" style="margin-bottom:10px">
        <button id="btnClearLog" class="danger">로그 지우기</button>
        <button id="btnCopyLog" class="secondary">로그 복사</button>
      </div>
      <pre id="log"></pre>
    </div>

    <div class="card">
      <h2>OCR 원문 확인</h2>
      <div class="row" style="margin-bottom:10px">
        <span class="small">여기서 OCR이 제대로 뽑혔는지 즉시 확인</span>
        <button id="btnCopyOCR" class="secondary">OCR 복사</button>
      </div>
      <textarea id="ocrBox" placeholder="OCR 결과가 여기에 표시됨" readonly></textarea>
    </div>

    <div class="card">
      <h2>정답</h2>
      <div class="row" style="margin-bottom:10px">
        <span class="small">UNSURE가 있으면 재촬영 후보</span>
        <button id="btnCopyAns" class="secondary">정답 복사</button>
      </div>
      <textarea id="ansBox" placeholder="정답 결과가 여기에 표시됨" readonly></textarea>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const video = $("video");
    const logEl = $("log");
    const ocrBox = $("ocrBox");
    const ansBox = $("ansBox");
    const btnShot = $("btnShot");
    const btnStart = $("btnStart");
    const statusPill = $("statusPill");

    const btnClearLog = $("btnClearLog");
    const btnCopyLog = $("btnCopyLog");
    const btnCopyOCR = $("btnCopyOCR");
    const btnCopyAns = $("btnCopyAns");

    function ts() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2,"0");
      const mm = String(d.getMinutes()).padStart(2,"0");
      const ss = String(d.getSeconds()).padStart(2,"0");
      return `${hh}:${mm}:${ss}`;
    }

    function setStatus(s) {
      statusPill.textContent = s;
    }

    function log(msg) {
      logEl.textContent += `[${ts()}] ${msg}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        log("STATUS: 복사 완료");
      } catch (e) {
        // iOS 일부 환경 fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        document.body.removeChild(ta);
        log("STATUS: 복사 완료(fallback)");
      }
    }

    let stream = null;
    let busy = false;

    async function startCamera() {
      if (stream) return;

      setStatus("CAMERA");
      log("STATUS: 카메라를 켜고, 페이지 1부터 한 페이지씩 촬영해.");

      const constraints = {
        audio: false,
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      };

      stream = await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject = stream;

      await new Promise((r) => {
        video.onloadedmetadata = () => r();
      });

      log("STATUS: 카메라가 켜졌어. 시험지를 화면에 꽉 차게 맞춰줘.");
      setStatus("READY");
    }

    function captureDataURL() {
      const vw = video.videoWidth;
      const vh = video.videoHeight;
      if (!vw || !vh) throw new Error("Video not ready");

      const q = Number($("jpegQ").value || 0.92);

      const canvas = document.createElement("canvas");
      canvas.width = vw;
      canvas.height = vh;

      const ctx = canvas.getContext("2d", { alpha: false });
      // 가벼운 선명도/가독성 보정(과하지 않게)
      ctx.filter = "contrast(1.12) saturate(1.02)";
      ctx.drawImage(video, 0, 0, vw, vh);

      const dataUrl = canvas.toDataURL("image/jpeg", q);
      return { dataUrl, vw, vh, length: dataUrl.length, q };
    }

    async function doOCR(page, dataUrl) {
      const res = await fetch("/.netlify/functions/ocr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ page, image: dataUrl }),
      });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok && data.ok, ...data, _http: res.status };
    }

    async function doSolve(page, ocrText) {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ page, ocrText }),
      });
      const data = await res.json().catch(() => ({}));
      return { ok: res.ok && data.ok, ...data, _http: res.status };
    }

    btnStart.addEventListener("click", async () => {
      try {
        await startCamera();
      } catch (e) {
        setStatus("ERR");
        log(`STATUS: 카메라 실패: ${e?.message || e}`);
      }
    });

    btnShot.addEventListener("click", async () => {
      if (busy) return;
      busy = true;
      btnShot.disabled = true;

      try {
        await startCamera();

        const page = Number($("page").value || 1);

        setStatus("CAPTURE");
        log(`STATUS: 페이지 ${page} 촬영 중... 시험지를 흔들리지 않게 잡고 있어줘.`);
        const cap = captureDataURL();
        log(`capture size ${JSON.stringify({ width: cap.vw, height: cap.vh, jpegQ: cap.q, length: Math.floor(cap.length/4) })}`);

        setStatus("OCR");
        log("STATUS: OCR 처리 중...");
        const ocr = await doOCR(page, cap.dataUrl);
        log(`OCR response ${JSON.stringify(ocr).slice(0, 1400)}`);

        if (!ocr.ok) {
          setStatus("OCR_ERR");
          log(`STATUS: OCR 실패: ${ocr.error || "Unknown"}${ocr.detail ? " / " + ocr.detail : ""} (HTTP ${ocr._http})`);
          return;
        }

        ocrBox.value = ocr.text || "";

        setStatus("SOLVE");
        log(`STATUS: OCR 완료 (번호 패턴 수: ${ocr.hits ?? 0}). 이제 정답을 생성할게.`);
        const solved = await doSolve(page, ocr.text || "");
        log(`solve response ${JSON.stringify(solved).slice(0, 1400)}`);

        if (!solved.ok) {
          setStatus("SOLVE_ERR");
          log(`STATUS: solve 실패: ${solved.error || "Unknown"}${solved.detail ? " / " + solved.detail : ""} (HTTP ${solved._http})`);
          return;
        }

        ansBox.value = solved.text || "";
        setStatus("DONE");
        log(`STATUS: 페이지 ${page} 정답을 생성했어. XURTH가 들리면 이 페이지는 끝이야.`);
      } catch (e) {
        setStatus("ERR");
        log(`STATUS: 처리 실패: ${e?.message || e}`);
      } finally {
        busy = false;
        btnShot.disabled = false;
        if (statusPill.textContent === "DONE") setTimeout(() => setStatus("READY"), 800);
      }
    });

    btnClearLog.addEventListener("click", () => {
      logEl.textContent = "";
      log("STATUS: 로그 초기화");
    });

    btnCopyLog.addEventListener("click", async () => {
      await copyToClipboard(logEl.textContent || "");
    });

    btnCopyOCR.addEventListener("click", async () => {
      await copyToClipboard(ocrBox.value || "");
    });

    btnCopyAns.addEventListener("click", async () => {
      await copyToClipboard(ansBox.value || "");
    });

    // 초기 상태
    setStatus("IDLE");
  </script>
</body>
</html>
