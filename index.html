<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>autononsul - OCR/solve</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <style>
    * { box-sizing: border-box; }
    body {
      margin:0; padding:12px;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#0b0b0b; color:#fff;
    }
    h1 { font-size:16px; margin:0 0 10px; }
    #status {
      font-size:12px; color:#c4f1ff; white-space:pre-wrap;
      padding:8px; border:1px solid #333; border-radius:10px; background:#070707;
    }
    #videoBox {
      margin-top:10px; border:1px solid #333; border-radius:10px;
      overflow:hidden; background:#000;
    }
    video { width:100%; height:auto; display:block; }
    .row { display:flex; gap:8px; margin-top:10px; }
    button {
      flex:1; padding:10px 12px; font-size:14px;
      border-radius:10px; border:1px solid #555;
      background:#151515; color:#fff;
    }
    button:active { transform: scale(0.98); }
    textarea {
      width:100%; min-height:140px; margin-top:8px; padding:10px;
      border-radius:10px; border:1px solid #333;
      background:#060606; color:#fff;
      font-size:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
    }
    .hint { font-size:11px; color:#aaa; margin-top:6px; }
    #errOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.92); color:#fff;
      padding:14px; display:none; z-index:9999; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
    }
    #errOverlay button { margin-top:10px; width:auto; }
    .smallRow { display:flex; gap:8px; margin-top:8px; align-items:center; }
    select {
      padding:8px; border-radius:10px; border:1px solid #444;
      background:#111; color:#fff;
    }
    label { font-size:12px; color:#bbb; }
  </style>
</head>

<body>
  <div id="errOverlay"></div>

  <h1>ì—°ì„¸ëŒ€ ë…¼ìˆ  ìë™ OCR/í’€ì´</h1>
  <div id="status">í˜ì´ì§€ ë¡œë”©ë¨. ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</div>

  <div id="videoBox">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div class="smallRow">
    <span style="font-size:12px;">OCR ëª¨ë“œ: <strong>dual(í•œê¸€+ì˜ì–´ ê³ ì •)</strong></span>
    <span style="margin-left:auto; font-size:12px;">í˜ì´ì§€</span>
    <select id="pageSel"></select>
  </div>

  <div class="row">
    <button id="btnShutter">ğŸ“¸ ì…”í„°(ì—°ì† ìë™ OCR ì‹œì‘/ì¤‘ë‹¨)</button>
    <button id="btnSolve">ğŸ“ í’€ê¸°(ìˆ˜ë™)</button>
  </div>

  <div class="hint">
    - ì…”í„°ë¥¼ <strong>í•œ ë²ˆ ëˆ„ë¥´ë©´</strong> í˜„ì¬ í˜ì´ì§€ë¶€í„° ê° í˜ì´ì§€ë¥¼ <strong>3íšŒì”©</strong> ìë™ ì´¬ì˜í•˜ë©°, â€œì´ì œ í’€ì´ë¥¼ ì‹œì‘í•˜ì‹œì˜¤â€ê°€ ë³´ì´ë©´ ìë™ìœ¼ë¡œ í’€ì´ë¥¼ ì‹œì‘í•œë‹¤.<br/>
    - ê° í˜ì´ì§€ì˜ ì´¬ì˜ì´ ëë‚˜ë©´ â€œ5 4 3 2 1, ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ê²¨ ì£¼ì„¸ìš”.â€ë¼ëŠ” ìŒì„±ì´ ë“¤ë¦° ë’¤ ë‹¤ìŒ í˜ì´ì§€ë¡œ ìë™ ë„˜ì–´ê°„ë‹¤.<br/>
    - ë‹µì•ˆì€ ì›ë¬¸ì„ <strong>ì•„ì£¼ ëŠë¦° ì†ë„</strong>ë¡œ ë°˜ë³µ ë‚­ë…í•œë‹¤.<br/>
    - <strong>TTS ì†Œë¦¬ê°€ ì „í˜€ ì•ˆ ë“¤ë¦¬ë©´, í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ ë’¤ í™”ë©´ì„ í•œ ë²ˆ í„°ì¹˜í•´ì„œ TTSë¥¼ ë‹¤ì‹œ ì¤€ë¹„í•œ í›„ ì‚¬ìš©í•˜ë¼.</strong>
  </div>

  <textarea id="ocrBox" placeholder="OCR ëˆ„ì  í…ìŠ¤íŠ¸"></textarea>
  <textarea id="answerBox" placeholder="AI ë‹µì•ˆ"></textarea>

<script>
(function(){
  "use strict";

  const statusEl   = document.getElementById("status");
  const video      = document.getElementById("video");
  const btnShutter = document.getElementById("btnShutter");
  const btnSolve   = document.getElementById("btnSolve");
  const ocrBox     = document.getElementById("ocrBox");
  const answerBox  = document.getElementById("answerBox");
  const errOverlay = document.getElementById("errOverlay");
  const pageSel    = document.getElementById("pageSel");

  const OCR_URL   = "/.netlify/functions/ocr";
  const SOLVE_URL = "/.netlify/functions/solve";

  const MAX_PAGE           = 12;
  const SHOTS_PER_PAGE     = 3;    // í˜ì´ì§€ë‹¹ 3íšŒ ì´¬ì˜
  const SHOT_INTERVAL_MS   = 5000; // 5ì´ˆ ê°„ê²©
  const MAX_RETRY_PER_PAGE = 2;    // OCR ì™„ì „ ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ì „ì²´ ì¬ì‹œë„ ìµœëŒ€ 2íšŒ

  let currentPage   = 1;
  let autoRun       = false;
  let isShootingOne = false;
  let stream        = null;

  // TTS ê´€ë ¨ ìƒíƒœ
  let ttsReady        = false;
  let ttsVoice        = null;
  let answerRepeating = false;
  let lastAnswerRaw   = "";
  let wakeLock        = null;

  // í˜ì´ì§€ ì…€ë ‰íŠ¸ ì±„ìš°ê¸°
  for (let i = 1; i <= MAX_PAGE; i++) {
    const opt = document.createElement("option");
    opt.value = String(i);
    opt.textContent = String(i);
    pageSel.appendChild(opt);
  }
  pageSel.value = "1";

  // --------- ì—ëŸ¬ ì˜¤ë²„ë ˆì´ ---------
  function showErrorOverlay(title, detail){
    try {
      errOverlay.style.display = "block";
      errOverlay.textContent =
        "[ERROR]\n" + (title || "") + "\n\n" +
        (detail || "") +
        "\n\n(ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‹«í™ë‹ˆë‹¤)";
      const btn = document.createElement("button");
      btn.textContent = "ë‹«ê¸°";
      btn.onclick = function(){
        errOverlay.style.display = "none";
        errOverlay.innerHTML = "";
      };
      errOverlay.appendChild(document.createElement("br"));
      errOverlay.appendChild(btn);
    } catch(e){}
  }

  window.addEventListener("error", function(e){
    showErrorOverlay(e.message || "Unknown JS error", (e.error && e.error.stack) ? e.error.stack : "");
  });

  window.addEventListener("unhandledrejection", function(e){
    const msg   = e && e.reason ? (e.reason.message || String(e.reason)) : "unhandled rejection";
    const stack = e && e.reason && e.reason.stack ? e.reason.stack : "";
    showErrorOverlay(msg, stack);
  });

  // --------- TTS ---------
  function loadVoices(){
    try {
      if (!window.speechSynthesis) return;
      const voices = window.speechSynthesis.getVoices() || [];
      if (!voices.length) return;
      const ko = voices.filter(function(v){
        return v.lang && v.lang.toLowerCase().startsWith("ko");
      });
      ttsVoice = ko.length ? ko[0] : voices[0];
    } catch(e){}
  }

  if (window.speechSynthesis) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
  }

  function transformAnswerText(text){
    let t = String(text || "");
    t = t.replace(/\r/g, "");
    // ì¤„ë°”ê¿ˆì€ 'ì¤„ë°”ê¿ˆ'ì´ë¼ëŠ” ë‹¨ì–´ë¡œ
    t = t.replace(/\n+/g, " ì¤„ë°”ê¿ˆ ");
    // ë§ˆì¹¨í‘œëŠ” 'ë§ˆì¹¨í‘œ'ë¼ëŠ” ë‹¨ì–´ë¡œ
    t = t.replace(/\./g, " ë§ˆì¹¨í‘œ ");
    // ê³µë°±ì€ ê·¸ëŒ€ë¡œ ë‘”ë‹¤ (ë‹¨ì–´ ì‚¬ì´ ê³µë°±ì€ ì†ë„ë¡œë§Œ ëŠë¦¬ê²Œ)
    return t;
  }

  function speakInternal(text, options){
    if (!window.speechSynthesis) return;
    const opts = options || {};
    const rate = typeof opts.rate === "number" ? opts.rate : 0.9;
    const onend = typeof opts.onend === "function" ? opts.onend : null;
    const skipCancel = !!opts.skipCancel;

    try {
      const content = String(text || "");
      if (!content.trim()) return;

      if (!skipCancel) {
        window.speechSynthesis.cancel();
      }

      const u = new SpeechSynthesisUtterance(content);
      u.lang = "ko-KR";
      u.rate = rate;
      u.pitch = 1.0;
      if (ttsVoice) u.voice = ttsVoice;

      u.onend = function(){ if (onend) onend(); };
      u.onerror = function(){ if (onend) onend(); };

      window.speechSynthesis.speak(u);
    } catch(e){}
  }

  function primeTTS(){
    if (ttsReady) return;
    ttsReady = true;
    if (!window.speechSynthesis) {
      statusEl.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” TTSê°€ ì§€ì›ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.";
      return;
    }
    // ì¤€ë¹„ ë©˜íŠ¸ëŠ” ì •ìƒ ì†ë„ì— ê°€ê¹ê²Œ
    speakInternal("ìŒì„± ì¤€ë¹„ ì™„ë£Œ", { rate: 0.95 });
    window.speechSynthesis.cancel();
  }

  function speakStatus(text){
    if (!ttsReady) return;
    if (answerRepeating) return;
    speakInternal(text, { rate: 0.95 });
  }

  function speakAnswer(text, isRevision){
    if (!ttsReady) {
      statusEl.textContent += "\n(TTSê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•„ ìŒì„±ì´ ì¶œë ¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì†Œë¦¬ê°€ ì „í˜€ ì•ˆ ë“¤ë¦¬ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.)";
      return;
    }
    answerRepeating = true;

    const transformed = transformAnswerText(text);

    function playOnce(){
      // ë‹µì•ˆ ì½ê¸°: ëŠë¦¬ê²Œ ì½ë˜, ë‹¨ì–´ ì‚¬ì´ ê³µë°±ì€ ì†ë„ë¡œë§Œ ì¡°ì ˆ
      speakInternal(transformed, {
        rate: 0.5,
        onend: function(){
          if (answerRepeating) {
            setTimeout(playOnce, 1000);
          }
        }
      });
    }

    if (isRevision) {
      speakInternal("ì´ì „ ë‹µì•ˆì„ ìˆ˜ì •í•˜ê² ìŠµë‹ˆë‹¤. ë” ë‚˜ì€ ìµœì¢… ë‹µì•ˆì„ ì½ì–´ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.", {
        rate: 0.9,
        onend: function(){ setTimeout(playOnce, 500); }
      });
    } else {
      playOnce();
    }
  }

  function stopAnswerRepeat(){
    answerRepeating = false;
    if (window.speechSynthesis) {
      window.speechSynthesis.cancel();
    }
  }

  // ì²« ì‚¬ìš©ì í´ë¦­ ì‹œ TTS ì¤€ë¹„ + í™”ë©´ êº¼ì§ ë°©ì§€ ìš”ì²­
  document.addEventListener("click", function(){
    primeTTS();
    requestWakeLock();
  }, { once:true });

  async function requestWakeLock(){
    try {
      if (!("wakeLock" in navigator) || !navigator.wakeLock || !navigator.wakeLock.request) return;
      wakeLock = await navigator.wakeLock.request("screen");
      if (wakeLock && wakeLock.addEventListener) {
        wakeLock.addEventListener("release", function(){});
      }
    } catch(e){
      console.log("wakeLock error", e);
    }
  }

  // --------- ì¹´ë©”ë¼ ---------
  async function startCamera(){
    try {
      statusEl.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";
      stream = await navigator.mediaDevices.getUserMedia({
        video:{
          facingMode:{ ideal:"environment" },
          width:{ ideal:2560 },
          height:{ ideal:1440 }
        },
        audio:false
      });
      video.srcObject = stream;
      statusEl.textContent = "ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ. ì…”í„°ë¥¼ ëˆ„ë¥´ë©´ ì—°ì† ìë™ OCRì„ ì‹œì‘í•©ë‹ˆë‹¤.";
    } catch(e){
      statusEl.textContent = "ì¹´ë©”ë¼ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", String(e && e.message ? e.message : e));
    }
  }

  function captureDataUrl(){
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;
    const canvas = document.createElement("canvas");
    canvas.width = w;
    canvas.height = h;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, w, h);
    return canvas.toDataURL("image/jpeg", 0.9);
  }

  async function callOCR(dataUrl, pageIndex){
    if (!dataUrl) {
      return { ok:false, error:"NO_FRAME" };
    }
    try {
      const res = await fetch(OCR_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          imageBase64: dataUrl,
          pageIndex: pageIndex,
          mode: "dual"
        })
      });
      const json = await res.json().catch(function(){ return null; });
      return json || { ok:false, error:"NO_JSON" };
    } catch(e){
      return { ok:false, error:"FETCH_ERROR", message: e && e.message ? e.message : String(e) };
    }
  }

  function sleep(ms){
    return new Promise(function(resolve){ setTimeout(resolve, ms); });
  }

  // --------- í•œ í˜ì´ì§€(3íšŒ) ìë™ ì´¬ì˜ + ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ ---------
  async function shootOnePage(page){
    if (!autoRun || isShootingOne) {
      return { bestText:"", bestConf:-1, foundSolveCue:false };
    }

    isShootingOne = true;
    stopAnswerRepeat();

    let overallBestText = "";
    let overallBestConf = -1;
    let foundSolveCue = false;

    for (let attempt = 1; attempt <= MAX_RETRY_PER_PAGE && autoRun; attempt++) {
      let bestText = "";
      let bestConf = -1;

      statusEl.textContent =
        "í˜ì´ì§€ " + page + " ìë™ ì´¬ì˜ " + attempt + "ì°¨ ì‹œë„ ì‹œì‘ (ê° " +
        SHOTS_PER_PAGE + "íšŒ ì´¬ì˜)...";

      for (let i = 1; i <= SHOTS_PER_PAGE && autoRun; i++) {
        statusEl.textContent =
          "í˜ì´ì§€ " + page + " ì´¬ì˜ " + i + " / " + SHOTS_PER_PAGE +
          " (ì‹œë„ " + attempt + "/" + MAX_RETRY_PER_PAGE + ") ì§„í–‰ ì¤‘...";

        const dataUrl = captureDataUrl();
        if (!dataUrl) {
          statusEl.textContent = "ì˜ìƒ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. 1~2ì´ˆ í›„ ìë™ ì¬ì‹œë„...";
          await sleep(SHOT_INTERVAL_MS);
          continue;
        }

        const res = await callOCR(dataUrl, page);

        if (res && res.ok && res.text && String(res.text).trim()) {
          const txt  = String(res.text);
          const conf = typeof res.conf === "number" ? res.conf : 0;

          if (conf > bestConf) {
            bestConf = conf;
            bestText = txt;
          }
          if (conf > overallBestConf) {
            overallBestConf = conf;
            overallBestText = txt;
          }

          if (/ì´ì œ\s*í’€ì´ë¥¼\s*ì‹œì‘í•˜ì‹œì˜¤/.test(txt)) {
            foundSolveCue = true;
          }

          const confText = (conf && conf.toFixed) ? conf.toFixed(1) : String(conf);
          statusEl.textContent =
            "í˜ì´ì§€ " + page + " ì´¬ì˜ " + i + " / " + SHOTS_PER_PAGE +
            " ì™„ë£Œ (ì‹ ë¢°ë„ ëŒ€ëµ " + confText + "%, ì‹œë„ " + attempt + ")";
        } else {
          const msg = res && (res.message || res.error) ? (res.message || res.error) : "OCR ì‹¤íŒ¨";
          statusEl.textContent =
            "í˜ì´ì§€ " + page + " ì´¬ì˜ " + i + " / " + SHOTS_PER_PAGE +
            " ì‹¤íŒ¨: " + msg + " (ì‹œë„ " + attempt + ")";
        }

        if (i < SHOTS_PER_PAGE && autoRun) {
          await sleep(SHOT_INTERVAL_MS);
        }
      }

      // í˜„ì¬ attemptì—ì„œ ìœ ì˜ë¯¸í•œ í…ìŠ¤íŠ¸ê°€ ìƒê²¼ìœ¼ë©´ ì¶”ê°€ ì¬ì‹œë„ ì—†ì´ ì¢…ë£Œ
      if (bestText && bestText.trim()) {
        break;
      }

      // attempt ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„ ì•ˆë‚´
      if (attempt < MAX_RETRY_PER_PAGE && autoRun) {
        statusEl.textContent =
          "í˜ì´ì§€ " + page + "ì—ì„œ ì¸ì‹ëœ ë‚´ìš©ì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. ê°™ì€ í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ì´¬ì˜í•©ë‹ˆë‹¤ (" +
          (attempt + 1) + "ì°¨ ì‹œë„).";
        speakStatus("ì´ í˜ì´ì§€ ì¸ì‹ì´ ì˜ ë˜ì§€ ì•Šì•„ ìë™ìœ¼ë¡œ ë‹¤ì‹œ ì´¬ì˜í•©ë‹ˆë‹¤. " + (attempt + 1) + "ë²ˆì§¸ ì‹œë„ì…ë‹ˆë‹¤.");
        await sleep(2000);
      }
    }

    if (!autoRun) {
      isShootingOne = false;
      return { bestText: overallBestText, bestConf: overallBestConf, foundSolveCue };
    }

    if (!overallBestText || !overallBestText.trim()) {
      statusEl.textContent =
        "í˜ì´ì§€ " + page + "ì—ì„œ ì—¬ëŸ¬ ì°¨ë¡€ ì‹œë„í–ˆì§€ë§Œ ìœ íš¨í•œ OCR ê²°ê³¼ë¥¼ ì–»ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. " +
        "í•„ìš”í•˜ë©´ ì…”í„° ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆŒëŸ¬ ì´ í˜ì´ì§€ë¶€í„° ìë™ ì´¬ì˜ì„ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.";
      speakStatus("ì´ í˜ì´ì§€ëŠ” ì¸ì‹ì´ ì˜ ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìì„¸í•œ ì¬ì´¬ì˜ì´ í•„ìš”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
      isShootingOne = false;
      return { bestText:"", bestConf:-1, foundSolveCue:false };
    }

    const block =
      "\n\n[í˜ì´ì§€ " + page + "]-------------------\n" +
      overallBestText;
    ocrBox.value = (ocrBox.value || "") + block;

    const bestConfText =
      (overallBestConf >= 0 && overallBestConf.toFixed) ? overallBestConf.toFixed(1) : "0.0";
    statusEl.textContent =
      "í˜ì´ì§€ " + page + " OCR ì™„ë£Œ (ìµœê³  ì‹ ë¢°ë„ ëŒ€ëµ " + bestConfText + "%)";
    isShootingOne = false;

    return { bestText: overallBestText, bestConf: overallBestConf, foundSolveCue };
  }

  async function speakCountdownAndWait(){
    statusEl.textContent += "\n5 4 3 2 1. ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ê²¨ ì£¼ì„¸ìš”.";
    speakStatus("5 4 3 2 1. ë‹¤ìŒ í˜ì´ì§€ë¡œ ë„˜ê²¨ ì£¼ì„¸ìš”.");
    await sleep(5000);
  }

  // --------- ì—¬ëŸ¬ í˜ì´ì§€ ì—°ì† ìë™ OCR ---------
  async function runAutoPages(){
    while (autoRun && currentPage <= MAX_PAGE) {
      const result = await shootOnePage(currentPage);
      if (!autoRun) break;

      const hasText = result.bestText && result.bestText.trim();

      if (!hasText) {
        // ì´ í˜ì´ì§€ì—ì„œ ëê¹Œì§€ ì‹¤íŒ¨í•œ ê²½ìš° ìë™ ì´¬ì˜ ì¤‘ë‹¨
        autoRun = false;
        btnShutter.textContent = "ğŸ“¸ ì…”í„°(ì—°ì† ìë™ OCR ì‹œì‘)";
        break;
      }

      if (result.foundSolveCue) {
        statusEl.textContent += "\në§ˆì§€ë§‰ í˜ì´ì§€ë¡œ ì¸ì‹ë˜ì–´ ìë™ìœ¼ë¡œ í’€ì´ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤.";
        await doSolve(true);
        autoRun = false;
        break;
      }

      await speakCountdownAndWait();

      currentPage++;
      if (currentPage > MAX_PAGE) {
        autoRun = false;
        break;
      }
      pageSel.value = String(currentPage);
    }

    autoRun = false;
    btnShutter.textContent = "ğŸ“¸ ì…”í„°(ì—°ì† ìë™ OCR ì‹œì‘)";
  }

  // --------- í’€ì´ ìš”ì²­ ---------
  async function doSolve(isAuto){
    primeTTS();

    const text = (ocrBox.value || "").trim();
    if (!text) {
      statusEl.textContent = "ë¨¼ì € ì…”í„°ë¡œ OCRì„ ìŒ“ì•„ì£¼ì„¸ìš”.";
      speakStatus("ë¨¼ì € ì˜¤ì”¨ì•Œì„ ì§„í–‰í•˜ì„¸ìš”.");
      return;
    }

    statusEl.textContent = isAuto ? "ìë™ìœ¼ë¡œ AI í’€ì´ë¥¼ ìš”ì²­ ì¤‘..." : "AI í’€ì´ ìš”ì²­ ì¤‘...";
    try {
      const res = await fetch(SOLVE_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          text: text,
          targetChars: 1000,
          tolerance: 120,
          mode: "deep"
        })
      });

      const json = await res.json().catch(function(){ return null; });
      if (!json || !json.ok) {
        const msg = json && (json.message || json.error) ? (json.message || json.error) : "solve ì‹¤íŒ¨";
        statusEl.textContent =
          "í’€ì´ ì‹¤íŒ¨: " + msg +
          "\n(TTSê°€ ì „í˜€ ë“¤ë¦¬ì§€ ì•Šìœ¼ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.)";
        speakStatus("í’€ì´ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê°™ì€ ì§€ë¬¸ìœ¼ë¡œ ë‹¤ì‹œ í’€ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const answer = (json.answer || "").trim();
      if (!answer) {
        statusEl.textContent =
          "í’€ì´ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.\n(TTSê°€ ì „í˜€ ë“¤ë¦¬ì§€ ì•Šìœ¼ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.)";
        speakStatus("í’€ì´ ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤. ê°™ì€ ì§€ë¬¸ìœ¼ë¡œ ë‹¤ì‹œ í’€ê¸° ë²„íŠ¼ì„ ëˆŒëŸ¬ ì¬ì‹œë„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        return;
      }

      const isRevision = !!lastAnswerRaw && lastAnswerRaw !== answer;
      lastAnswerRaw = answer;

      answerBox.value = answer;
      statusEl.textContent =
        "í’€ì´ ì™„ë£Œ. (ì¤„ë°”ê¿ˆê³¼ ë§ˆì¹¨í‘œë¥¼ ë§ë¡œ í‘œì‹œí•˜ë©°, ë§¤ìš° ëŠë¦° ì†ë„ë¡œ ì›ë¬¸ì„ ë°˜ë³µ ë‚­ë… ì¤‘)\n" +
        "TTS ì†Œë¦¬ê°€ ì „í˜€ ì•ˆ ë“¤ë¦¬ë©´, í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ ë’¤ ë‹¤ì‹œ í•œ ë²ˆ í™”ë©´ì„ í„°ì¹˜í•´ì„œ TTSë¥¼ ì¤€ë¹„í•˜ì„¸ìš”.";

      speakAnswer(answer, isRevision);
    } catch(e){
      statusEl.textContent =
        "í’€ì´ ìš”ì²­ ì‹¤íŒ¨: " + (e.message || String(e)) +
        "\n(TTSê°€ ì „í˜€ ë“¤ë¦¬ì§€ ì•Šìœ¼ë©´ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•œ ë’¤ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.)";
      showErrorOverlay("solve ìš”ì²­ ì‹¤íŒ¨", String(e && e.stack ? e.stack : e));
    }
  }

  // --------- ë²„íŠ¼ í•¸ë“¤ëŸ¬ ---------
  btnShutter.addEventListener("click", function(){
    if (!autoRun) {
      autoRun = true;
      currentPage = Number(pageSel.value || "1") || 1;
      btnShutter.textContent = "â¹ ìë™ OCR ì¤‘ë‹¨";
      statusEl.textContent =
        "í˜ì´ì§€ " + currentPage + "ë¶€í„° ì—°ì† ìë™ OCRì„ ì‹œì‘í•©ë‹ˆë‹¤.\n" +
        "ìë™ ì´¬ì˜ì„ ë©ˆì¶”ê³  ì‹¶ìœ¼ë©´ ì…”í„° ë²„íŠ¼ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”.";
      speakStatus("í˜ì´ì§€ " + currentPage + "ë¶€í„° ìë™ ì´¬ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
      runAutoPages();
    } else {
      autoRun = false;
      statusEl.textContent += "\nìë™ OCRì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.";
      speakStatus("ìë™ ì´¬ì˜ì„ ì¤‘ë‹¨í–ˆìŠµë‹ˆë‹¤.");
      btnShutter.textContent = "ğŸ“¸ ì…”í„°(ì—°ì† ìë™ OCR ì‹œì‘)";
    }
  });

  btnSolve.addEventListener("click", function(){
    autoRun = false;
    btnShutter.textContent = "ğŸ“¸ ì…”í„°(ì—°ì† ìë™ OCR ì‹œì‘)";
    doSolve(false);
  });

  // ì´ˆê¸° ì¹´ë©”ë¼ ì‹œì‘
  startCamera();
})();
</script>
</body>
</html>

