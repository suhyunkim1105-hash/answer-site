<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const shutterBtn = document.getElementById("shutter");
  const solveBtn = document.getElementById("solve");
  const statusEl = document.getElementById("status");
  const ocrResultEl = document.getElementById("ocrResult");
  const answerResultEl = document.getElementById("answerResult");

  let currentPage = 1;
  const maxPages = 10; // 필요하면 조절

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false,
      });
      video.srcObject = stream;
      await video.play();
      statusEl.textContent = "카메라 준비 완료";
    } catch (e) {
      statusEl.textContent = "카메라 시작 실패: " + e.message;
      console.error(e);
    }
  }

  async function captureAndOcr() {
    if (!video.videoWidth || !video.videoHeight) {
      statusEl.textContent =
        "영상 준비 중입니다. 1~2초 뒤에 다시 시도하세요.";
      return;
    }

    // 현재 프레임을 캔버스에 그리기
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // base64 JPEG 생성
    const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

    statusEl.textContent = `페이지 ${currentPage} OCR 요청 중...`;

    try {
      const res = await fetch("/.netlify/functions/ocr", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          imageBase64: dataUrl,
          pageIndex: currentPage,
        }),
      });

      const json = await res.json().catch(() => null);

      if (!json || !json.ok) {
        const msg =
          (json && (json.message || json.error)) ||
          res.statusText ||
          "알 수 없는 오류";

        const failPage =
          json && typeof json.pageIndex === "number"
            ? json.pageIndex
            : currentPage;

        statusEl.textContent = `페이지 ${failPage} OCR 실패: ${msg}`;
        console.error("OCR error detail:", json);
        return;
      }

      // pageIndex 없으면 currentPage로 대체
      const pageLabel =
        json && typeof json.pageIndex === "number"
          ? json.pageIndex
          : currentPage;

      const text = json.text || json.ocrText || "";

      const prev = ocrResultEl.value || "";
      ocrResultEl.value =
        prev +
        `\n\n[페이지 ${pageLabel}]-------------------\n` +
        text;

      statusEl.textContent = `페이지 ${pageLabel} OCR 완료`;

      if (currentPage < maxPages) {
        currentPage += 1;
      }
    } catch (e) {
      statusEl.textContent = "요청 실패: " + e.message;
      console.error(e);
    }
  }

  async function solveNow() {
    const text = (ocrResultEl.value || "").trim();
    if (!text) {
      statusEl.textContent = "먼저 OCR을 완료해주세요.";
      return;
    }

    statusEl.textContent = "AI 풀이 요청 중...";

    try {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text }),
      });

      const json = await res.json().catch(() => null);

      if (!json || !json.ok) {
        const msg =
          (json && (json.message || json.error)) ||
          res.statusText ||
          "알 수 없는 오류";
        statusEl.textContent = "풀이 실패: " + msg;
        console.error("solve error detail:", json);
        return;
      }

      const answer = json.answer || json.result || "";
      answerResultEl.value = answer;
      statusEl.textContent = "풀이 완료";
    } catch (e) {
      statusEl.textContent = "풀이 요청 실패: " + e.message;
      console.error(e);
    }
  }

  shutterBtn.addEventListener("click", captureAndOcr);
  solveBtn.addEventListener("click", solveNow);

  window.addEventListener("load", startCamera);
</script>
