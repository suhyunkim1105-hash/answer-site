<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>autononsul - OCR + ë³µë¶™ + TTS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>

  <style>
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin:0; padding:12px;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:#0b0b0b; color:#fff;
      -webkit-text-size-adjust: 100%;
      touch-action: manipulation;
    }
    h1 { font-size:16px; margin:0 0 10px; }
    #status {
      font-size:12px; color:#c4f1ff;
      white-space:pre-wrap;
      padding:8px; border:1px solid #333;
      border-radius:10px; background:#070707;
      line-height: 1.35;
    }
    #videoBox {
      margin-top:10px; border:1px solid #333;
      border-radius:10px; overflow:hidden;
      background:#000;
    }
    video { width:100%; height:auto; display:block; }

    .row { display:flex; gap:8px; margin-top:10px; }
    button {
      flex:1;
      padding:10px 12px;
      font-size:14px;
      border-radius:10px;
      border:1px solid #555;
      background:#151515;
      color:#fff;
    }
    button:active { transform: scale(0.98); }
    button:disabled { opacity:0.45; }

    textarea {
      width:100%; min-height:140px;
      margin-top:8px; padding:10px;
      border-radius:10px;
      border:1px solid #333;
      background:#060606; color:#fff;
      font-size:12px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
      line-height: 1.35;
    }

    .hint { font-size:11px; color:#aaa; margin-top:6px; line-height: 1.4; }
    .sectionTitle { margin-top:14px; font-size:13px; font-weight:600; }

    #shotPreviewBox {
      margin-top:8px;
      border:1px dashed #444;
      border-radius:10px;
      padding:8px;
      font-size:11px;
      color:#aaa;
    }
    #shotPreview {
      width:100%;
      border-radius:8px;
      margin-top:8px;
      display:none;
      background:#000;
    }

    #errOverlay {
      position:fixed; inset:0; background:rgba(0,0,0,0.92); color:#fff;
      padding:14px; display:none; z-index:9999; overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      white-space:pre-wrap;
    }
    #errOverlay button { margin-top:10px; width:auto; }

    .pill {
      display:inline-block;
      padding:2px 8px;
      border:1px solid #444;
      border-radius:999px;
      font-size:11px;
      color:#ddd;
      background:#111;
      margin-left:6px;
    }

    .miniNote {
      font-size: 11px;
      color: #9aa;
      margin-top: 6px;
    }
  </style>
</head>

<body>
  <div id="errOverlay"></div>

  <h1>ì—°ì„¸ëŒ€ ë…¼ìˆ  OCR â†’ ë³µë¶™ â†’ TTS</h1>
  <div id="status">
    ë¡œë”©ë¨. ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...
  </div>

  <div class="hint">
    1) <b>ì´¬ì˜ + OCR</b> ëˆŒëŸ¬ì„œ í•œ ì¥ ì¸ì‹ (ìë™ OCR 3íšŒ)<br/>
    2) OCR ì‹ ë¢°ë„ì™€ í…ìŠ¤íŠ¸ì—ì„œ <b>ë¬¸ì œ + "ì´ì œ í’€ì´ë¥¼ ì‹œì‘í•˜ì‹œì˜¤"</b>ê°€ ì¡íˆë©´<br/>
       ìŒì„±ìœ¼ë¡œ <b>"ì´ í˜ì´ì§€ ì¸ì‹ ì™„ë£Œ, ë‹¤ìŒ ì¥ìœ¼ë¡œ ë„˜ê¸°ì„¸ìš”"</b> ì•ˆë‚´<br/>
    3) ëª¨ë“  ì¥ ëë‚˜ë©´ <b>OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬</b> â†’ ChatGPT 5.2 ë°©ì— ë¶™ì—¬ë„£ê¸° + ì‚¬ì§„ ì²¨ë¶€<br/>
    4) ë‹µì•ˆ ë°›ìœ¼ë©´ ì•„ë˜ ë°•ìŠ¤ì— ë¶™ì—¬ë„£ê¸° â†’ <b>TTSë¡œ ê³„ì† ë°˜ë³µ ì¬ìƒ</b><br/>
    â€» <b>TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼</b>
  </div>

  <div id="videoBox">
    <video id="video" autoplay playsinline muted></video>
  </div>

  <div id="shotPreviewBox">
    ìµœê·¼ ì´¬ì˜ ë¯¸ë¦¬ë³´ê¸° (ì‚¬ì§„ì€ ì—¬ê¸°ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬/ì €ì¥ â†’ ChatGPTì— ì²¨ë¶€)
    <span class="pill" id="shotMeta">ìƒ· ì—†ìŒ</span>
    <img id="shotPreview" alt="ìµœê·¼ ì´¬ì˜ ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°"/>
    <div class="miniNote">
      â€» ê° ì¥ë§ˆë‹¤ <b>ì´¬ì˜ + OCR</b> 1ë²ˆ â†’ ì™„ë£Œ ìŒì„± ë‚˜ì˜¤ë©´ ë‹¤ìŒ ì¥ìœ¼ë¡œ.
    </div>
  </div>

  <div class="row">
    <button id="btnCapture">ğŸ“¸ ì´¬ì˜ + OCR (ìë™ 3íšŒ)</button>
  </div>

  <div class="row">
    <button id="btnCopyAll">ğŸ“‹ OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬</button>
    <button id="btnClearOcr">ğŸ§¹ OCR í…ìŠ¤íŠ¸ ì§€ìš°ê¸°</button>
  </div>

  <div class="sectionTitle">â‘  OCR ëˆ„ì  í…ìŠ¤íŠ¸</div>
  <textarea id="ocrBox" placeholder="ì´¬ì˜ + OCRì„ ëˆ„ë¥´ë©´ ì—¬ê¸°ì— [ìƒ· 1], [ìƒ· 2]... ìˆœì„œëŒ€ë¡œ ëˆ„ì ë©ë‹ˆë‹¤."></textarea>

  <div class="sectionTitle">â‘¡ ë‹µì•ˆ(TTSìš©) ë°•ìŠ¤ (ChatGPT ë‹µì•ˆì„ ì—¬ê¸° ë¶™ì—¬ë„£ê¸°)</div>
  <textarea id="ttsInput" placeholder="[ë¬¸ì œ 1] ... [ë¬¸ì œ 2] ... ë‹µì•ˆì„ ì—¬ê¸° ë¶™ì—¬ë„£ìœ¼ë©´, 'ì½ê¸° ì‹œì‘'ìœ¼ë¡œ ê³„ì† ë°˜ë³µí•´ì„œ ì½ì–´ ì¤ë‹ˆë‹¤."></textarea>

  <div class="row">
    <button id="btnTtsStart">ğŸ”Š ì½ê¸° ì‹œì‘(ë°˜ë³µ)</button>
    <button id="btnTtsStop">â¹ ì½ê¸° ì •ì§€</button>
  </div>

  <div class="hint">
    - TTSëŠ” <b>1ë°°ì†</b>ìœ¼ë¡œ ì½ê³ , ë‹¨ì–´ ì‚¬ì´ì— <b>ì•½ 6ì´ˆ ì¹¨ë¬µ</b> ê°„ê²©ì„ ë‘”ë‹¤.<br/>
    - ì¤„ë°”ê¿ˆì€ <b>"ì¤„ë°”ê¿ˆ"</b>, ë§ˆì¹¨í‘œëŠ” <b>"ë§ˆì¹¨í‘œ"</b>ë¼ê³  ì½ëŠ”ë‹¤. ë„ì–´ì“°ê¸°ëŠ” ë§í•˜ì§€ ì•ŠëŠ”ë‹¤(ì¹¨ë¬µë§Œ).<br/>
    - ë‹µì•ˆ ì „ì²´ë¥¼ ë‹¤ ì½ê³  ë‚˜ë©´, <b>ì ì‹œ ì‰¬ì—ˆë‹¤ê°€ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë°˜ë³µ</b>í•œë‹¤.<br/>
    - ì•± ì „í™˜ í›„ ëŒì•„ì™”ëŠ”ë° TTSê°€ ì•ˆ ë“¤ë¦¬ë©´: <b>'ì½ê¸° ì‹œì‘' ë‹¤ì‹œ ëˆ„ë¥´ê³ </b>, ê·¸ë˜ë„ ì•ˆ ë˜ë©´ <b>ìƒˆë¡œê³ ì¹¨</b>.<br/>
    - <b>TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼</b>
  </div>

<script>
(function(){
  const statusEl = document.getElementById("status");
  const video = document.getElementById("video");
  const btnCapture = document.getElementById("btnCapture");
  const btnCopyAll = document.getElementById("btnCopyAll");
  const btnClearOcr = document.getElementById("btnClearOcr");
  const ocrBox = document.getElementById("ocrBox");
  const ttsInput = document.getElementById("ttsInput");
  const btnTtsStart = document.getElementById("btnTtsStart");
  const btnTtsStop = document.getElementById("btnTtsStop");
  const errOverlay = document.getElementById("errOverlay");
  const shotPreview = document.getElementById("shotPreview");
  const shotMeta = document.getElementById("shotMeta");

  const OCR_URL = "/.netlify/functions/ocr";

  // ìº¡ì²˜ í•´ìƒë„/í’ˆì§ˆ (ì†ë„+ì •í™•ë„ íƒ€í˜‘)
  const CAP_MAX_W = 1600;
  const JPEG_QUALITY = 0.86;

  // OCR ë°˜ë³µ íšŸìˆ˜ (í•„ìš”í•˜ë©´ 5ë¡œ ì˜¬ë ¤ë„ ë¨)
  const OCR_ATTEMPTS = 3;

  // "ì™„ë£Œ" íŒë‹¨ ê¸°ì¤€
  const DONE_CONF_THRESHOLD = 70;  // MeanConfidenceLevel (ëŒ€ëµê°’)
  const DONE_LEN_THRESHOLD = 400;  // ë„ˆë¬´ ì§§ì€ í…ìŠ¤íŠ¸ ì œì™¸ìš©(ëŒ€ëµ)

  // TTS ì„¤ì •
  let ttsPrimed = false;
  let ttsActive = false;
  let ttsStopRequested = false;
  let ttsTokens = [];
  let ttsIndex = 0;

  const WORD_GAP_MS = 6000;   // ë‹¨ì–´ ê°„ ì¹¨ë¬µ 6ì´ˆ
  const LOOP_GAP_MS = 7000;   // í•œ ë°”í€´ ëë‚œ í›„ ì‰¬ëŠ” ì‹œê°„
  const RATE = 1.0;           // 1ë°°ì†

  let selectedVoice = null;

  // ---- ì—ëŸ¬ ì˜¤ë²„ë ˆì´
  function showErrorOverlay(title, detail){
    try{
      errOverlay.style.display = "block";
      errOverlay.textContent = `[ERROR]\n${title}\n\n${detail || ""}\n\n(ì•„ë˜ ë²„íŠ¼ ëˆ„ë¥´ë©´ ë‹«í˜)`;
      const btn = document.createElement("button");
      btn.textContent = "ë‹«ê¸°";
      btn.onclick = () => { errOverlay.style.display = "none"; errOverlay.innerHTML = ""; };
      errOverlay.appendChild(document.createElement("br"));
      errOverlay.appendChild(btn);
    }catch(e){}
  }

  window.addEventListener("error", (e) => {
    showErrorOverlay(e.message || "Unknown JS error", (e.error && e.error.stack) ? e.error.stack : "");
  });

  window.addEventListener("unhandledrejection", (e) => {
    const msg = (e && e.reason) ? (e.reason.message || String(e.reason)) : "Unhandled rejection";
    const stack = (e && e.reason && e.reason.stack) ? e.reason.stack : "";
    showErrorOverlay(msg, stack);
  });

  // ---- ì¹´ë©”ë¼ ì‹œì‘
  let stream = null;
  async function startCamera(){
    try{
      statusEl.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ ì¤‘...";
      stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: { ideal: "environment" },
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        },
        audio: false
      });
      video.srcObject = stream;
      statusEl.textContent =
        "ì¹´ë©”ë¼ ì¤€ë¹„ ì™„ë£Œ. í•œ ì¥ì´ ê½‰ ì°¨ê²Œ ë³´ì´ë„ë¡ ë§ì¶˜ ë’¤ 'ì´¬ì˜ + OCR'ì„ ëˆ„ë¥´ì„¸ìš”.\n" +
        "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
    }catch(e){
      statusEl.textContent = "ì¹´ë©”ë¼ ì‹¤íŒ¨: " + (e.message || String(e));
      showErrorOverlay("ì¹´ë©”ë¼ ì‹œì‘ ì‹¤íŒ¨", String(e && e.message ? e.message : e));
    }
  }

  // ---- ìº¡ì²˜(dataURL) - ë¦¬ì‚¬ì´ì¦ˆ + JPEG ì••ì¶•
  function captureDataUrlOptimized(){
    const w = video.videoWidth;
    const h = video.videoHeight;
    if (!w || !h) return null;

    let outW = w;
    let outH = h;

    if (w > CAP_MAX_W){
      const ratio = CAP_MAX_W / w;
      outW = Math.round(w * ratio);
      outH = Math.round(h * ratio);
    }

    const canvas = document.createElement("canvas");
    canvas.width = outW;
    canvas.height = outH;
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(video, 0, 0, outW, outH);

    return canvas.toDataURL("image/jpeg", JPEG_QUALITY);
  }

  // ---- OCR 1íšŒ í˜¸ì¶œ
  async function callOcrOnce(dataUrl){
    try{
      const res = await fetch(OCR_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          imageBase64: dataUrl,
          mode: "dual" // í•­ìƒ í•œê¸€+ì˜ì–´
        })
      });

      const json = await res.json().catch(() => null);
      if (!json || !json.ok){
        const msg = (json && (json.message || json.error)) || "OCR ì‹¤íŒ¨";
        return { ok:false, msg, text:"", conf:0 };
      }

      const text = (json.text || "").trim();
      const conf = (typeof json.conf === "number") ? json.conf : 0;
      if (!text){
        return { ok:false, msg:"OCR ê²°ê³¼ê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.", text:"", conf };
      }

      return { ok:true, text, conf };
    }catch(e){
      return { ok:false, msg:(e.message || String(e)), text:"", conf:0 };
    }
  }

  function pickBest(best, cand){
    if (!cand || !cand.ok) return best;
    if (!best || !best.ok) return cand;
    if ((cand.conf || 0) > (best.conf || 0)) return cand;
    if ((cand.conf || 0) === (best.conf || 0)){
      if ((cand.text || "").length > (best.text || "").length) return cand;
    }
    return best;
  }

  // ---- "ì™„ë£Œ" ì—¬ë¶€ íŒë‹¨
  function isDonePage(text, conf){
    if (!text) return false;
    if (typeof conf !== "number" || conf < DONE_CONF_THRESHOLD) return false;

    const norm = text.replace(/\s/g, "");
    const hasMunje = norm.includes("ë¬¸ì œ");
    const hasStart =
      norm.includes("ì´ì œí’€ì´ë¥¼ì‹œì‘í•˜ì‹œì˜¤") ||
      norm.includes("ì´ì œí’€ì´ë¥¼ì‹œì‘í•˜ì‹­ì‹œì˜¤");

    if (!hasMunje || !hasStart) return false;

    if (text.length < DONE_LEN_THRESHOLD) return false;

    return true;
  }

  // ---- TTS ê³µí†µ: í•œêµ­ì–´ ìŒì„± ì„ íƒ
  function selectKoreanVoice(){
    try{
      const voices = window.speechSynthesis ? window.speechSynthesis.getVoices() : [];
      if (!voices || !voices.length) return null;

      const ko = voices.filter(v => (v.lang || "").toLowerCase().startsWith("ko"));
      if (!ko.length) return null;

      const preferNames = ["Yuna", "ìœ ë‚˜", "Korean", "Seoyeon", "ì„œì—°"];
      for (const name of preferNames){
        const found = ko.find(v => (v.name || "").includes(name));
        if (found) return found;
      }

      const local = ko.find(v => v.localService);
      if (local) return local;

      return ko[0];
    }catch(e){
      return null;
    }
  }

  function primeTTSOnce(){
    if (ttsPrimed) return;
    ttsPrimed = true;

    try{
      selectedVoice = selectKoreanVoice();
      if (window.speechSynthesis){
        window.speechSynthesis.onvoiceschanged = () => {
          selectedVoice = selectKoreanVoice();
        };
      }

      const u = new SpeechSynthesisUtterance("ìŒì„± ì—°ê²°");
      u.lang = "ko-KR";
      u.rate = 1.0;
      if (selectedVoice) u.voice = selectedVoice;
      u.onend = () => { try{ window.speechSynthesis.cancel(); }catch(e){} };
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // ---- ì§§ì€ ì•ˆë‚´ ìŒì„± (OCR ì™„ë£Œ/ì¬ì´¬ì˜ ì•ˆë‚´ìš©)
  function speakNotice(text){
    if (!window.speechSynthesis) return;
    if (!text) return;

    // ë‹µì•ˆ TTSê°€ ëŒê³  ìˆìœ¼ë©´ ë°©í•´í•˜ì§€ ì•ŠìŒ
    if (ttsActive) return;

    try{
      primeTTSOnce();
      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      u.rate = 1.0;
      u.pitch = 1.0;
      if (selectedVoice) u.voice = selectedVoice;
      window.speechSynthesis.speak(u);
    }catch(e){}
  }

  // ---- ì´¬ì˜ + OCR
  let shotCount = 0;
  let lastShotDataUrl = null;

  async function captureAndOcr(){
    const dataUrl = captureDataUrlOptimized();
    if (!dataUrl){
      statusEl.textContent = "ì˜ìƒ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. 1~2ì´ˆ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      return;
    }

    btnCapture.disabled = true;

    shotCount += 1;
    lastShotDataUrl = dataUrl;

    try{
      shotPreview.src = dataUrl;
      shotPreview.style.display = "block";
      shotMeta.textContent = `ìƒ· ${shotCount}`;
    }catch(e){}

    statusEl.textContent = `ìƒ· ${shotCount}: ì´¬ì˜ ì™„ë£Œ. OCR ìë™ ${OCR_ATTEMPTS}íšŒ ì§„í–‰ ì¤‘...\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;

    let best = null;
    let lastErr = "";

    for (let attempt = 1; attempt <= OCR_ATTEMPTS; attempt++){
      statusEl.textContent =
        `ìƒ· ${shotCount}: OCR ${attempt}íšŒì°¨ ì²˜ë¦¬ ì¤‘...\n` +
        `â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;
      const r = await callOcrOnce(dataUrl);
      if (!r.ok) lastErr = r.msg || lastErr;
      best = pickBest(best, r);
    }

    if (!best || !best.ok){
      statusEl.textContent =
        `ìƒ· ${shotCount}: OCR ${OCR_ATTEMPTS}íšŒ ëª¨ë‘ ì‹¤íŒ¨.\n` +
        `ì¡°ëª…/ê±°ë¦¬/ì´ˆì  ë‹¤ì‹œ ë§ì¶”ê³  ë‹¤ì‹œ 'ì´¬ì˜ + OCR'ì„ ëˆ„ë¥´ì„¸ìš”.\n` +
        `ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastErr || "ì •ë³´ ì—†ìŒ"}\n` +
        `â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;
      btnCapture.disabled = false;
      speakNotice("ì˜¤ ì”¨ ì•Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì´¬ì˜í•˜ì„¸ìš”.");
      return;
    }

    const text = best.text || "";
    const confValue = (typeof best.conf === "number") ? best.conf : 0;
    const confStr = confValue ? confValue.toFixed(1) + "%" : "ì •ë³´ ì—†ìŒ";
    const lengthStr = text.length;

    const header = `\n\n[ìƒ· ${shotCount}] ---------------------- (ì‹ ë¢°ë„ ëŒ€ëµ ${confStr}, ê¸¸ì´ ${lengthStr}ì)\n`;
    ocrBox.value = (ocrBox.value || "") + header + text + "\n";

    const done = isDonePage(text, confValue);

    if (done){
      statusEl.textContent =
        `ìƒ· ${shotCount}: OCR ì„±ê³µ(ì‹ ë¢°ë„ ëŒ€ëµ ${confStr}, ê¸¸ì´ ${lengthStr}ì).\n` +
        `í…ìŠ¤íŠ¸ì—ì„œ 'ë¬¸ì œ'ì™€ 'ì´ì œ í’€ì´ë¥¼ ì‹œì‘í•˜ì‹œì˜¤' ë¬¸êµ¬ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.\n` +
        `â†’ ì´ í˜ì´ì§€ ì¸ì‹ ì™„ë£Œ. ë‹¤ìŒ ì¥ìœ¼ë¡œ ë„˜ê¸°ì„¸ìš”.\n` +
        `â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;
      speakNotice("ì´ í˜ì´ì§€ ì¸ì‹ ì™„ë£Œ. ë‹¤ìŒ ì¥ìœ¼ë¡œ ë„˜ê¸°ì„¸ìš”.");
    }else{
      statusEl.textContent =
        `ìƒ· ${shotCount}: OCR ì„±ê³µ(ì‹ ë¢°ë„ ëŒ€ëµ ${confStr}, ê¸¸ì´ ${lengthStr}ì).\n` +
        `ë‹¤ë§Œ 'ë¬¸ì œ' ë˜ëŠ” 'ì´ì œ í’€ì´ë¥¼ ì‹œì‘í•˜ì‹œì˜¤' ë¬¸êµ¬ê°€ ì™„ì „íˆ ì¡íˆì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n` +
        `â†’ í•„ìš”í•˜ë©´ ì´ ì¥ì„ í•œ ë²ˆ ë” ì´¬ì˜í•˜ì„¸ìš”.\n` +
        `â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼`;
      speakNotice("ì¸ì‹ì€ ë˜ì—ˆì§€ë§Œ ì™„ì „íˆ ëë‚œ í˜ì´ì§€ë¡œ ë³´ì´ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìš”í•˜ë©´ ë‹¤ì‹œ ì´¬ì˜í•˜ì„¸ìš”.");
    }

    btnCapture.disabled = false;
  }

  // ---- OCR ì „ì²´ í…ìŠ¤íŠ¸ ë³µì‚¬
  function buildSharePayload(text){
    return (
`[OCR ì´ë¯¸ì§€/í…ìŠ¤íŠ¸ ì„¸íŠ¸]

- ì•„ë˜ OCR í…ìŠ¤íŠ¸ëŠ” ì‹œí—˜ì§€ì—ì„œ ì¶”ì¶œë¨
- ì‚¬ì§„ì€ ì‚¬ì´íŠ¸ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ë³µì‚¬/ì €ì¥ í›„ ChatGPTì— ì²¨ë¶€

[OCR TEXT START]
${text}
[OCR TEXT END]
`
    );
  }

  async function copyAllText(){
    const text = (ocrBox.value || "").trim();
    if (!text){
      statusEl.textContent = "ë³µì‚¬í•  OCR í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      return;
    }
    const payload = buildSharePayload(text);

    try{
      if (navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(payload);
        statusEl.textContent =
          "OCR í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í–ˆìŠµë‹ˆë‹¤. ChatGPTì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.\n" +
          "ì‚¬ì§„ì€ ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ê¸¸ê²Œ ëˆŒëŸ¬ ì €ì¥/ë³µì‚¬í•œ ë’¤ ChatGPTì— ì²¨ë¶€.\n" +
          "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      }else{
        const tmp = document.createElement("textarea");
        tmp.value = payload;
        tmp.style.position = "fixed";
        tmp.style.left = "-9999px";
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        document.body.removeChild(tmp);
        statusEl.textContent =
          "ë³µì‚¬ ì‹œë„ ì™„ë£Œ. ë¶™ì—¬ë„£ê¸° ì•ˆ ë˜ë©´ ì „ì²´ì„ íƒ í›„ ë³µì‚¬í•˜ì„¸ìš”.\n" +
          "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      }
    }catch(e){
      statusEl.textContent =
        "ë³µì‚¬ ì‹¤íŒ¨: " + (e.message || String(e)) + "\n" +
        "â€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      showErrorOverlay("í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨", String(e && e.stack ? e.stack : e));
    }
  }

  function clearOcr(){
    if (!confirm("OCR ëˆ„ì  í…ìŠ¤íŠ¸ë¥¼ ëª¨ë‘ ì§€ìš°ê² ìŠµë‹ˆê¹Œ?")) return;
    ocrBox.value = "";
    statusEl.textContent = "OCR í…ìŠ¤íŠ¸ë¥¼ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
  }

  // ---- TTS(ë‹µì•ˆ ë°˜ë³µ ì½ê¸°)

  function buildTokens(text){
    let t = String(text || "");
    t = t.replace(/\r/g, "");
    t = t.replace(/\./g, " ë§ˆì¹¨í‘œ ");
    const lines = t.split(/\n+/).map(x => x.trim()).filter(Boolean);

    const out = [];
    for (let i = 0; i < lines.length; i++){
      if (i > 0) out.push("ì¤„ë°”ê¿ˆ");
      const words = lines[i].split(/\s+/).filter(Boolean);
      for (const w of words) out.push(w);
    }
    return out;
  }

  function speakNext(){
    if (!ttsActive || ttsStopRequested) return;
    if (!ttsTokens.length){
      ttsActive = false;
      return;
    }

    const token = ttsTokens[ttsIndex];

    const u = new SpeechSynthesisUtterance(token);
    u.lang = "ko-KR";
    u.rate = RATE;
    u.pitch = 1.0;
    if (selectedVoice) u.voice = selectedVoice;

    u.onend = () => {
      if (ttsStopRequested) return;

      ttsIndex++;
      if (ttsIndex >= ttsTokens.length){
        ttsIndex = 0;
        setTimeout(() => {
          if (!ttsActive || ttsStopRequested) return;
          speakNext();
        }, LOOP_GAP_MS);
      }else{
        setTimeout(() => {
          if (!ttsActive || ttsStopRequested) return;
          speakNext();
        }, WORD_GAP_MS);
      }
    };

    u.onerror = () => {
      if (ttsStopRequested) return;
      setTimeout(() => {
        if (!ttsActive || ttsStopRequested) return;
        ttsIndex = Math.min(ttsIndex + 1, ttsTokens.length - 1);
        speakNext();
      }, WORD_GAP_MS);
    };

    try{
      window.speechSynthesis.speak(u);
    }catch(e){
      statusEl.textContent =
        "TTS ì˜¤ë¥˜: " + (e.message || String(e)) + "\n" +
        "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
    }
  }

  function startTts(){
    if (!window.speechSynthesis){
      statusEl.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” TTSë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    const text = (ttsInput.value || "").trim();
    if (!text){
      statusEl.textContent = "TTS ë°•ìŠ¤ì— ë‹µì•ˆì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      return;
    }

    primeTTSOnce();

    ttsStopRequested = false;
    ttsActive = false;
    try{ window.speechSynthesis.cancel(); }catch(e){}

    selectedVoice = selectKoreanVoice() || selectedVoice;

    ttsTokens = buildTokens(text);
    if (!ttsTokens.length){
      statusEl.textContent = "ì½ì„ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
      return;
    }

    ttsIndex = 0;
    ttsActive = true;

    statusEl.textContent =
      "TTS ì‹œì‘: 1ë°°ì† + ë‹¨ì–´ ê°„ ì•½ 6ì´ˆ ì¹¨ë¬µ + ë°˜ë³µ.\n" +
      "ì•± ì „í™˜ í›„ ë¬´ìŒì´ë©´ 'ì½ê¸° ì‹œì‘' ë‹¤ì‹œ ëˆ„ë¥´ê¸° â†’ ê·¸ë˜ë„ ë¬´ìŒì´ë©´ ìƒˆë¡œê³ ì¹¨.\n" +
      "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";

    speakNext();
  }

  function stopTts(){
    ttsStopRequested = true;
    ttsActive = false;
    try{ window.speechSynthesis.cancel(); }catch(e){}
    statusEl.textContent = "TTS ì •ì§€.\nâ€» TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
  }

  // ---- ì•± ì „í™˜ ê°ì§€
  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "hidden") return;
    statusEl.textContent =
      "ì•± ì „í™˜ í›„ ëŒì•„ì™”ìŠµë‹ˆë‹¤.\n" +
      "TTSê°€ ì•ˆ ë‚˜ì˜¤ë©´ 'ì½ê¸° ì‹œì‘'ì„ ë‹¤ì‹œ ëˆ„ë¥´ì„¸ìš”.\n" +
      "ê·¸ë˜ë„ ë¬´ìŒì´ë©´ ìƒˆë¡œê³ ì¹¨.\n" +
      "TTS ì¶œë ¥ì´ ì „í˜€ ì•ˆ ë‚˜ì˜¤ëŠ” ê²ƒ ê°™ìœ¼ë©´ ìƒˆë¡œê³ ì¹¨í•˜ë¼";
  });

  // ---- ë¶™ì—¬ë„£ê¸° í›„ ìë™ ì‹œì‘(ì‹¤íŒ¨í•´ë„ ìƒê´€ì—†ê²Œ)
  ttsInput.addEventListener("paste", () => {
    setTimeout(() => {
      try{ startTts(); }catch(e){}
    }, 60);
  });

  // ---- ì´ë²¤íŠ¸ ë°”ì¸ë”© + ì‹œì‘
  btnCapture.addEventListener("click", captureAndOcr);
  btnCopyAll.addEventListener("click", copyAllText);
  btnClearOcr.addEventListener("click", clearOcr);
  btnTtsStart.addEventListener("click", startTts);
  btnTtsStop.addEventListener("click", stopTts);

  startCamera();
})();
</script>
</body>
</html>
