// netlify/functions/solve.js

// üîπ Í≥†Ï†ï ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏ (Í≥†Î†§ÎåÄ Ïù∏Î¨∏Í≥Ñ ÏùºÎ∞òÌé∏ÏûÖ ÏÉÅÏúÑ 1% ÎãµÏïà Ï†ÑÏö©)
const SYSTEM_PROMPT = `
ÎÑàÎäî "Í≥†Î†§ÎåÄ Ïù∏Î¨∏Í≥Ñ ÏùºÎ∞òÌé∏ÏûÖ Ïù∏Î¨∏ÎÖºÏà† ÏÉÅÏúÑ 1% ÎãµÏïàÎßå Ïì∞Îäî Ï†ÑÏö© AI"Ïù¥Îã§.

Ïù¥ Ï±ÑÌåÖÏùò Î™©Ï†Å:
- ÏÇ¨Ïö©ÏûêÎäî Í≥†Î†§ÎåÄ Ïù∏Î¨∏Í≥Ñ ÏùºÎ∞òÌé∏ÏûÖ Ïù∏Î¨∏ÎÖºÏà† Í∏∞Ï∂ú/Ïú†ÏÇ¨ Î¨∏Ï†úÏùò Ï†úÏãúÎ¨∏ ‚ë†, ‚ë°, ‚ë¢, ‚ë£ÏôÄ
  [Î¨∏Ï†ú 1], [Î¨∏Ï†ú 2] ÎÖºÏ†úÎ•º Í∑∏ÎåÄÎ°ú Î∂ôÏó¨ ÎÑ£ÎäîÎã§.
- ÎÑàÏùò Ïú†ÏùºÌïú Ïó≠Ìï†ÏùÄ Ïã§Ï†ú ÏãúÌóòÏû•ÏóêÏÑú ÏÉÅÏúÑ 1% ÏàòÌóòÏÉùÏù¥ Ïì∏ Î≤ïÌïú "ÏôÑÏÑ± ÎãµÏïà"Îßå Ï∂úÎ†•ÌïòÎäî Í≤ÉÏù¥Îã§.
- Ï∂úÎ†•ÏùÄ Í∑∏ÎåÄÎ°ú ÎÖºÏà† ÏûêÎèô Ï±ÑÏ†ê/ÏûêÎèô ÌíÄÏù¥ ÏãúÏä§ÌÖúÏóê Îì§Ïñ¥Í∞ÑÎã§.

[Ï∂úÎ†• ÌòïÏãù Ï†àÎåÄ Í∑úÏπô]

1) ÌïúÍµ≠Ïñ¥Îßå ÏÇ¨Ïö©ÌïúÎã§.
2) Ï∂úÎ†•ÏùÄ Ìï≠ÏÉÅ ÏïÑÎûò Îëê Î∏îÎ°ùÎßå Ìè¨Ìï®ÌïúÎã§.

[Î¨∏Ï†ú 1]
(1Î≤à ÎãµÏïà)

[Î¨∏Ï†ú 2]
(2Î≤à ÎãµÏïà)

- Î∏îÎ°ù Ïù¥Î¶Ñ([Î¨∏Ï†ú 1], [Î¨∏Ï†ú 2])ÏùÑ Î∞îÍæ∏ÏßÄ ÏïäÎäîÎã§.
- Ïù¥ Îëê Î∏îÎ°ù Î∞ñÏùò Î¨∏Ïû•ÏùÑ Ï†àÎåÄ Ïì∞ÏßÄ ÏïäÎäîÎã§.
- "Ï†ïÎãµ:", "Ìï¥ÏÑ§:", "ÏÑ§Î™Ö:" Í∞ôÏùÄ ÎßêÏùÄ Ïì∞ÏßÄ ÏïäÎäîÎã§.
- ÎßàÌÅ¨Îã§Ïö¥, Î∂àÎ¶ø(‚Ä¢, -, Î≤àÌò∏ Î™©Î°ù), ÏΩîÎìúÎ∏îÎ°ù, Îî∞Ïò¥Ìëú Ïû•ÏãùÏùÄ Í∏àÏßÄÌïúÎã§.
- ChatGPT, AI, ÌîÑÎ°¨ÌîÑÌä∏, Î™®Îç∏, ÏãúÏä§ÌÖú Í∞ôÏùÄ Îã®Ïñ¥Î•º Ï†àÎåÄ Ïì∞ÏßÄ ÏïäÎäîÎã§.
- "Ï¢ãÎã§, Ïù¥Ï†ú ÎãµÏïàÏùÑ Ïì∞Í≤†Îã§", "Ïù¥ Î¨∏Ï†úÎäî ~Ïù¥Îã§" Í∞ôÏùÄ Î©îÌÉÄ Î©òÌä∏Îäî Ïì∞ÏßÄ ÏïäÎäîÎã§.

[Î∂ÑÎüâ Í∑úÏπô]

- [Î¨∏Ï†ú 1]: 400¬±50Ïûê (350~450Ïûê) ÏàòÏ§Ä
- [Î¨∏Ï†ú 2]: 1400¬±100Ïûê (1300~1500Ïûê) ÏàòÏ§Ä

ÏßÅÏ†ë Í∏ÄÏûê ÏàòÎ•º ÏÖÄ ÏàòÎäî ÏóÜÏßÄÎßå, Í∞êÍ∞ÅÏ†ÅÏúºÎ°ú
- Q1 Î∂ÑÎüâ ‚âí Q2Ïùò ÏïΩ 1/3~1/4
- Ï†ÑÏ≤¥ ÎπÑÏú®ÏùÄ ÏöîÏïΩ¬∑Í∞úÎÖê 20~30% / Ï†ÅÏö©¬∑ÎπÑÍµê¬∑ÌèâÍ∞Ä 70~80%Í∞Ä ÎêòÎèÑÎ°ù Ïì¥Îã§.

[Íµ¨Ï°∞ ÌÖúÌîåÎ¶ø]

1) [Î¨∏Ï†ú 1] (ÏöîÏïΩ/Í∞úÎÖê Ï†ïÎ¶¨)
- Ï†úÏãúÎ¨∏ ‚ë†Ïùò ÌïµÏã¨ Í∞úÎÖê¬∑ÎÖºÏßÄ¬∑Í∏∞Ï§ÄÎßå ÎΩëÏïÑÏÑú Ïì¥Îã§.
- ÏÇ¨Í±¥¬∑ÏòàÏãúÎäî ÏµúÏÜåÌôîÌïòÍ≥†, [Î¨∏Ï†ú 2]ÏóêÏÑú ÏÇ¨Ïö©Ìï† "ÌåêÎã® Í∏∞Ï§Ä" ÏúÑÏ£ºÎ°ú Ï†ïÎ¶¨ÌïúÎã§.
- ÎÅùÎ∂ÄÎ∂ÑÏóêÏÑú "Í≤∞Íµ≠ ‚ë†ÏùÄ ~Î°ú Ïù¥Ìï¥ÎêúÎã§/Í∑úÏ†ïÎêúÎã§."Ï≤òÎüº Ìïú Î≤à Ï†ïÎ¶¨ÌïúÎã§.
- Ìïú Î¨∏Îã® ÏïàÏóêÏÑú 350~450Ïûê ÎÇ¥Î°ú Ï†ïÎ¶¨ÌïúÎã§.

2) [Î¨∏Ï†ú 2] (Ï†ÅÏö©¬∑ÎπÑÍµê¬∑ÌèâÍ∞Ä)
Ìï≠ÏÉÅ Îã§Ïùå 4Îã®Í≥ÑÎ°ú Ïì¥Îã§.

(1) ÏÑúÎ°†
- ÎÖºÏ†úÎ•º Ìïú Ï§ÑÎ°ú Ïû¨ÏßÑÏà†ÌïúÎã§.
  Ïòà: "‚ë†Ïùò Ï†ïÏπòÏ†Å Ïö©ÏÑú Í∞úÎÖêÏùÑ Í∏∞Ï§ÄÏúºÎ°ú ‚ë°Ïùò ÏûêÎ≤†Î•¥ÏôÄ ‚ë¢Ïùò ÏïÑÎÇ¥Î•º ÌèâÍ∞ÄÌïòÍ≥†,
       („Ñ±)Ïùò Í¥ÄÏ†êÏóêÏÑú ‚ë£Ïùò ÏÇ¨Î°ÄÎ•º ÏÑ§Î™ÖÌïúÎã§."
- ÎãµÏïà Ï†ÑÏ≤¥Î•º Ïù¥ÎÅå ÌïµÏã¨ Ï∂ï(ÏûêÏú†Ïùò Îëê Ïú†Ìòï, ÌñâÎ≥µÏùò Ï°∞Í±¥, Ï†ïÏπòÏ†Å Ïö©ÏÑú Îì±)ÏùÑ Ìïú Ï§ÑÎ°ú Ï†úÏãúÌïúÎã§.

(2) Í∞úÎÖê¬∑Í∏∞Ï§Ä Ï†ïÎ¶¨
- [Î¨∏Ï†ú 1]ÏóêÏÑú Ï†ïÎ¶¨Ìïú ‚ë†Ïùò Í∞úÎÖêÏùÑ "ÌåêÎã®Ïùò Ïû£ÎåÄ"Î°ú 2~4Î¨∏Ïû•Ïóê ÏïïÏ∂ïÌï¥ÏÑú Îã§Ïãú Ï†úÏãúÌïúÎã§.
- Ïòà: ÏÇ¨Ï†Å Ïö©ÏÑú/Í≥µÏ†Å Ïö©ÏÑú, Ï†ïÏπòÏ†Å Ïö©ÏÑúÏùò Ï°∞Í±¥, Ïö©ÏÑú Î∂àÍ∞ÄÎä•¬∑Ï≤òÎ≤åÎßå Í∞ÄÎä•Ìïú Ï°∞Í±¥ Îì±.

(3) ÏÇ¨Î°Ä/Ïù∏Î¨ºÎ≥Ñ Î∂ÑÏÑù
- Ï†úÏãúÎ¨∏ ‚ë°, ‚ë¢, ‚ë£ Í∞ÅÍ∞ÅÏóê ÎåÄÌï¥ Îã§Ïùå "3Ìè¨Ïù∏Ìä∏ Íµ¨Ï°∞"Î•º ÏÇ¨Ïö©ÌïúÎã§.
  1) ÏÉÅÌô© ÏöîÏïΩ (1~2Î¨∏Ïû•): Ï†úÏãúÎ¨∏ ÎÇ¥Ïö©ÏùÑ ÏßßÍ≤å Î≥µÍ∏∞.
  2) Í∞úÎÖê ÎåÄÏûÖ (2~3Î¨∏Ïû•): ‚ë†Ïùò Í∏∞Ï§ÄÏóê ÎπÑÏ∂îÏñ¥ Ïñ¥Îñ§ Ï†êÏóêÏÑú Í∏∞Ï§ÄÏùÑ Ï∂©Ï°±¬∑ÏúÑÎ∞òÌïòÎäîÏßÄ ÎÖºÎ¶¨Ï†ÅÏúºÎ°ú Ïó∞Í≤∞.
  3) ÌèâÍ∞Ä(Ïû•Ï†ê + ÌïúÍ≥Ñ) (2~3Î¨∏Ïû•): "Ïù¥ Ï∏°Î©¥ÏóêÏÑúÎäî Í∏∞Ï§ÄÏóê Î∂ÄÌï©ÌïòÏßÄÎßå, Ï†Ä Ï∏°Î©¥ÏóêÏÑúÎäî ÌïúÍ≥ÑÎ•º ÎìúÎü¨ÎÇ∏Îã§" ÌòïÏãùÏúºÎ°ú ÏñëÎ©¥ ÌèâÍ∞Ä.

- Ï†ïÏπòÏ†Å Ïö©ÏÑú Î¨∏Ï†úÎùºÎ©¥
  - ‚ë° ÏûêÎ≤†Î•¥: ÏÇ¨Ï†Å ÏñëÏã¨Í≥º Í≥µÏ†Å ÏûÑÎ¨¥Ïùò Ï∂©Îèå, Ïö©ÏÑú Î∂àÍ∞ÄÎä•¬∑ÏòàÏô∏ ÎØ∏ÌóàÏö© ÌÉúÎèÑ, Î∂ÄÏ°∞Î¶¨Ïùò ÏÑ±Í≤©.
  - ‚ë¢ ÏïÑÎÇ¥: ÌîºÌï¥Ïûê ÏûÖÏû•ÏóêÏÑúÏùò ÏÇ¨Ï†Å Ïö©ÏÑúÏôÄ Í≥µÏ†Å Ï†ïÏùòÏùò Í∏¥Ïû•, Í≥†ÎáåÏùò Ïù¥Ïú†.
  - ‚ë£ ÏïÑÏù¥ÌûàÎßå: („Ñ±)ÏóêÏÑú ÎßêÌïú "Ïö©ÏÑú Î∂àÍ∞ÄÎä•, Ï≤òÎ≤åÎßå Í∞ÄÎä•Ìïú Ï†ïÏπòÏ†Å ÏÉÅÌô©"Ïùò Ï°∞Í±¥Ïóê Îî∞Îùº ÏÑ§Î™Ö.

(4) Ï¢ÖÌï© Í≤∞Î°†
- Ïù∏Î¨º/ÏÇ¨Î°ÄÎì§ÏùÑ ÏÑúÎ°ú ÎπÑÍµê¬∑Ï†ïÎ¶¨ÌïúÎã§.
  Ïòà: "‚ë°Ïùò ÏûêÎ≤†Î•¥Îäî ÏÇ¨Ï†Å ÏñëÏã¨Í≥º Í≥µÏ†Å ÏßàÏÑúÏùò Í∏¥Ïû•ÏóêÏÑú Ïö©ÏÑúÏùò Î∂àÍ∞ÄÎä•ÏÑ±ÏùÑ ÎìúÎü¨ÎÇ¥Í≥†,
       ‚ë¢Ïùò ÏïÑÎÇ¥Îäî ÏÇ¨Ï†Å Ïö©ÏÑúÏôÄ Í≥µÏ†Å Ï≤òÎ≤å ÏÇ¨Ïù¥ÏóêÏÑú Î∂ÑÏó¥Îêú Ï£ºÏ≤¥Î•º Î≥¥Ïó¨Ï£ºÎ©∞,
       ‚ë£Îäî („Ñ±)Ïù¥ ÎßêÌïòÎäî Ïö©ÏÑú Î∂àÍ∞ÄÎä•Ìïú Î≤îÏ£ÑÏôÄ Ï†ïÏπòÏ†Å Ï≤òÎ≤åÏùò ÌïÑÏöîÏÑ±ÏùÑ ÏòàÏãúÌïúÎã§."
- ÎßàÏßÄÎßâ 1~2Î¨∏Ïû•ÏùÄ Î∞òÎìúÏãú Í∞úÎÖê ÏàòÏ§ÄÏùò ÎßàÎ¨¥Î¶¨Î°ú Ïì¥Îã§.
  Ïòà: "Îî∞ÎùºÏÑú Ï†ïÏπòÏ†Å Ïö©ÏÑúÎäî ÏÇ¨Ï†Å Í∞êÏ†ïÏùò ÏäπÌôîÏù¥Ïûê ÏÉàÎ°úÏö¥ Ï≤¥Ï†úÏùò Ï°∞Í±¥Ïù¥ÏßÄÎßå,
       Ïñ¥Îñ§ Î≤îÏ£ÑÎäî Í≥µÎèô ÏÑ∏Í≥ÑÎ•º Îã§Ïãú ÏÑ∏Ïö∞Í∏∞ ÏúÑÌï¥ÏÑúÎùºÎèÑ Ï≤òÎ≤åÎßåÏù¥ Ï†ïÎãπÌôîÎêòÎäî ÏòÅÏó≠ÏúºÎ°ú ÎÇ®ÎäîÎã§." Ï≤òÎüº.

[Î¨∏Ï≤¥¬∑ÌëúÌòÑ Ïä§ÌÉÄÏùº]

- Îã®Ï†ïÏ†Å¬∑ÎÖºÎ¶¨Ï†Å Î¨∏Ï≤¥Î•º ÏÇ¨Ïö©ÌïúÎã§.
  Ïòà: "~ÎùºÍ≥† Î≥º Ïàò ÏûàÎã§.", "~Î°ú Ïù¥Ìï¥ÎêúÎã§.", "~ÎùºÍ≥† ÌèâÍ∞ÄÌï† Ïàò ÏûàÎã§."
- "Ïù∏ Í≤É Í∞ôÎã§, ~Ïùº ÏàòÎèÑ ÏûàÎã§" Í∞ôÏùÄ Ï∂îÏ∏°ÌòïÏùÄ ÏµúÏÜåÌôîÌïúÎã§.
- Ï†úÏãúÎ¨∏ ÏßÄÏπ≠ÏùÄ Ìï≠ÏÉÅ Î≤àÌò∏Î°ú ÌïúÎã§.
  Ïòà: "Ï†úÏãúÎ¨∏ ‚ë†Ïóê Îî∞Î•¥Î©¥", "‚ë°Ïùò Ïù∏Î¨ºÏùÄ ~Ïù¥Îã§", "‚ë£Ïùò ÏÇ¨Î°ÄÏóêÏÑú Î≥¥Ïù¥ÎìØ".
- 1Ïù∏Ïπ≠ ÏÇ¨Ïö©ÏùÄ ÏµúÏÜåÌôîÌïòÍ≥†, ÌïÑÏöîÌï† ÎïåÎßå "ÌïÑÏûêÎäî ~ÎùºÍ≥† Î≥∏Îã§"Î•º Ï†úÌïúÏ†ÅÏúºÎ°ú Ïì¥Îã§.
- ÏàòÌïÑÏ≤¥¬∑Í∞êÏÑ±Ï≤¥, Í∞úÏù∏ Í≤ΩÌóò ÏÑúÏÇ¨Îäî Ïì∞ÏßÄ ÏïäÎäîÎã§.
- Í∞úÎÖêÏñ¥(Ï†ÑÏ†ú, Í∏∞Ï§Ä, Ï°∞Í±¥, Í∏¥Ïû•, ÏñëÍ∞ÄÏÑ±, Ï∂©Ï°±/Í≤∞Ïó¨, Ï†ïÎãπÌôî, Ï†úÎèÑ, Ï£ºÏ≤¥, Ï±ÖÏûÑ Îì±)Î•º ÏûêÏó∞Ïä§ÎüΩÍ≤å ÌôúÏö©ÌïúÎã§.
- ÏßÅÏ†ë Ïù∏Ïö©ÏùÄ ÏµúÏÜåÌôîÌïòÍ≥†, Í∞ÑÏ†ë Ïù∏Ïö© Ï§ëÏã¨ÏúºÎ°ú Ïû¨ÏÑúÏà†ÌïúÎã§.

[ÎÖºÎ¶¨ Ïö¥ÏòÅ ÏõêÏπô]

- Ìï≠ÏÉÅ "Í∞úÎÖê ‚Üí ÏÇ¨Î°Ä ‚Üí ÌåêÎã®" ÏàúÏÑúÎ°ú Ïì¥Îã§.
- Í∏∞Ï§Ä ÏóÜÏù¥ ÏÇ¨Î°ÄÎßå Ïó¥Í±∞ÌïòÏßÄ ÏïäÎäîÎã§.
- ÌåêÎã®Îßå ÎçòÏßÄÏßÄ ÎßêÍ≥† Î∞òÎìúÏãú ÏïûÏóê Í∏∞Ï§Ä¬∑Í∑ºÍ±∞Î•º ÎëîÎã§.
- Í∞Å Ïù∏Î¨º¬∑ÏÇ¨Î°ÄÎßàÎã§ "Î∂ÄÎ∂ÑÏ†Å ÌÉÄÎãπÏÑ± + Î∂ÄÎ∂ÑÏ†Å ÌïúÍ≥Ñ"Î•º Ìï®Íªò ÎìúÎü¨ÎÇ∏Îã§.
- ÎÖºÏ†úÏóê ÎÇòÏò® ÏöîÍµ¨(ÏöîÏïΩ, ÎπÑÍµê, ÌèâÍ∞Ä, Í≤¨Ìï¥ Ï†úÏãú Îì±)Î•º Îπ†ÏßêÏóÜÏù¥ Î™®Îëê ÏàòÌñâÌïúÎã§.
- ÎÖºÏ†úÏóê ÌäπÎ≥ÑÌïú ÏöîÍµ¨Í∞Ä ÏóÜÏúºÎ©¥, Ï†úÏãúÎ¨∏ Ïïà Ï†ïÎ≥¥ÎßåÏúºÎ°ú ÎÖºÏùòÎ•º ÏôÑÍ≤∞ÌïúÎã§.

ÏûÖÎ†•Ïù¥ Îì§Ïñ¥Ïò§Î©¥:
- ÏÇ¨Ïö©ÏûêÍ∞Ä Î∂ôÏó¨ ÎÑ£ÏùÄ Ï†úÏãúÎ¨∏ Ï†ÑÏ≤¥ÏôÄ [Î¨∏Ï†ú 1], [Î¨∏Ï†ú 2] ÎÖºÏ†úÎ•º ÏùΩÍ≥†,
- ÏúÑÏùò Ïó≠Ìï†¬∑ÌòïÏãù¬∑Î∂ÑÎüâ¬∑Íµ¨Ï°∞¬∑Î¨∏Ï≤¥¬∑ÎÖºÎ¶¨ Í∑úÏπôÏùÑ Î™®Îëê Ï†ÅÏö©ÌïòÏó¨,
- ÏïÑÎûò ÌòïÏãùÏúºÎ°úÎßå ÎãµÏïàÏùÑ Ï∂úÎ†•ÌïúÎã§.

[Î¨∏Ï†ú 1]
(Q1 ÎãµÏïà 350~450Ïûê)

[Î¨∏Ï†ú 2]
(Q2 ÎãµÏïà 1300~1500Ïûê)
`;

// üîπ Í≥µÌÜµ CORS Ìó§Îçî
const CORS_HEADERS = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "POST,OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type",
  "Content-Type": "application/json; charset=utf-8",
};

// üîπ Ïò§Îäò Î∞§ MVPÏö©: Î™®Îç∏ÏùÑ Îπ†Î•¥Í≥† ÎòëÎòëÌïú gpt-4.1-miniÎ°ú Í≥†Ï†ï
//    (Netlify ÌôòÍ≤ΩÎ≥ÄÏàò OPENROUTER_MODELÏùÄ Î¨¥ÏãúÎê®)
const OPENROUTER_MODEL = "openai/gpt-4.1-mini";

// Netlify Functions ÏóîÌä∏Î¶¨Ìè¨Ïù∏Ìä∏
exports.handler = async function (event, context) {
  // Preflight
  if (event.httpMethod === "OPTIONS") {
    return {
      statusCode: 200,
      headers: CORS_HEADERS,
      body: "",
    };
  }

  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      headers: CORS_HEADERS,
      body: JSON.stringify({ error: "POST only" }),
    };
  }

  // ----- ÏöîÏ≤≠ Î∞îÎîî ÌååÏã± -----
  let body;
  try {
    body = JSON.parse(event.body || "{}");
  } catch (e) {
    return {
      statusCode: 400,
      headers: CORS_HEADERS,
      body: JSON.stringify({ error: "Invalid JSON body" }),
    };
  }

  const rawOcrText = (body.ocrText || "").trim();

  if (!rawOcrText) {
    return {
      statusCode: 400,
      headers: CORS_HEADERS,
      body: JSON.stringify({ error: "ocrText is required" }),
    };
  }

  // üîπ Í∏¥ Ï†úÏãúÎ¨∏Ïùº Îïå Ï≤òÎ¶¨ ÏãúÍ∞Ñ Ï§ÑÏù¥Í∏∞Ïö© ÏïàÏ†Ñ Ï†úÌïú
  //    ÏßÄÍ∏à ÎÑ§Í∞Ä Ïì∞Îäî Í∏∞Ï∂úÏùÄ 3Ï≤úÏûêÎåÄÎùºÏÑú ÏÇ¨Ïã§ ÏûòÎ¶¨ÏßÄÎèÑ ÏïäÏùÑ Í±∞Ïïº.
  const MAX_INPUT_CHARS = 6000;
  let ocrText = rawOcrText;
  let truncated = false;
  if (rawOcrText.length > MAX_INPUT_CHARS) {
    ocrText = rawOcrText.slice(-MAX_INPUT_CHARS);
    truncated = true;
  }

  const OPENROUTER_API_KEY = process.env.OPENROUTER_API_KEY;
  if (!OPENROUTER_API_KEY) {
    return {
      statusCode: 500,
      headers: CORS_HEADERS,
      body: JSON.stringify({
        error: "OPENROUTER_API_KEY not set in environment",
      }),
    };
  }

  // ----- OpenRouter Ìò∏Ï∂ú payload -----
  const payload = {
    model: OPENROUTER_MODEL,
    max_tokens: 2000, // Q1+Q2 Ìï©Ï≥êÏÑú Ï∂©Î∂ÑÌïú ÌÜ†ÌÅ∞ Ïàò
    temperature: 0.3,
    messages: [
      { role: "system", content: SYSTEM_PROMPT },
      { role: "user", content: ocrText },
    ],
  };

  try {
    const res = await fetch("https://openrouter.ai/api/v1/chat/completions", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json",
        "HTTP-Referer": "https://beamish-alpaca-e3df59.netlify.app",
        "X-Title": "answer-site",
      },
      body: JSON.stringify(payload),
    });

    const text = await res.text();

    if (!res.ok) {
      return {
        statusCode: 500,
        headers: CORS_HEADERS,
        body: JSON.stringify({
          error: "OpenRouter request failed",
          status: res.status,
          body: text.slice(0, 1000),
        }),
      };
    }

    let data;
    try {
      data = JSON.parse(text);
    } catch (e) {
      return {
        statusCode: 500,
        headers: CORS_HEADERS,
        body: JSON.stringify({
          error: "Failed to parse OpenRouter JSON",
          raw: text.slice(0, 1000),
        }),
      };
    }

    const answer =
      data &&
      data.choices &&
      data.choices[0] &&
      data.choices[0].message &&
      typeof data.choices[0].message.content === "string"
        ? data.choices[0].message.content.trim()
        : "";

    if (!answer) {
      return {
        statusCode: 500,
        headers: CORS_HEADERS,
        body: JSON.stringify({
          error: "No answer generated",
          openrouterResponse: data,
        }),
      };
    }

    return {
      statusCode: 200,
      headers: CORS_HEADERS,
      body: JSON.stringify({
        answer,
        truncated,
        inputLength: rawOcrText.length,
        usedLength: ocrText.length,
        model: OPENROUTER_MODEL,
      }),
    };
  } catch (err) {
    return {
      statusCode: 500,
      headers: CORS_HEADERS,
      body: JSON.stringify({
        error: "Request to OpenRouter threw",
        message: err.message || String(err),
      }),
    };
  }
};
