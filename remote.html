<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>answer-site | Control</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
    }

    .top-tabs {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .tab-btn {
      flex: 1;
      padding: 8px 4px;
      border-radius: 18px;
      border: 0;
      background: #222;
      color: #eee;
      font-size: 13px;
    }
    .tab-btn.active {
      background: #1976ff;
      color: #fff;
      font-weight: 600;
    }

    #sectionStatus {
      font-size: 12px;
      margin-bottom: 6px;
      color: #c4f1ff;
    }

    #answerBox {
      border-radius: 8px;
      padding: 10px;
      background: #111;
      margin-bottom: 6px;
      min-height: 52px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    #answerMain {
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      word-break: break-all;
    }
    #probLine {
      font-size: 11px;
      color: #9ccfff;
      text-align: right;
      min-width: 90px;
    }

    #detailBox {
      white-space: pre-wrap;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: #050608;
      padding: 10px;
      border-radius: 8px;
      max-height: 40vh;
      overflow-y: auto;
      margin-bottom: 8px;
    }

    .btn-main {
      width: 100%;
      padding: 10px;
      margin-bottom: 6px;
      border-radius: 999px;
      border: 0;
      font-size: 15px;
      font-weight: 600;
      background: #0d6efd;
      color: #fff;
    }

    .btn-sub {
      width: 100%;
      padding: 8px;
      margin-bottom: 4px;
      border-radius: 999px;
      border: 0;
      font-size: 13px;
      background: #20232a;
      color: #eee;
    }

    #debugToggle {
      margin-top: 2px;
      margin-bottom: 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 0;
      background: #333;
      color: #ddd;
    }

    #debugPanel {
      display: none;
      gap: 4px;
      flex-direction: column;
      font-size: 11px;
    }
    .debug-block {
      background: #050608;
      border-radius: 6px;
      padding: 6px;
    }
    .debug-title {
      font-size: 11px;
      color: #7dd3fc;
      margin-bottom: 2px;
    }
    .debug-pre {
      white-space: pre-wrap;
      max-height: 20vh;
      overflow-y: auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    #footerInfo {
      margin-top: 4px;
      font-size: 11px;
      color: #666;
    }
  </style>
</head>
<body>
<div class="top-tabs">
  <button id="tabReading"   class="tab-btn">Reading</button>
  <button id="tabListening" class="tab-btn">Listening</button>
  <button id="tabWriting"   class="tab-btn">Writing</button>
  <button id="tabSpeaking"  class="tab-btn">Speaking</button>
</div>

<div id="sectionStatus">섹션: - · OCR: 대기 · 카메라 상태: -</div>

<div id="answerBox">
  <div id="answerMain">아직 문제를 풀지 않았습니다.</div>
  <div id="probLine"></div>
</div>

<pre id="detailBox"></pre>

<button id="btnSolve" class="btn-main">이 질문 풀기</button>
<button id="btnAccumulate" class="btn-sub">지문 누적 (긴 지문용)</button>
<button id="btnReset" class="btn-sub">이 세션 초기화</button>
<button id="btnSTT" class="btn-sub">음성 인식 시작 (Listening/Speaking)</button>

<button id="debugToggle">디버그 보기 토글 (OCR/음성/지문)</button>

<div id="debugPanel">
  <div class="debug-block">
    <div class="debug-title">OCR 텍스트 (현재 화면)</div>
    <div id="debugOcr" class="debug-pre"></div>
  </div>
  <div class="debug-block">
    <div class="debug-title">지문 텍스트 (누적)</div>
    <div id="debugQuestion" class="debug-pre"></div>
  </div>
  <div class="debug-block">
    <div class="debug-title">음성 텍스트 (STT)</div>
    <div id="debugAudio" class="debug-pre"></div>
  </div>
</div>

<div id="footerInfo">AI 풀이 완료.</div>

<script>
  // ------------ Firebase ------------
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ------------ DOM ------------
  const tabReading   = document.getElementById("tabReading");
  const tabListening = document.getElementById("tabListening");
  const tabWriting   = document.getElementById("tabWriting");
  const tabSpeaking  = document.getElementById("tabSpeaking");

  const sectionStatus = document.getElementById("sectionStatus");
  const answerMain    = document.getElementById("answerMain");
  const probLine      = document.getElementById("probLine");
  const detailBox     = document.getElementById("detailBox");

  const btnSolve      = document.getElementById("btnSolve");
  const btnAccumulate = document.getElementById("btnAccumulate");
  const btnReset      = document.getElementById("btnReset");
  const btnSTT        = document.getElementById("btnSTT");

  const debugToggle   = document.getElementById("debugToggle");
  const debugPanel    = document.getElementById("debugPanel");
  const debugOcr      = document.getElementById("debugOcr");
  const debugQuestion = document.getElementById("debugQuestion");
  const debugAudio    = document.getElementById("debugAudio");

  const footerInfo    = document.getElementById("footerInfo");

  const modeMapKo = {
    reading:   "reading",
    listening: "listening",
    writing:   "writing",
    speaking:  "speaking"
  };

  let currentMode = "reading";

  let latestOcrText = "";
  let latestOcrConf = 0;
  let cameraBlocked = false;

  let accQuestionText = "";

  // STT 상태
  let recognition = null;
  let sttSupported = false;
  let sttRunning = false;
  let sttTextFull = "";

  // ------------ 모드 전환 ------------
  function setMode(mode) {
    currentMode = mode;
    tabReading.classList.remove("active");
    tabListening.classList.remove("active");
    tabWriting.classList.remove("active");
    tabSpeaking.classList.remove("active");

    if (mode === "reading")   tabReading.classList.add("active");
    if (mode === "listening") tabListening.classList.add("active");
    if (mode === "writing")   tabWriting.classList.add("active");
    if (mode === "speaking")  tabSpeaking.classList.add("active");

    db.ref("p2p/state").update({
      modeHint: mode,
      modeUpdatedAt: Date.now()
    });

    updateSectionStatus();
  }

  tabReading.onclick   = () => setMode("reading");
  tabListening.onclick = () => setMode("listening");
  tabWriting.onclick   = () => setMode("writing");
  tabSpeaking.onclick  = () => setMode("speaking");

  // ------------ Firebase 상태 구독 (OCR/카메라) ------------
  db.ref("p2p/state").on("value", snap => {
    const state = snap.val() || {};
    latestOcrText = state.ocrText || "";
    latestOcrConf = typeof state.ocrConfidence === "number" ? state.ocrConfidence : 0;
    cameraBlocked = !!state.cameraBlocked;

    debugOcr.textContent = latestOcrText || "(없음)";
    updateSectionStatus();
  });

  function updateSectionStatus() {
    const modeLabel = modeMapKo[currentMode] || currentMode;

    let ocrLabel = "대기";
    if (latestOcrText && latestOcrConf >= 10) {
      ocrLabel = "완료";
    } else if (latestOcrText && latestOcrConf > 0 && latestOcrConf < 10) {
      ocrLabel = "무시(정확도 낮음)";
    }

    const camLabel = cameraBlocked ? "가려짐" : "정상";

    sectionStatus.textContent =
      `섹션: ${modeLabel} · OCR: ${ocrLabel} (conf=${latestOcrConf.toFixed(1)}%) · 카메라 상태: ${camLabel}`;
  }

  // ------------ STT 초기화 ------------
  (function initSTT() {
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SR) {
      sttSupported = false;
      btnSTT.textContent = "음성 인식 미지원 (브라우저)";
      btnSTT.disabled = true;
      return;
    }
    sttSupported = true;
    recognition = new SR();
    recognition.lang = "en-US";
    recognition.continuous = true;
    recognition.interimResults = true;

    recognition.onresult = (event) => {
      let finalText = "";
      for (let i = 0; i < event.results.length; i++) {
        const res = event.results[i];
        if (res.isFinal) {
          finalText += res[0].transcript;
          finalText += " ";
        }
      }
      if (finalText) {
        sttTextFull += finalText;
        sttTextFull = sttTextFull.trim();
        debugAudio.textContent = sttTextFull;
        db.ref("p2p/state").update({
          audioText: sttTextFull,
          audioUpdatedAt: Date.now()
        });
      }
    };

    recognition.onerror = (e) => {
      console.warn("STT error", e);
      footerInfo.textContent = "STT 오류: " + e.error;
      sttRunning = false;
      btnSTT.textContent = "음성 인식 시작 (Listening/Speaking)";
    };

    recognition.onend = () => {
      if (sttRunning) {
        // 의도치 않은 종료 → 버튼 상태만 복구
        sttRunning = false;
        btnSTT.textContent = "음성 인식 시작 (Listening/Speaking)";
      }
    };
  })();

  function startSTT() {
    if (!sttSupported || !recognition) return;
    try {
      sttRunning = true;
      btnSTT.textContent = "음성 인식 중지";
      footerInfo.textContent = "음성 인식 중...";
      recognition.start();
    } catch (e) {
      console.warn(e);
    }
  }

  function stopSTT() {
    if (!sttSupported || !recognition) return;
    try {
      sttRunning = false;
      btnSTT.textContent = "음성 인식 시작 (Listening/Speaking)";
      recognition.stop();
    } catch (e) {
      console.warn(e);
    }
  }

  btnSTT.onclick = () => {
    if (!sttSupported) return;
    if (sttRunning) stopSTT(); else startSTT();
  };

  // ------------ 지문 누적/세션 초기화 ------------
  btnAccumulate.onclick = () => {
    const t = (latestOcrText || "").trim();
    if (!t) {
      footerInfo.textContent = "현재 OCR 텍스트가 없어 누적하지 못했습니다.";
      return;
    }
    if (accQuestionText) accQuestionText += "\n\n" + t;
    else accQuestionText = t;

    debugQuestion.textContent = accQuestionText;
    footerInfo.textContent = "지문 누적 완료.";
  };

  btnReset.onclick = () => {
    accQuestionText = "";
    sttTextFull = "";
    debugQuestion.textContent = "";
    debugAudio.textContent = "";
    answerMain.textContent = "세션이 초기화되었습니다.";
    probLine.textContent = "";
    detailBox.textContent = "";

    db.ref("p2p/state").update({
      audioText: "",
      questionText: "",
      sessionResetAt: Date.now()
    });

    footerInfo.textContent = "세션 초기화 완료.";
  };

  // ------------ 디버그 토글 ------------
  debugToggle.onclick = () => {
    if (debugPanel.style.display === "flex") {
      debugPanel.style.display = "none";
    } else {
      debugPanel.style.display = "flex";
    }
  };

  // ------------ AI 호출 ------------
  function parseP(resultText) {
    const m = resultText.match(/\[P\]\s*([0-9.]+)/i);
    if (!m) return null;
    const v = parseFloat(m[1]);
    if (isNaN(v)) return null;
    return Math.max(0, Math.min(1, v));
  }

  function displayResult(mode, resultText) {
    const p = parseP(resultText);
    if (p != null) {
      const pct = Math.round(p * 100);
      probLine.textContent = `맞을 확률(추정): ${pct}%`;
    } else {
      probLine.textContent = "";
    }

    if (mode === "writing") {
      const essayMatch = resultText.match(/\[ESSAY\]([\s\S]*?)\[FEEDBACK\]/i);
      const fbMatch    = resultText.match(/\[FEEDBACK\]([\s\S]*)$/i);
      const essay = essayMatch ? essayMatch[1].trim() : "(ESSAY 블록 없음)";
      const feedback = fbMatch ? fbMatch[1].trim() : "";

      answerMain.textContent = "Writing 모범 에세이 생성됨";
      detailBox.textContent = "[ESSAY]\n" + essay + "\n\n[FEEDBACK]\n" + feedback;
      return;
    }

    if (mode === "speaking") {
      const modelMatch = resultText.match(/\[MODEL\]([\s\S]*?)\[P\]/i);
      const script = modelMatch ? modelMatch[1].trim() : resultText.trim();
      answerMain.textContent = "스피킹 답안 스크립트";
      detailBox.textContent = script;
      return;
    }

    // reading / listening / auto
    const ansMatch = resultText.match(/\[ANSWER\]\s*([^\n]+)/i);
    const ans = ansMatch ? ansMatch[1].trim() : "?";

    const whyMatch = resultText.match(/\[WHY\]([\s\S]*)$/i);
    const why = whyMatch ? whyMatch[1].trim() : resultText.trim();

    answerMain.textContent = ans || "?";
    detailBox.textContent = why;
  }

  btnSolve.onclick = async () => {
    // 1) STT 중이면 먼저 종료
    if (sttRunning) stopSTT();

    // 2) 사용할 OCR 텍스트 결정
    const useText = (accQuestionText && accQuestionText.trim().length > 0)
      ? accQuestionText.trim()
      : (latestOcrText || "").trim();

    if (!useText) {
      answerMain.textContent = "OCR 실패/무시 – 지문을 먼저 확실하게 찍어야 합니다.";
      probLine.textContent = "";
      detailBox.textContent = "";
      footerInfo.textContent = "OCR 텍스트가 없어 AI를 호출하지 않았습니다.";
      return;
    }

    // 누적을 쓰지 않는 경우에는 conf도 체크
    if (!accQuestionText && latestOcrConf < 10) {
      answerMain.textContent = "OCR 정확도가 너무 낮아서 AI 풀이는 건너뜁니다.";
      probLine.textContent = "";
      detailBox.textContent =
        `현재 conf=${latestOcrConf.toFixed(1)}%. 카메라 거리를 조절하거나 다시 촬영해 주세요.`;
      footerInfo.textContent = "OCR 정확도 부족으로 AI 호출 생략.";
      return;
    }

    // 3) 오디오 텍스트 (Listening/Speaking/Writing 통합형용)
    let audioForMode = "";
    if (currentMode === "listening" || currentMode === "speaking" || currentMode === "writing") {
      audioForMode = (sttTextFull || "").trim();
    }

    answerMain.textContent = "AI 풀이 중...";
    probLine.textContent = "";
    detailBox.textContent = "";
    footerInfo.textContent = "AI에 문제를 보내는 중...";

    btnSolve.disabled = true;

    try {
      const payload = {
        mode: currentMode,
        ocrText: useText,
        audioText: audioForMode
      };

      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      displayResult(currentMode, text);
      footerInfo.textContent = "AI 풀이 완료.";
    } catch (e) {
      console.error(e);
      answerMain.textContent = "AI 호출 중 오류가 발생했습니다.";
      probLine.textContent = "";
      detailBox.textContent = e.toString();
      footerInfo.textContent = "네트워크/서버 오류.";
    } finally {
      btnSolve.disabled = false;
    }
  };

  // 기본 모드: Reading
  setMode("reading");
</script>
</body>
</html>

