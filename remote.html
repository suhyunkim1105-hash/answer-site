<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>answer-site | Result</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 16px;
      background: #f5f5f5;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      max-width: 900px;
    }
    h2 { margin: 4px 0 8px 0; font-size: 24px; }
    #modeLabel { font-size: 14px; color:#555; }
    #status { font-size: 13px; color:#555; margin-top:6px; }

    .box {
      margin-top: 14px;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .answer-big {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    pre {
      white-space: pre-wrap;
      margin: 0;
      font-size: 15px;
      line-height: 1.6;
      font-family: "SF Mono", Menlo, Monaco, Consolas, monospace;
    }
    h3 {
      margin: 10px 0 6px 0;
      font-size: 17px;
    }

    @media (max-width: 480px) {
      body { padding: 12px; }
      h2 { font-size: 22px; }
      .answer-big { font-size: 34px; }
      pre { font-size: 15px; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <h2>answer-site Result</h2>
  <div id="modeLabel">모드: -</div>
  <div id="status"></div>

  <!-- Reading / Listening -->
  <div id="box-rl" class="box" style="display:none;">
    <div class="answer-big" id="rl-answer"></div>
    <pre id="rl-why"></pre>
  </div>

  <!-- Writing -->
  <div id="box-writing" class="box" style="display:none;">
    <h3>Essay</h3>
    <pre id="w-essay"></pre>
    <h3>Feedback (Korean)</h3>
    <pre id="w-feedback"></pre>
  </div>

  <!-- Speaking -->
  <div id="box-speaking" class="box" style="display:none;">
    <h3>Evaluation</h3>
    <pre id="s-eval"></pre>
    <h3>Model Answer</h3>
    <pre id="s-model"></pre>
    <h3>Korean Tips</h3>
    <pre id="s-korean"></pre>
  </div>
</div>

<script>
  // ---------------- Firebase ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const modeLabel = document.getElementById('modeLabel');
  const statusEl  = document.getElementById('status');

  const boxRL      = document.getElementById('box-rl');
  const boxW       = document.getElementById('box-writing');
  const boxS       = document.getElementById('box-speaking');

  const rlAnswerEl = document.getElementById('rl-answer');
  const rlWhyEl    = document.getElementById('rl-why');
  const wEssayEl   = document.getElementById('w-essay');
  const wFbEl      = document.getElementById('w-feedback');
  const sEvalEl    = document.getElementById('s-eval');
  const sModelEl   = document.getElementById('s-model');
  const sKorEl     = document.getElementById('s-korean');

  let latestState = { mode: "reading" };
  let lastSolveTs = 0;

  db.ref("p2p/state").on("value", snap => {
    latestState = snap.val() || {};
    modeLabel.textContent = `모드: ${latestState.mode || "-"}`;
  });

  db.ref("p2p/command").on("value", snap => {
    const cmd = snap.val();
    if (!cmd) return;
    if (!cmd.timestamp || cmd.type !== "solve") return;
    if (cmd.timestamp <= lastSolveTs) return;

    lastSolveTs = cmd.timestamp;
    const mode = cmd.mode || latestState.mode || "reading";
    doSolve(mode);
  });

  async function doSolve(mode) {
    statusEl.textContent = "AI 풀이/생성 중...";
    showModeBox(mode, false);

    const body = {
      mode,
      passage: latestState.passage || "",
      question: latestState.question || "",
      stt: latestState.stt || ""
    };

    try {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) {
        statusEl.textContent = "에러: " + data.error;
        return;
      }
      const text = data.result || "";
      renderByMode(mode, text);
      statusEl.textContent = "완료";
    } catch (e) {
      statusEl.textContent = "요청 실패: " + e.toString();
    }
  }

  function showModeBox(mode, show) {
    boxRL.style.display = "none";
    boxW.style.display  = "none";
    boxS.style.display  = "none";

    if (!show) return;
    if (mode === "reading" || mode === "listening") {
      boxRL.style.display = "block";
    } else if (mode === "writing") {
      boxW.style.display = "block";
    } else if (mode === "speaking") {
      boxS.style.display = "block";
    }
  }

  function renderByMode(mode, text) {
    if (mode === "reading" || mode === "listening") {
      const m = text.match(/\[ANSWER\]\s*([0-5?])/i);
      let ans = m ? m[1] : "?";
      if (ans < "1" || ans > "5") ans = "?";

      let label = "정답: ";
      if (ans >= "1" && ans <= "5") {
        label += ans;
      } else {
        label += "(무응답)";
      }
      rlAnswerEl.textContent = label;

      const split = text.split(/\[WHY\]/i);
      const why = split[1] ? split[1].trim() : "";
      rlWhyEl.textContent = why;

      showModeBox(mode, true);
      return;
    }

    if (mode === "writing") {
      const parts1 = text.split(/\[ESSAY\]/i);
      let essay = "";
      let feedback = "";
      if (parts1.length > 1) {
        const rest = parts1[1];
        const parts2 = rest.split(/\[FEEDBACK\]/i);
        essay = (parts2[0] || "").trim();
        feedback = (parts2[1] || "").trim();
      } else {
        essay = text.trim();
      }
      wEssayEl.textContent = essay;
      wFbEl.textContent = feedback;
      showModeBox(mode, true);
      return;
    }

    if (mode === "speaking") {
      let evalPart = "", modelPart = "", korPart = "";
      const p1 = text.split(/\[EVAL\]/i);
      if (p1.length > 1) {
        const rest1 = p1[1];
        const p2 = rest1.split(/\[MODEL\]/i);
        evalPart = (p2[0] || "").trim();
        const rest2 = p2[1] || "";
        const p3 = rest2.split(/\[KOREAN\]/i);
        modelPart = (p3[0] || "").trim();
        korPart   = (p3[1] || "").trim();
      } else {
        evalPart = text.trim();
      }
      sEvalEl.textContent  = evalPart;
      sModelEl.textContent = modelPart;
      sKorEl.textContent   = korPart;
      showModeBox(mode, true);
      return;
    }

    rlAnswerEl.textContent = "";
    rlWhyEl.textContent = text;
    showModeBox("reading", true);
  }
</script>
</body>
</html>

