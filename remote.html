<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site ì›ê²© ì»¨íŠ¸ë¡¤ëŸ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 10px;
      background: #050505;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #answer {
      font-size: 2.4rem;
      font-weight: 700;
    }
    .btn-row {
      display: flex;
      gap: 8px;
    }
    button {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      background: #2b2b2b;
      color: #fff;
      font-size: 0.9rem;
      cursor: pointer;
      white-space: nowrap;
    }
    button:active { opacity: 0.85; }

    .section-btns button {
      flex: 1;
      font-size: 0.8rem;
    }
    .section-btns button.active {
      background: #0073ff;
    }

    #status {
      font-size: 0.8rem;
      color: #c0c0c0;
      white-space: pre-line;
      min-height: 1.4em;
    }

    .box-title {
      font-size: 0.8rem;
      color: #b0b0b0;
      margin-top: 4px;
      margin-bottom: 2px;
    }
    .box {
      font-size: 0.8rem;
      background: #141414;
      border-radius: 8px;
      padding: 6px;
      white-space: pre-wrap;
      max-height: 5em;
      overflow: auto;
    }

    #image {
      margin-top: 6px;
      max-width: 100%;
      border-radius: 10px;
      background: #000;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div id="answer">ì •ë‹µ: -</div>

    <div class="btn-row">
      <button id="captureQuestionBtn">ğŸ“¸ íœ´ëŒ€í°ì— ë¬¸ì œ ìº¡ì²˜ + í’€ì´</button>
    </div>

    <div class="btn-row section-btns">
      <button data-section="reading"   class="active">Reading</button>
      <button data-section="listening">Listening</button>
      <button data-section="speaking">Speaking</button>
      <button data-section="writing">Writing</button>
    </div>

    <div class="btn-row">
      <button id="capturePassageBtn">ğŸ“Œ í˜„ì¬ í™”ë©´ì„ ì§€ë¬¸ìœ¼ë¡œ OCR (í•œ ë²ˆ)</button>
    </div>

    <div id="status">ì¤€ë¹„ë¨</div>

    <div class="box-title">ì§€ë¬¸ ìš”ì•½</div>
    <div id="passageBox" class="box">(ì§€ë¬¸ ì—†ìŒ)</div>

    <div class="box-title">ë¬¸ì œ OCR í…ìŠ¤íŠ¸</div>
    <div id="questionBox" class="box">(ë¬¸ì œ ì—†ìŒ)</div>

    <img id="image" alt="ìº¡ì²˜ ì´ë¯¸ì§€" />
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const ROOM_ID = "room1";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const commandRef = ref(db, `rooms/${ROOM_ID}/command`);
    const resultRef  = ref(db, `rooms/${ROOM_ID}/result`);

    const captureQuestionBtn = document.getElementById("captureQuestionBtn");
    const capturePassageBtn = document.getElementById("capturePassageBtn");
    const statusEl = document.getElementById("status");
    const answerEl = document.getElementById("answer");
    const passageBox = document.getElementById("passageBox");
    const questionBox = document.getElementById("questionBox");
    const imageEl = document.getElementById("image");
    const sectionButtons = Array.from(document.querySelectorAll(".section-btns button"));

    let selectedSection = "reading";
    let lastResultTime = 0;

    // ===== ì˜ì—­ ë²„íŠ¼ ì„ íƒ =====
    sectionButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        sectionButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        selectedSection = btn.dataset.section || "reading";
      });
    });

    // ===== ì›ê²© ëª…ë ¹ ë³´ë‚´ê¸° =====
    async function sendCommand(mode) {
      const reqId = Date.now().toString();
      const section = selectedSection;

      statusEl.textContent =
        (mode === "passage" ? "ì§€ë¬¸ OCR ìš”ì²­ ì „ì†¡ ì¤‘â€¦" : "ë¬¸ì œ ìº¡ì²˜ + í’€ì´ ìš”ì²­ ì „ì†¡ ì¤‘â€¦") +
        ` (ID: ${reqId}, section: ${section})`;

      try {
        await set(commandRef, {
          type: "capture",
          mode,
          section,
          requestId: reqId,
          requestedAt: Date.now()
        });

        statusEl.textContent =
          (mode === "passage"
            ? "ì§€ë¬¸ OCR ìš”ì²­ ì „ì†¡ ì™„ë£Œ. íœ´ëŒ€í° ì²˜ë¦¬ ëŒ€ê¸° ì¤‘â€¦"
            : "ë¬¸ì œ ìº¡ì²˜ + í’€ì´ ìš”ì²­ ì „ì†¡ ì™„ë£Œ. íœ´ëŒ€í° ì²˜ë¦¬ ëŒ€ê¸° ì¤‘â€¦");
      } catch (err) {
        console.error(err);
        statusEl.textContent = "ìš”ì²­ ì „ì†¡ ì˜¤ë¥˜: " + err.message;
        alert("ìš”ì²­ ì „ì†¡ ì˜¤ë¥˜: " + err.message);
      }
    }

    captureQuestionBtn.addEventListener("click", () => sendCommand("question"));
    capturePassageBtn.addEventListener("click", () => sendCommand("passage"));

    // ===== ê²°ê³¼ ìˆ˜ì‹  =====
    onValue(resultRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const updatedAt = data.updatedAt || 0;
      if (updatedAt <= lastResultTime) return;
      lastResultTime = updatedAt;

      const kind = data.kind || "question";
      const section = data.section || "unknown";
      const answer = data.answer || "";
      const passageSnippet = data.passageSnippet || "";
      const text = data.text || "";
      const img = data.image || "";

      if (kind === "passage") {
        statusEl.textContent = `ì§€ë¬¸ OCR ì™„ë£Œ (${section})`;
        passageBox.textContent = passageSnippet || "(ì§€ë¬¸ ì—†ìŒ)";
        // ì •ë‹µì€ ê·¸ëŒ€ë¡œ ë‘ê³ , ë¬¸ì œ ë°•ìŠ¤/ì´ë¯¸ì§€ëŠ” ê±´ë“œë¦¬ì§€ ì•ŠìŒ
      } else {
        statusEl.textContent = `ë¬¸ì œ í’€ì´ ê²°ê³¼ ìˆ˜ì‹  (${section})`;
        answerEl.textContent = answer ? `ì •ë‹µ: ${answer}` : "ì •ë‹µ: -";
        questionBox.textContent = text || "(ë¬¸ì œ ì—†ìŒ)";
        if (img) {
          imageEl.src = img;
          imageEl.style.display = "block";
        } else {
          imageEl.src = "";
          imageEl.style.display = "none";
        }
        if (passageSnippet) {
          passageBox.textContent = passageSnippet;
        }
      }
    });
  </script>
</body>
</html>
