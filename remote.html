<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>answer-site | Result</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 10px;
      background: #f5f5f5;
      box-sizing: border-box;
      display: flex;
      justify-content: center;
    }
    .wrap {
      width: 100%;
      box-sizing: border-box;
    }
    h2 {
      margin: 2px 0 4px 0;
      font-size: 18px;
    }
    #modeLabel {
      font-size: 12px;
      color:#555;
    }
    #status {
      font-size: 11px;
      color:#555;
      margin-top:4px;
    }

    .box {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .answer-big {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 6px;
      word-break: break-all;
    }
    pre {
      white-space: pre-wrap;
      margin: 0;
      font-size: 13px;
      line-height: 1.5;
      font-family: "SF Mono", Menlo, Monaco, Consolas, monospace;
    }
    h3 {
      margin: 8px 0 4px 0;
      font-size: 15px;
    }

    #previewVideo {
      width: 100%;
      max-height: 220px;
      border-radius: 8px;
      background: #000;
      object-fit: cover;
    }
    #camStatus {
      font-size: 11px;
      color:#777;
      margin-top: 4px;
    }

    @media (orientation: landscape) {
      body { padding: 8px; }
      h2 { font-size: 17px; }
      .answer-big { font-size: 22px; }
      pre { font-size: 13px; }
    }
  </style>
</head>
<body>

<div class="wrap">
  <h2>answer-site Result</h2>
  <div id="modeLabel">모드: -</div>
  <div id="status"></div>

  <!-- Reading / Listening -->
  <div id="box-rl" class="box" style="display:none;">
    <div class="answer-big" id="rl-answer"></div>
    <pre id="rl-why"></pre>
  </div>

  <!-- Writing -->
  <div id="box-writing" class="box" style="display:none;">
    <h3>Essay</h3>
    <pre id="w-essay"></pre>
    <h3>Feedback (Korean)</h3>
    <pre id="w-feedback"></pre>
  </div>

  <!-- Speaking -->
  <div id="box-speaking" class="box" style="display:none;">
    <h3>Evaluation</h3>
    <pre id="s-eval"></pre>
    <h3>Model Answer</h3>
    <pre id="s-model"></pre>
    <h3>Korean Tips</h3>
    <pre id="s-korean"></pre>
  </div>

  <!-- 현재 이 기기 카메라 미리보기 -->
  <div id="box-preview" class="box">
    <h3>현재 카메라 미리보기 (이 기기)</h3>
    <video id="previewVideo" autoplay playsinline></video>
    <div id="camStatus">카메라 준비 중...</div>
  </div>
</div>

<script>
  // ---------------- Firebase ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const modeLabel = document.getElementById('modeLabel');
  const statusEl  = document.getElementById('status');

  const boxRL      = document.getElementById('box-rl');
  const boxW       = document.getElementById('box-writing');
  const boxS       = document.getElementById('box-speaking');

  const rlAnswerEl = document.getElementById('rl-answer');
  const rlWhyEl    = document.getElementById('rl-why');
  const wEssayEl   = document.getElementById('w-essay');
  const wFbEl      = document.getElementById('w-feedback');
  const sEvalEl    = document.getElementById('s-eval');
  const sModelEl   = document.getElementById('s-model');
  const sKorEl     = document.getElementById('s-korean');

  const previewVideo = document.getElementById('previewVideo');
  const camStatus    = document.getElementById('camStatus');

  let latestState = { mode: "reading" };
  let lastSolveTs = 0;

  db.ref("p2p/state").on("value", snap => {
    latestState = snap.val() || {};
    modeLabel.textContent = `모드: ${latestState.mode || "-"}`;
  });

  db.ref("p2p/command").on("value", snap => {
    const cmd = snap.val();
    if (!cmd) return;
    if (!cmd.timestamp || cmd.type !== "solve") return;
    if (cmd.timestamp <= lastSolveTs) return;

    lastSolveTs = cmd.timestamp;
    const mode = cmd.mode || latestState.mode || "reading";
    doSolve(mode);
  });

  async function doSolve(mode) {
    statusEl.textContent = "AI 풀이/생성 중...";
    showModeBox(mode, false);

    const body = {
      mode,
      passage: latestState.passage || "",
      question: latestState.question || "",
      stt: latestState.stt || ""
    };

    try {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.error) {
        statusEl.textContent = "에러: " + data.error;
        return;
      }
      const text = data.result || "";
      renderByMode(mode, text);
      statusEl.textContent = "완료";
    } catch (e) {
      statusEl.textContent = "요청 실패: " + e.toString();
    }
  }

  function showModeBox(mode, show) {
    boxRL.style.display = "none";
    boxW.style.display  = "none";
    boxS.style.display  = "none";

    if (!show) return;
    if (mode === "reading" || mode === "listening") {
      boxRL.style.display = "block";
    } else if (mode === "writing") {
      boxW.style.display = "block";
    } else if (mode === "speaking") {
      boxS.style.display = "block";
    }
  }

  function renderByMode(mode, text) {
    if (mode === "reading" || mode === "listening") {
      // ANSWER 전체 줄
      const mAns = text.match(/\[ANSWER\]\s*([^\n\r]+)/i);
      let ansText = mAns ? mAns[1].trim() : "";
      if (!ansText) ansText = "?";
      rlAnswerEl.textContent = "정답: " + ansText;

      // WHY 이후 전체
      const split = text.split(/\[WHY\]/i);
      const why = split[1] ? split[1].trim() : "";
      rlWhyEl.textContent = why;

      showModeBox(mode, true);
      return;
    }

    if (mode === "writing") {
      const parts1 = text.split(/\[ESSAY\]/i);
      let essay = "";
      let feedback = "";
      if (parts1.length > 1) {
        const rest = parts1[1];
        const parts2 = rest.split(/\[FEEDBACK\]/i);
        essay = (parts2[0] || "").trim();
        feedback = (parts2[1] || "").trim();
      } else {
        essay = text.trim();
      }
      wEssayEl.textContent = essay;
      wFbEl.textContent = feedback;
      showModeBox(mode, true);
      return;
    }

    if (mode === "speaking") {
      let evalPart = "", modelPart = "", korPart = "";
      const p1 = text.split(/\[EVAL\]/i);
      if (p1.length > 1) {
        const rest1 = p1[1];
        const p2 = rest1.split(/\[MODEL\]/i);
        evalPart = (p2[0] || "").trim();
        const rest2 = p2[1] || "";
        const p3 = rest2.split(/\[KOREAN\]/i);
        modelPart = (p3[0] || "").trim();
        korPart   = (p3[1] || "").trim();
      } else {
        evalPart = text.trim();
      }
      sEvalEl.textContent  = evalPart;
      sModelEl.textContent = modelPart;
      sKorEl.textContent   = korPart;
      showModeBox(mode, true);
      return;
    }

    // fallback
    rlAnswerEl.textContent = "";
    rlWhyEl.textContent = text;
    showModeBox("reading", true);
  }

  // ---------------- 이 기기 카메라 미리보기 ----------------
  async function startPreviewCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      camStatus.textContent = "이 브라우저는 카메라를 지원하지 않습니다.";
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false
      });
      previewVideo.srcObject = stream;
      camStatus.textContent = "카메라 미리보기 중 (이 기기)";
    } catch (e) {
      console.warn("preview camera error", e);
      camStatus.textContent = "카메라 접근 실패 (권한/설정 확인).";
    }
  }

  startPreviewCamera();
</script>
</body>
</html>

