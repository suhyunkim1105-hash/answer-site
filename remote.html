<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>answer-site | Remote</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 10px;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    .wrap {
      max-width: 640px;
      margin: 0 auto;
    }

    .mode-bar {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }

    .mode-btn {
      flex: 1 1 0;
      padding: 8px 4px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #ddd;
      font-size: 13px;
    }
    .mode-btn.active {
      background: #0b5cff;
      border-color: #0b5cff;
      color: #fff;
      font-weight: 600;
    }

    #statusLine, #aiStatusLine, #sttStatusLine {
      font-size: 11px;
      color: #aaa;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #answerCard {
      background: #111;
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      border: 1px solid #222;
    }

    #answerMain {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      min-height: 26px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    #answerProb {
      font-size: 11px;
      color: #9fd1ff;
      margin-bottom: 6px;
      min-height: 14px;
    }

    #answerDetail {
      font-size: 12px;
      line-height: 1.4;
      background: #050505;
      border-radius: 6px;
      padding: 8px;
      max-height: 260px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .btn-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    button {
      font-family: inherit;
    }

    .btn-primary {
      width: 100%;
      padding: 10px 6px;
      border-radius: 999px;
      border: none;
      background: #0b5cff;
      color: #fff;
      font-size: 15px;
      font-weight: 600;
    }
    .btn-primary:active {
      transform: scale(0.98);
    }

    .btn-secondary {
      width: 100%;
      padding: 8px 6px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #111;
      color: #eee;
      font-size: 13px;
    }
    .btn-secondary:active {
      transform: scale(0.98);
    }

    #btnToggleDebug {
      margin-top: 8px;
      font-size: 11px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #050505;
      color: #ccc;
    }

    #debugPanel {
      margin-top: 6px;
      padding: 8px;
      border-radius: 8px;
      background: #050505;
      border: 1px solid #222;
      font-size: 11px;
      max-height: 280px;
      overflow-y: auto;
    }
    #debugPanel.hidden {
      display: none;
    }

    .dbg-title {
      font-weight: 600;
      color: #7fd6ff;
      margin: 4px 0 2px;
    }

    .dbg-pre {
      background: #000;
      border-radius: 4px;
      padding: 4px;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 80px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="mode-bar">
    <button class="mode-btn active" data-mode="reading">Reading</button>
    <button class="mode-btn" data-mode="listening">Listening</button>
    <button class="mode-btn" data-mode="writing">Writing</button>
    <button class="mode-btn" data-mode="speaking">Speaking</button>
  </div>

  <div id="statusLine">ì„¹ì…˜: reading Â· OCR: - Â· ì¹´ë©”ë¼ ìƒíƒœ: -</div>

  <div id="answerCard">
    <div id="answerMain"></div>
    <div id="answerProb"></div>
    <pre id="answerDetail"></pre>
  </div>

  <div class="btn-group">
    <button id="btnSolve" class="btn-primary">ì´ ì§ˆë¬¸ í’€ê¸°</button>
    <button id="btnAccumulate" class="btn-secondary">ì§€ë¬¸ ëˆ„ì  (ê¸´ ì§€ë¬¸ìš©)</button>
    <button id="btnReset" class="btn-secondary">ì´ ì„¸ì…˜ ì´ˆê¸°í™”</button>
    <button id="btnSTT" class="btn-secondary">ìŒì„± ì¸ì‹ ì‹œì‘ (Listening/Speaking)</button>
  </div>

  <div id="aiStatusLine">AI í’€ì´ ì „.</div>
  <div id="sttStatusLine">STT: êº¼ì§</div>

  <button id="btnToggleDebug">ë””ë²„ê·¸ ë³´ê¸° í† ê¸€ (OCR/ìŒì„±/ì§€ë¬¸)</button>

  <div id="debugPanel" class="hidden">
    <div class="dbg-title">OCR í…ìŠ¤íŠ¸ (í˜„ì¬ í™”ë©´)</div>
    <pre id="dbgOcrCurrent" class="dbg-pre"></pre>

    <div class="dbg-title">ì§€ë¬¸ í…ìŠ¤íŠ¸ (ëˆ„ì )</div>
    <pre id="dbgOcrAccum" class="dbg-pre"></pre>

    <div class="dbg-title">ìŒì„± í…ìŠ¤íŠ¸ (STT)</div>
    <pre id="dbgAudio" class="dbg-pre"></pre>
  </div>
</div>

<script>
  // ---------------- Firebase ----------------
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // --------------- DOM refs -----------------
  const modeButtons = Array.from(document.querySelectorAll(".mode-btn"));
  const statusLine  = document.getElementById("statusLine");
  const answerMain  = document.getElementById("answerMain");
  const answerProb  = document.getElementById("answerProb");
  const answerDetail= document.getElementById("answerDetail");
  const aiStatusLine= document.getElementById("aiStatusLine");
  const sttStatusLine = document.getElementById("sttStatusLine");

  const btnSolve      = document.getElementById("btnSolve");
  const btnAccumulate = document.getElementById("btnAccumulate");
  const btnReset      = document.getElementById("btnReset");
  const btnSTT        = document.getElementById("btnSTT");
  const btnToggleDebug= document.getElementById("btnToggleDebug");

  const debugPanel    = document.getElementById("debugPanel");
  const dbgOcrCurrent = document.getElementById("dbgOcrCurrent");
  const dbgOcrAccum   = document.getElementById("dbgOcrAccum");
  const dbgAudio      = document.getElementById("dbgAudio");

  // --------------- State -----------------
  let currentSection = "reading";

  let latestOcrText   = "";
  let latestOcrConf   = null;
  let cameraBlocked   = false;

  let questionAccumText = ""; // ê¸´ ì§€ë¬¸ ëˆ„ì ìš©
  let sttText           = ""; // STT ê²°ê³¼ ì „ì²´

  let solving       = false;
  let lastCommandTs = 0;

  // STT ê´€ë ¨
  let recognition        = null;
  let sttShouldRestart   = false;
  let sttActive          = false;
  let sttSupported       = true;
  let lastSttError       = "";

  // ------------- UI helpers ----------------
  function sectionLabel(mode) {
    switch (mode) {
      case "reading":   return "reading";
      case "listening": return "listening";
      case "writing":   return "writing";
      case "speaking":  return "speaking";
      default:          return mode;
    }
  }

  function updateStatusLine() {
    let ocrPart = "OCR: -";
    if (latestOcrText && latestOcrText.trim().length > 0) {
      const confStr = (typeof latestOcrConf === "number")
        ? latestOcrConf.toFixed(1) + "%"
        : "?";
      ocrPart = "OCR: conf=" + confStr + " (ì™„ë£Œ)";
    }
    const camPart = cameraBlocked ? "ì¹´ë©”ë¼ ìƒíƒœ: ê°€ë ¤ì§" : "ì¹´ë©”ë¼ ìƒíƒœ: ì •ìƒ";
    statusLine.textContent =
      "ì„¹ì…˜: " + sectionLabel(currentSection) + " Â· " + ocrPart + " Â· " + camPart;
  }

  function updateDebugPanel() {
    dbgOcrCurrent.textContent = latestOcrText || "(ì—†ìŒ)";
    dbgOcrAccum.textContent   = questionAccumText || "(ì—†ìŒ)";
    dbgAudio.textContent      = sttText || "(ì—†ìŒ)";
  }

  function updateSttStatus() {
    if (!sttSupported) {
      sttStatusLine.textContent = "STT: ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
      return;
    }
    const wordCount = sttText ? sttText.trim().split(/\s+/).length : 0;
    let base = sttActive ? "STT: ì¸ì‹ ì¤‘" : "STT: ëŒ€ê¸°/ì¤‘ì§€";
    if (wordCount > 0) base += ` Â· ëˆ„ì  ${wordCount}ë‹¨ì–´`;
    if (lastSttError) base += ` Â· ë§ˆì§€ë§‰ ì˜¤ë¥˜: ${lastSttError}`;
    sttStatusLine.textContent = base;
  }

  function setMode(mode) {
    currentSection = mode;
    modeButtons.forEach(btn => {
      btn.classList.toggle("active", btn.dataset.mode === mode);
    });
    updateStatusLine();

    // index.html ìª½ì— í˜„ì¬ ëª¨ë“œ ì•Œë ¤ì£¼ê¸°
    db.ref("p2p/state").update({
      modeHint: mode,
      modeUpdatedAt: Date.now()
    });
  }

  modeButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const mode = btn.dataset.mode;
      setMode(mode);
    });
  });

  // --------------- Firebase listeners ---------------
  // p2p/state êµ¬ë…: OCR / ì¹´ë©”ë¼ ìƒíƒœ
  db.ref("p2p/state").on("value", snap => {
    const v = snap.val() || {};
    latestOcrText = v.ocrText || "";
    latestOcrConf = typeof v.ocrConfidence === "number" ? v.ocrConfidence : null;
    cameraBlocked = !!v.cameraBlocked;
    updateStatusLine();
    updateDebugPanel();
  });

  // p2p/command êµ¬ë…: reading/listening ìë™ í’€ì´ìš©
  db.ref("p2p/command").on("value", snap => {
    const cmd = snap.val();
    if (!cmd || cmd.type !== "solve") return;

    const ts = cmd.timestamp || 0;
    if (ts <= lastCommandTs) return;
    lastCommandTs = ts;

    // ìë™ í’€ì´ëŠ” reading / listening ì—ì„œë§Œ
    if (currentSection === "reading" || currentSection === "listening") {
      solveCurrentQuestion("auto");
    }
  });

  // --------------- STT (Web Speech API) ----------------
  function ensureRecognizer() {
    if (recognition) return recognition;

    const SR =
      window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (!SR) {
      sttSupported = false;
      updateSttStatus();
      alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” Web Speech API(ìŒì„± ì¸ì‹)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. STT ì—†ì´ë„ ì‚¬ì´íŠ¸ëŠ” ë™ì‘í•˜ì§€ë§Œ, Listening/Speaking í†µí•© ê¸°ëŠ¥ì€ ì œí•œë©ë‹ˆë‹¤.");
      return null;
    }

    recognition = new SR();
    recognition.lang = "en-US";
    recognition.interimResults = true;   // ì¤‘ê°„ ê²°ê³¼ ë°›ê¸°
    recognition.continuous = true;

    recognition.onresult = (event) => {
      let finalChunk = "";
      let interimChunk = "";
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        if (!res[0] || !res[0].transcript) continue;
        if (res.isFinal) {
          finalChunk += res[0].transcript + " ";
        } else {
          interimChunk += res[0].transcript + " ";
        }
      }
      if (finalChunk) {
        sttText += (sttText ? " " : "") + finalChunk.trim();
      }
      const combined =
        (sttText || "") +
        (interimChunk ? " " + interimChunk.trim() : "");
      dbgAudio.textContent = combined.trim() || "(ì—†ìŒ)";
      lastSttError = "";
      updateSttStatus();
    };

    recognition.onerror = (event) => {
      console.warn("STT error:", event.error);
      lastSttError = event.error || "unknown";
      updateSttStatus();
    };

    recognition.onend = () => {
      sttActive = false;
      updateSttStatus();
      if (sttShouldRestart) {
        try {
          recognition.start();
          sttActive = true;
        } catch (e) {
          console.warn("STT ì¬ì‹œì‘ ì‹¤íŒ¨:", e);
          lastSttError = e && e.message ? e.message : "restart failed";
          sttShouldRestart = false;
        }
        updateSttStatus();
      }
      updateSttButton();
    };

    return recognition;
  }

  function updateSttButton() {
    btnSTT.textContent = sttActive
      ? "ìŒì„± ì¸ì‹ ì¤‘ì§€"
      : "ìŒì„± ì¸ì‹ ì‹œì‘ (Listening/Speaking)";
  }

  function startSTT() {
    const rec = ensureRecognizer();
    if (!rec) return;
    if (sttActive) return;

    try {
      sttShouldRestart = true;
      lastSttError = "";
      rec.start();
      sttActive = true;
      updateSttButton();
      updateSttStatus();
    } catch (e) {
      console.warn("STT start ì‹¤íŒ¨:", e);
      lastSttError = e && e.message ? e.message : "start failed";
      updateSttStatus();
    }
  }

  function stopSTT() {
    sttShouldRestart = false;
    if (recognition && sttActive) {
      try {
        recognition.stop();
      } catch (e) {
        console.warn("STT stop ì‹¤íŒ¨:", e);
      }
    }
    sttActive = false;
    updateSttButton();
    updateSttStatus();
  }

  btnSTT.addEventListener("click", () => {
    if (!sttActive) startSTT();
    else stopSTT();
  });

  // --------------- Solve ë²„íŠ¼ / ëˆ„ì  / ì´ˆê¸°í™” ---------------
  btnAccumulate.addEventListener("click", () => {
    const text = (latestOcrText || "").trim();
    if (!text) return;
    if (!questionAccumText.includes(text)) {
      questionAccumText += (questionAccumText ? "\n\n" : "") + text;
      updateDebugPanel();
    }
  });

  btnReset.addEventListener("click", () => {
    questionAccumText = "";
    sttText = "";
    lastSttError = "";
    stopSTT();
    answerMain.textContent = "";
    answerProb.textContent = "";
    answerDetail.textContent = "";
    aiStatusLine.textContent = "AI í’€ì´ ì „.";
    updateDebugPanel();
    updateSttStatus();
  });

  btnSolve.addEventListener("click", () => {
    solveCurrentQuestion("manual");
  });

  btnToggleDebug.addEventListener("click", () => {
    debugPanel.classList.toggle("hidden");
  });

  // --------------- AI í˜¸ì¶œ ---------------
  function showErrorAnswer(mode, message) {
    if (mode === "writing") {
      answerMain.textContent = "ëª¨ë²” ì—ì„¸ì´ ìƒì„± ì‹¤íŒ¨";
      answerProb.textContent = "";
      answerDetail.textContent =
        "[ì˜¤ë¥˜]\n" +
        (message || "ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ì—ì„¸ì´ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    } else if (mode === "speaking") {
      answerMain.textContent = "(ìŠ¤í”¼í‚¹ ë‹µì•ˆ ìƒì„± ì‹¤íŒ¨)";
      answerProb.textContent = "";
      answerDetail.textContent =
        "[ì˜¤ë¥˜]\n" +
        (message || "ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    } else {
      answerMain.textContent = "?";
      answerProb.textContent = "ë§ì„ í™•ë¥ (ì¶”ì •): 0%";
      answerDetail.textContent =
        "[ì˜¤ë¥˜]\n" +
        (message || "ì„œë²„ ì˜¤ë¥˜ë¡œ ì¸í•´ ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
    }
    aiStatusLine.textContent = "AI í’€ì´ ì‹¤íŒ¨.";
  }

  async function solveCurrentQuestion(trigger) {
    if (solving) return;
    const mode = currentSection;

    const effectiveOcr = (questionAccumText.trim() || latestOcrText.trim());
    const effectiveLen = effectiveOcr.replace(/\s+/g, "").length;
    const conf = (typeof latestOcrConf === "number") ? latestOcrConf : 0;

    // OCR í’ˆì§ˆì´ ë„ˆë¬´ ë–¨ì–´ì§€ë©´ ê·¸ëƒ¥ ê±´ë„ˆëœ€
    if (!effectiveOcr || effectiveLen < 10 || conf < 10) {
      answerMain.textContent = "?";
      answerProb.textContent = "ë§ì„ í™•ë¥ (ì¶”ì •): 0%";
      answerDetail.textContent =
        "OCR í…ìŠ¤íŠ¸ê°€ ë„ˆë¬´ ì§§ê±°ë‚˜ ì‹ ë¢°ë„(conf)ê°€ 10% ë¯¸ë§Œì´ë¼ì„œ í’€ì´ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.\n" +
        "í™”ë©´ì„ ë” ê°€ê¹ê²Œ/ì„ ëª…í•˜ê²Œ ì°ê³  ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
      aiStatusLine.textContent = "AI í’€ì´ ìƒëµ (OCR í’ˆì§ˆ ë¶€ì¡±).";
      return;
    }

    // ğŸ”´ STT ì¤‘ì§€ ê·œì¹™:
    // - Speaking/Listeningì—ì„œ
    // - ë„¤ê°€ ì§ì ‘ 'ì´ ì§ˆë¬¸ í’€ê¸°'ë¥¼ ëˆŒëŸ¬ì„œ ìˆ˜ë™ í’€ì´ì¼ ë•Œë§Œ(stopSTT).
    // - ì¹´ë©”ë¼ ìë™ í’€ì´(auto) ë•ŒëŠ” STT ê±´ë“œë¦¬ì§€ ì•ŠìŒ.
    if (trigger === "manual" && (mode === "speaking" || mode === "listening")) {
      stopSTT();
    }

    solving = true;
    aiStatusLine.textContent = "AI í’€ì´ ì¤‘...";

    try {
      const payload = {
        mode,
        ocrText: effectiveOcr,
        audioText: sttText.trim(),
        questionAccum: questionAccumText.trim(),
        source: trigger || "manual"
      };

      const resp = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!resp.ok) {
        const msg = "ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ (status " + resp.status + ").";
        showErrorAnswer(mode, msg);
        return;
      }

      const data = await resp.json();
      const raw = (data && data.text) ? data.text : "";
      renderAiResult(raw, mode);
      aiStatusLine.textContent = "AI í’€ì´ ì™„ë£Œ.";
    } catch (e) {
      const msg = "ë„¤íŠ¸ì›Œí¬/ìš”ì²­ ì¤‘ ì˜¤ë¥˜: " + (e && e.message ? e.message : e);
      showErrorAnswer(mode, msg);
    } finally {
      solving = false;
    }
  }

  // --------------- AI ê²°ê³¼ íŒŒì‹± ---------------
  function renderAiResult(raw, mode) {
    const text = (raw || "").trim();
    if (!text) {
      showErrorAnswer(mode, "AI ì‘ë‹µì´ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      return;
    }

    if (mode === "writing") {
      const mEssay = text.match(/\[ESSAY\]([\s\S]*?)(?:\[FEEDBACK\]|\Z)/i);
      const mFb    = text.match(/\[FEEDBACK\]([\s\S]*)$/i);
      const essay  = mEssay ? mEssay[1].trim() : text;
      const fb     = mFb ? mFb[1].trim() : "";

      answerMain.textContent = "ëª¨ë²” ì—ì„¸ì´";
      answerProb.textContent = "";
      answerDetail.textContent =
        essay +
        (fb ? "\n\n[í”¼ë“œë°±]\n" + fb : "");
      return;
    }

    if (mode === "speaking") {
      const mAns   = text.match(/\[ANSWER\]([\s\S]*?)(?:\[WORDS\]|\[KOREAN\]|\Z)/i);
      const mWords = text.match(/\[WORDS\]([\s\S]*?)(?:\[KOREAN\]|\Z)/i);
      const mKor   = text.match(/\[KOREAN\]([\s\S]*)$/i);

      const script = mAns ? mAns[1].trim() : text;
      const words  = mWords ? mWords[1].trim() : "";
      const kor    = mKor ? mKor[1].trim() : "";

      answerMain.textContent = script;
      answerProb.textContent = "";
      let detail = "";
      if (words) {
        detail += "[ë°œìŒ ë„ì›€]\n" + words.trim() + "\n\n";
      }
      if (kor) {
        detail += "[í•œêµ­ì–´ ìš”ì•½/íŒ]\n" + kor.trim();
      }
      answerDetail.textContent = detail || text;
      return;
    }

    // ê¸°ë³¸: reading / listening
    let answer = "?";
    let p = 0;
    let why = "";

    const mAns = text.match(/\[ANSWER\][^\S\r\n]*([^\n]+)/i);
    if (mAns) {
      answer = mAns[1].trim();
    }

    const mP = text.match(/\[P\][^\S\r\n]*([0-9.]+)/i);
    if (mP) {
      const val = parseFloat(mP[1]);
      if (!isNaN(val)) {
        p = Math.max(0, Math.min(1, val));
      }
    }

    const mWhy = text.match(/\[WHY\]([\s\S]*)$/i);
    if (mWhy) {
      why = mWhy[1].trim();
    }

    answerMain.textContent = answer;
    answerProb.textContent = "ë§ì„ í™•ë¥ (ì¶”ì •): " + Math.round(p * 100) + "%";
    answerDetail.textContent = why || text;
  }

  // ì´ˆê¸° ìƒíƒœ ë°˜ì˜
  updateStatusLine();
  updateDebugPanel();
  updateSttStatus();
  updateSttButton();
</script>
</body>
</html>
