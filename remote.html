<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>answer-site | Remote</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #000;
      color: #fff;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .page {
      padding-bottom: 150px;
    }

    .section-row {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    .section-btn {
      flex: 1 1 0;
      text-align: center;
      padding: 6px 0;
      border-radius: 999px;
      border: 1px solid #333;
      font-size: 12px;
      background: #111;
      color: #ddd;
    }
    .section-btn.active {
      background: #1e88ff;
      border-color: #1e88ff;
      color: #fff;
    }

    #answerSection {
      padding: 10px 12px;
      border-radius: 10px;
      background: #111;
      margin-bottom: 8px;
    }
    #answerMain {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 4px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #answerMeta {
      font-size: 11px;
      color: #aaa;
    }
    #answerRaw {
      margin-top: 8px;
      font-size: 12px;
      background: #050505;
      border-radius: 6px;
      padding: 6px;
      max-height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-break: break-word;
    }

    #debugToggle {
      margin: 8px 0 4px;
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
    }
    #debugPanel {
      display: none;
      border-radius: 8px;
      background: #080808;
      padding: 8px;
      margin-bottom: 8px;
    }
    #debugPanel h3 {
      margin: 4px 0;
      font-size: 11px;
      color: #7ee0ff;
    }
    pre {
      margin: 0 0 6px;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
      background: #020202;
      padding: 4px;
      border-radius: 4px;
      max-height: 140px;
      overflow-y: auto;
    }

    #readingControls,
    #listeningControls {
      margin-bottom: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    .small-btn {
      flex: 1 1 0;
      padding: 6px 4px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
      text-align: center;
    }

    #statusLines {
      font-size: 11px;
      color: #ccc;
      margin-bottom: 4px;
    }
    #statusLines div { margin-bottom: 2px; }

    #bottomBar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      padding: 8px;
      background: rgba(0,0,0,0.95);
      border-top: 1px solid #222;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    #btnSolveQuestion {
      width: 100%;
      padding: 12px 0;
      font-size: 15px;
      font-weight: 600;
      border-radius: 999px;
      border: none;
      background: #1e88ff;
      color: #fff;
    }
    #btnSolveQuestion:disabled {
      opacity: 0.6;
    }
    #btnStt {
      width: 100%;
      padding: 10px 0;
      font-size: 13px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #111;
      color: #eee;
    }
    #btnStt.listening {
      background: #00c853;
      border-color: #00c853;
      color: #000;
    }
    #sttStatus {
      font-size: 11px;
      color: #aaa;
      text-align: center;
    }
  </style>
</head>
<body>
<div class="page">
  <div class="section-row">
    <button class="section-btn active" data-section="reading">Reading</button>
    <button class="section-btn" data-section="listening">Listening</button>
    <button class="section-btn" data-section="writing">Writing</button>
    <button class="section-btn" data-section="speaking">Speaking</button>
  </div>

  <section id="answerSection">
    <div id="answerMain">아직 정답 없음</div>
    <div id="answerMeta">섹션: reading · 확신도: -</div>
    <div id="answerRaw"></div>
  </section>

  <button id="debugToggle">디버그 보기 토글 (OCR/음성/지문)</button>

  <section id="debugPanel">
    <h3>OCR 텍스트 (현재 화면)</h3>
    <pre id="ocrPreview"></pre>

    <h3>지문 텍스트 (누적)</h3>
    <pre id="passagePreview"></pre>

    <h3>음성 텍스트 (STT)</h3>
    <pre id="audioPreview"></pre>
  </section>

  <div id="readingControls">
    <button id="btnPassageStart" class="small-btn">지문 스캔 시작(초기화)</button>
    <button id="btnPassageAdd" class="small-btn">화면 추가 (지문)</button>
  </div>

  <div id="listeningControls">
    <button id="btnListeningReset" class="small-btn">리스닝 세트 초기화</button>
  </div>

  <div id="statusLines">
    <div id="cameraStatus">카메라 상태: -</div>
    <div id="ocrStatus">OCR: -</div>
    <div id="passageStatus">지문: -</div>
    <div id="sttLine">STT: 대기 중</div>
  </div>
</div>

<div id="bottomBar">
  <button id="btnSolveQuestion">이 질문 풀기</button>
  <button id="btnStt">음성 인식 시작 (Listening/Speaking)</button>
  <div id="sttStatus">이 브라우저에서 음성 인식을 사용합니다.</div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const answerMain      = document.getElementById("answerMain");
  const answerMeta      = document.getElementById("answerMeta");
  const answerRaw       = document.getElementById("answerRaw");
  const ocrPreview      = document.getElementById("ocrPreview");
  const passagePreview  = document.getElementById("passagePreview");
  const audioPreview    = document.getElementById("audioPreview");
  const cameraStatus    = document.getElementById("cameraStatus");
  const ocrStatus       = document.getElementById("ocrStatus");
  const passageStatus   = document.getElementById("passageStatus");
  const sttLine         = document.getElementById("sttLine");
  const btnSolveQuestion= document.getElementById("btnSolveQuestion");
  const btnStt          = document.getElementById("btnStt");
  const sttStatus       = document.getElementById("sttStatus");
  const debugToggle     = document.getElementById("debugToggle");
  const debugPanel      = document.getElementById("debugPanel");
  const btnPassageStart = document.getElementById("btnPassageStart");
  const btnPassageAdd   = document.getElementById("btnPassageAdd");
  const readingControls = document.getElementById("readingControls");
  const listeningControls = document.getElementById("listeningControls");
  const btnListeningReset = document.getElementById("btnListeningReset");

  let currentSection = "reading";
  let currentConfidenceText = "-";

  const sectionButtons = Array.prototype.slice.call(
    document.querySelectorAll(".section-btn")
  );
  sectionButtons.forEach(function(btn) {
    btn.addEventListener("click", function() {
      const sec = btn.getAttribute("data-section");
      currentSection = sec;
      sectionButtons.forEach(function(b){ b.classList.remove("active"); });
      btn.classList.add("active");
      answerMeta.textContent = "섹션: " + currentSection + " · 확신도: " + currentConfidenceText;

      readingControls.style.display = (sec === "reading") ? "flex" : "none";
      listeningControls.style.display = (sec === "listening") ? "flex" : "none";

      db.ref("p2p/state").update({
        modeHint: currentSection,
        modeUpdatedAt: Date.now()
      });
    });
  });

  debugToggle.addEventListener("click", function() {
    if (!debugPanel.style.display || debugPanel.style.display === "none") {
      debugPanel.style.display = "block";
    } else {
      debugPanel.style.display = "none";
    }
  });

  let latestState = {
    ocrText: "",
    ocrConfidence: 0,
    audioText: "",
    cameraBlocked: false,
    ocrUpdatedAt: 0,
    passageUpdatedAt: 0
  };

  db.ref("p2p/state").on("value", function(snap) {
    const val = snap.val() || {};
    latestState = Object.assign(latestState, val);

    ocrPreview.textContent = (val.ocrText || "").slice(0, 2000);
    if (typeof val.ocrConfidence === "number") {
      ocrStatus.textContent = "OCR: conf=" + val.ocrConfidence.toFixed(1) + "%";
    } else {
      ocrStatus.textContent = "OCR: -";
    }

    if (val.cameraBlocked) {
      cameraStatus.textContent = "카메라 상태: 가려짐 (센서폰 확인)";
    } else {
      cameraStatus.textContent = "카메라 상태: 정상";
    }

    if (typeof val.passageUpdatedAt === "number") {
      passageStatus.textContent = "지문: 마지막 업데이트 " + new Date(val.passageUpdatedAt).toLocaleTimeString();
    }
  });

  db.ref("p2p/passageText").on("value", function(snap) {
    const txt = snap.val() || "";
    passagePreview.textContent = txt.slice(0, 4000);
  });

  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null;
  let listening = false;
  let audioBuffer = "";
  let interimDisplay = "";

  function updateAudioInFirebase() {
    db.ref("p2p/state").update({
      audioText: audioBuffer,
      audioUpdatedAt: Date.now()
    });
    audioPreview.textContent = audioBuffer.slice(0, 2000);
  }

  function initRecognition() {
    if (!SpeechRecognition) {
      sttStatus.textContent = "⚠️ 이 브라우저는 음성 인식을 지원하지 않습니다.";
      btnStt.disabled = true;
      return null;
    }
    const rec = new SpeechRecognition();
    rec.lang = "en-US";
    rec.continuous = true;
    rec.interimResults = true;
    rec.maxAlternatives = 1;
    return rec;
  }

  function startStt() {
    if (!SpeechRecognition) {
      sttStatus.textContent = "⚠️ 브라우저에서 STT 미지원.";
      return;
    }
    if (listening && recognition) return;

    recognition = initRecognition();
    if (!recognition) return;

    listening = true;
    btnStt.classList.add("listening");
    btnStt.textContent = "음성 인식 중지 (Listening/Speaking)";
    sttLine.textContent = "STT: 인식 중...";
    sttStatus.textContent = "스피커/마이크 근처에 두고 영어로 말하면 인식됩니다.";

    recognition.onresult = function(event) {
      let finalAdded = false;
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const text = res[0].transcript.trim();
        if (!text) continue;
        if (res.isFinal) {
          audioBuffer += (audioBuffer ? " " : "") + text;
          finalAdded = true;
          interimDisplay = "";
        } else {
          interimDisplay = text;
        }
      }
      if (finalAdded) {
        updateAudioInFirebase();
      }
      const previewText = audioBuffer + (interimDisplay ? (" " + interimDisplay) : "");
      audioPreview.textContent = previewText.slice(0, 2000);
      sttLine.textContent = "STT: 인식 중...";
    };

    recognition.onerror = function(event) {
      console.warn("STT error:", event.error);
      sttLine.textContent = "STT 에러: " + event.error;
    };

    recognition.onend = function() {
      if (listening) {
        try {
          recognition.start();
        } catch (e) {
          console.warn("STT 재시작 실패:", e);
          sttLine.textContent = "STT 재시작 실패: " + e.toString();
        }
      } else {
        sttLine.textContent = "STT: 중지됨";
      }
    };

    try {
      recognition.start();
    } catch (e) {
      console.error("STT 시작 실패:", e);
      sttStatus.textContent = "STT 시작 실패: " + e.toString();
    }
  }

  function stopStt() {
    listening = false;
    btnStt.classList.remove("listening");
    btnStt.textContent = "음성 인식 시작 (Listening/Speaking)";
    sttLine.textContent = "STT: 중지됨";
    sttStatus.textContent = "음성 인식이 중지되었습니다.";
    try {
      if (recognition) {
        recognition.onend = null;
        recognition.stop();
      }
    } catch (e) {
      console.warn("STT stop error:", e);
    }
  }

  btnStt.addEventListener("click", function() {
    if (!listening) startStt();
    else stopStt();
  });

  if (!SpeechRecognition) {
    sttStatus.textContent = "⚠️ 이 브라우저는 Web Speech API를 지원하지 않습니다.";
    btnStt.disabled = true;
  } else {
    sttStatus.textContent = "음성 인식을 사용할 수 있습니다.";
  }

  // 리스닝 세트 리셋 (STT 텍스트 유지/삭제는 여기서만 수동으로)
  btnListeningReset.addEventListener("click", function() {
    audioBuffer = "";
    updateAudioInFirebase();
    sttLine.textContent = "STT: 리셋됨 (새 리스닝 세트 시작)";
    sttStatus.textContent = "리스닝 세트용 STT가 초기화되었습니다.";
  });

  function sendCameraCommand(kind) {
    const cmd = {
      kind: kind,
      timestamp: Date.now()
    };
    return db.ref("p2p/cameraCommand").set(cmd);
  }

  // 지문 초기화 + 추가
  btnPassageStart.addEventListener("click", async function() {
    await db.ref("p2p/passageText").set("");
    await db.ref("p2p/state").update({
      passageUpdatedAt: Date.now()
    });
    passagePreview.textContent = "";
    passageStatus.textContent = "지문: 초기화 완료";
  });

  btnPassageAdd.addEventListener("click", async function() {
    passageStatus.textContent = "지문: 현재 화면 OCR 요청 중...";
    await sendCameraCommand("passage");
  });

  let solving = false;

  async function callSolve() {
    if (solving) return;
    solving = true;
    btnSolveQuestion.disabled = true;
    btnSolveQuestion.textContent = "풀이 중...";

    try {
      const snap = await db.ref("p2p/passageText").once("value");
      const passageText = snap.val() || "";

      const payload = {
        section: currentSection,
        passageText: passageText,
        screenText: latestState.ocrText || "",
        audioText: latestState.audioText || ""
      };

      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      renderAnswer(text);
    } catch (e) {
      answerMain.textContent = "에러: AI 호출 실패";
      answerMeta.textContent = "섹션: " + currentSection + " · 에러";
      answerRaw.textContent = e.toString();
    } finally {
      solving = false;
      btnSolveQuestion.disabled = false;
      btnSolveQuestion.textContent = "이 질문 풀기";
    }
  }

  // "이 질문 풀기" → 카메라에 질문 화면 OCR 요청 → 완료되면 solve 호출
  btnSolveQuestion.addEventListener("click", async function() {
    const startTs = Date.now();
    ocrStatus.textContent = "OCR: 질문 화면 캡처 요청 중...";
    await sendCameraCommand("question");

    const timeoutMs = 8000;
    function waitLoop() {
      const now = Date.now();
      if (now - startTs > timeoutMs) {
        ocrStatus.textContent = "OCR: 타임아웃 – 화면/조명 다시 확인";
        return;
      }
      if (latestState.ocrUpdatedAt && latestState.ocrUpdatedAt >= startTs) {
        ocrStatus.textContent = "OCR: 완료, AI 풀이 시작";
        callSolve();
        return;
      }
      setTimeout(waitLoop, 250);
    }
    waitLoop();
  });

  // AI 답안 표시
  function renderAnswer(rawText) {
    const text = (rawText || "").trim();
    if (!text) {
      answerMain.textContent = "AI 응답이 비어 있습니다.";
      answerMeta.textContent = "섹션: " + currentSection + " · 확신도: -";
      answerRaw.textContent = "";
      return;
    }

    // [CONFIDENCE] 파싱
    let confText = currentConfidenceText;
    let confMatch = text.match(/^\[CONFIDENCE\]\s*([0-9.]+)/im);
    if (!confMatch) {
      confMatch = text.match(/confidence[:=]\s*([0-9.]+)/i);
    }
    if (confMatch) {
      let v = parseFloat(confMatch[1]);
      if (!isNaN(v)) {
        if (v <= 1) v = v * 100;
        confText = v.toFixed(1) + "%";
      }
    }
    currentConfidenceText = confText;

    // 메인 답변 추출
    let mainAnswer = null;
    const mAnswer = text.match(/^\[ANSWER\]\s*(.+)$/im);
    if (mAnswer) {
      mainAnswer = mAnswer[1].trim();
    } else {
      const modelIdx = text.indexOf("[MODEL]");
      const essayIdx = text.indexOf("[ESSAY]");
      let block = null;
      if (modelIdx >= 0) {
        block = text.slice(modelIdx + "[MODEL]".length);
      } else if (essayIdx >= 0) {
        block = text.slice(essayIdx + "[ESSAY]".length);
      }
      if (block) {
        const lines = block.split(/\r?\n/).map(function(l){return l.trim();});
        for (let i = 0; i < lines.length; i++) {
          if (lines[i].length > 0) {
            mainAnswer = lines[i];
            break;
          }
        }
      }
    }

    if (!mainAnswer) {
      const first = text.split(/\r?\n/).find(function(l){ return l.trim().length > 0; });
      mainAnswer = first || "(내용 없음)";
    }

    answerMain.textContent = mainAnswer;
    answerMeta.textContent = "섹션: " + currentSection + " · 확신도: " + confText;
    answerRaw.textContent = text;
  }
</script>
</body>
</html>

