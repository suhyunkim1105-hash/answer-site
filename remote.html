<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site ì›ê²© ì»¨íŠ¸ë¡¤ëŸ¬</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #050505;
      color: #eee;
      margin: 0;
      padding: 16px;
    }
    h1 { font-size: 1.4rem; margin-bottom: 0.5rem; }
    p  { font-size: 0.9rem; color: #bbb; margin: 4px 0; }
    button {
      margin-top: 8px;
      padding: 10px 18px;
      font-size: 15px;
      border-radius: 999px;
      border: none;
      background: #2b2b2b;
      color: #fff;
      cursor: pointer;
    }
    button:active { opacity: 0.85; }
    #status {
      margin-top: 10px;
      font-size: 0.85rem;
      color: #ccc;
      white-space: pre-line;
    }
    #answer {
      margin-top: 12px;
      font-size: 2.2rem;
      font-weight: 700;
    }
    #meta {
      margin-top: 8px;
      font-size: 0.82rem;
      color: #aaa;
      white-space: pre-line;
    }
    #text {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #141414;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }
    #image {
      margin-top: 12px;
      max-width: 100%;
      border-radius: 10px;
      background: #000;
    }
  </style>
</head>
<body>
  <h1>ğŸ’» answer-site ì›ê²© ì»¨íŠ¸ë¡¤ëŸ¬</h1>
  <p>
    1) íœ´ëŒ€í°ì—ì„œ <b>index.html</b> í˜ì´ì§€ë¥¼ ì—´ê³  ì¹´ë©”ë¼ë¥¼ ì¼œ ë‘”ë‹¤.<br />
    2) ì—¬ê¸°ì„œ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ â†’ íœ´ëŒ€í°ì´ í™”ë©´ì„ ìº¡ì²˜ + OCR + AI í’€ì´.<br />
    3) ì´ í˜ì´ì§€ì— <b>ì´ë¯¸ì§€ / ë¬¸ì œ í…ìŠ¤íŠ¸ / ì •ë‹µ ë²ˆí˜¸</b>ê°€ ìë™ìœ¼ë¡œ ëœ¬ë‹¤.
  </p>

  <button id="captureBtn">ğŸ“¸ íœ´ëŒ€í°ì— ì›ê²© ìº¡ì²˜ + í’€ì´ ìš”ì²­</button>
  <div id="status">ì•„ì§ ìš”ì²­ ì—†ìŒ</div>

  <div id="answer">ì •ë‹µ ëŒ€ê¸° ì¤‘</div>
  <div id="meta"></div>
  <div id="text"></div>
  <img id="image" alt="ìº¡ì²˜ëœ í™”ë©´ ë¯¸ë¦¬ë³´ê¸°" />

  <script type="module">
    import { initializeApp }   from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

    // ğŸ”¹ index.htmlê³¼ ê°™ì€ ì„¤ì • ì‚¬ìš©
    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const ROOM_ID = "room1";

    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);
    const commandRef = ref(db, `rooms/${ROOM_ID}/command`);
    const resultRef  = ref(db, `rooms/${ROOM_ID}/result`);

    const captureBtn = document.getElementById('captureBtn');
    const statusEl   = document.getElementById('status');
    const answerEl   = document.getElementById('answer');
    const metaEl     = document.getElementById('meta');
    const textEl     = document.getElementById('text');
    const imageEl    = document.getElementById('image');

    let lastRequestId = null;
    let lastResultTime = 0;

    // 1) ì›ê²© ìº¡ì²˜ ìš”ì²­ ë³´ë‚´ê¸°
    captureBtn.addEventListener('click', async () => {
      const reqId = Date.now().toString();
      lastRequestId = reqId;

      statusEl.textContent =
        `ìš”ì²­ ì „ì†¡ ì¤‘... (ID: ${reqId})`;

      try {
        await set(commandRef, {
          type: 'capture',
          requestId: reqId,
          requestedAt: Date.now()
        });
        statusEl.textContent =
          `ìš”ì²­ ë³´ëƒ„ (ID: ${reqId})\níœ´ëŒ€í°ì´ ìº¡ì²˜ + í’€ì´í•œ ë’¤ ì‘ë‹µì„ ë³´ë‚¼ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘.`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'ìš”ì²­ ì „ì†¡ ì˜¤ë¥˜: ' + err.message;
        alert('ìš”ì²­ ì „ì†¡ ì˜¤ë¥˜: ' + err.message);
      }
    });

    // 2) íœ´ëŒ€í°ì—ì„œ ë³´ë‚¸ ê²°ê³¼ ë°›ê¸°
    onValue(resultRef, (snapshot) => {
      const data = snapshot.val();
      if (!data) return;

      const updatedAt = data.updatedAt || 0;
      if (updatedAt <= lastResultTime) return; // ì˜ˆì „ ê²°ê³¼ ë¬´ì‹œ
      lastResultTime = updatedAt;

      const reqId = data.requestId || 'ì—†ìŒ';
      const section = data.section || 'unknown';
      const qType = data.qType || 'unknown';
      const snippet = data.passageSnippet || null;
      const text = data.text || '';
      const answer = data.answer || '';
      const image = data.image || null;

      statusEl.textContent =
        `ìƒˆ ê²°ê³¼ ìˆ˜ì‹  âœ… (ìš”ì²­ ID: ${reqId})\nì—…ë°ì´íŠ¸ ì‹œê°: ${new Date(updatedAt).toLocaleString()}`;

      answerEl.textContent = answer ? `ì •ë‹µ: ${answer}` : 'ì •ë‹µ ì •ë³´ ì—†ìŒ';

      let metaLines = [];
      metaLines.push(`ì„¹ì…˜: ${section}`);
      metaLines.push(`ë¬¸ì œ ìœ í˜•(qType): ${qType}`);
      if (snippet) {
        metaLines.push('');
        metaLines.push('ì§€ë¬¸ ì¼ë¶€:');
        metaLines.push(snippet);
      }
      metaEl.textContent = metaLines.join('\n');

      textEl.textContent = text || '(ë¬¸ì œ í…ìŠ¤íŠ¸ ì—†ìŒ)';

      if (image) {
        imageEl.src = image;
        imageEl.style.display = 'block';
      } else {
        imageEl.src = '';
        imageEl.style.display = 'none';
      }
    });
  </script>
</body>
</html>
