<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>answer-site | Remote</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

<style>
body { font-family: sans-serif; padding: 20px; }
textarea { width: 100%; height: 120px; margin-top: 10px; }
button { padding: 10px 15px; margin: 5px; }
#resultBox { white-space: pre-wrap; margin-top: 20px; background: #eee; padding: 15px; }
</style>
</head>
<body>

<h2>answer-site Remote</h2>

<h3>Mode</h3>
<select id="modeSel">
  <option value="reading">Reading</option>
  <option value="writing">Writing</option>
  <option value="listening">Listening</option>
  <option value="speaking">Speaking</option>
</select>

<hr>

<h3>Reading</h3>
<button onclick="sendCapture('passage')">ğŸ“¸ ì§€ë¬¸ ìº¡ì²˜</button>
<button onclick="sendCapture('question')">ğŸ“¸ ë¬¸ì œ ìº¡ì²˜ + í’€ì´</button>

<textarea id="passageBox" placeholder="ì§€ë¬¸ OCR ê²°ê³¼"></textarea>
<textarea id="questionBox" placeholder="ë¬¸ì œ OCR ê²°ê³¼"></textarea>

<hr>

<h3>Writing / Listening / Speaking â€“ STT</h3>
<button onclick="startSTT()">ğŸ¤ STT ì‹œì‘</button>
<button onclick="stopSTT()">â¹ STT ì¢…ë£Œ</button>
<textarea id="sttBox" placeholder="ì—¬ê¸°ì— ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹ ê²°ê³¼(STT)ê°€ í‘œì‹œë¨"></textarea>

<hr>

<button onclick="requestSolve()">ğŸ¤– AI í’€ì´/ìƒì„± ìš”ì²­</button>

<div id="resultBox"></div>

<script>
// ---------------- Firebase Init ----------------
const firebaseConfig = {
  apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
  authDomain: "answer-site-p2p.firebaseapp.com",
  databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "answer-site-p2p",
  storageBucket: "answer-site-p2p.firebasestorage.app",
  messagingSenderId: "364227113735",
  appId: "1:364227113735:web:b18355cf0b16454663cba2",
  measurementId: "G-C8MRHK5ZGS"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ---------------- OCR Command ----------------
function sendCapture(target) {
  db.ref("p2p/latestCommand").set({
    action: "capture",
    target,
    timestamp: Date.now(),
  });
}

// ---------------- Receive OCR Result ----------------
db.ref("p2p/latestResult").on("value", snap => {
  const val = snap.val();
  if (!val) return;

  if (val.target === "passage") {
    document.getElementById("passageBox").value = val.text;
  }
  if (val.target === "question") {
    document.getElementById("questionBox").value = val.text;
  }
});

// ---------------- STT ----------------
let recognition;
let recognizing = false;
let finalText = "";

function startSTT() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("ë¸Œë¼ìš°ì €ê°€ STT(WebSpeech API)ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }

  recognition = new webkitSpeechRecognition();
  recognition.lang = "en-US";
  recognition.continuous = true;
  recognition.interimResults = true;

  recognition.onresult = e => {
    let temp = "";
    for (let i = e.resultIndex; i < e.results.length; i++) {
      temp += e.results[i][0].transcript;
      if (e.results[i].isFinal) finalText += e.results[i][0].transcript + "\n";
    }
    document.getElementById("sttBox").value = finalText + "\n" + temp;
  };

  recognition.start();
  recognizing = true;
}

function stopSTT() {
  if (recognition && recognizing) {
    recognition.stop();
    recognizing = false;
  }
}

// ---------------- Solve Request ----------------
async function requestSolve() {
  const mode = document.getElementById("modeSel").value;

  const body = {
    mode,
    passage: document.getElementById("passageBox").value,
    question: document.getElementById("questionBox").value,
    stt: document.getElementById("sttBox").value
  };

  const res = await fetch("/.netlify/functions/solve", {
    method: "POST",
    headers: { "Content-Type": "application/json"},
    body: JSON.stringify(body)
  });

  const out = await res.json();
  document.getElementById("resultBox").innerText = out.result;

  // Optional TTS
  if (out.tts) {
    const u = new SpeechSynthesisUtterance(out.tts);
    speechSynthesis.speak(u);
  }
}
</script>

</body>
</html>

