<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site 원격 컨트롤러</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050505;
      color: #fff;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 4px;
    }
    small {
      color: #999;
    }
    .card {
      max-width: 900px;
      margin: 8px auto;
      padding: 12px 16px;
      border-radius: 16px;
      background: #111;
    }
    #answerBox {
      font-size: 20px;
      font-weight: 700;
    }
    #answerValue {
      color: #4dd0ff;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #333;
      color: #fff;
      margin: 4px;
    }
    button:active {
      transform: scale(0.97);
    }
    .mode-btn.active {
      background: #4dd0ff;
      color: #000;
    }
    #status {
      font-size: 13px;
      color: #ccc;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 13px;
      line-height: 1.4;
      max-height: 220px;
      overflow-y: auto;
      margin: 6px 0 0;
    }
    .label {
      font-size: 13px;
      color: #aaa;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>answer-site 원격 컨트롤러</h1>
    <small>※ 실제 시험에서 사용하면 안 됨. 연습·연구용 전용.</small>
  </div>

  <div class="card" id="answerBox">
    정답: <span id="answerValue">-</span>
  </div>

  <div class="card">
    <div class="label">영역 선택</div>
    <div>
      <button class="mode-btn active" data-mode="reading">Reading</button>
      <button class="mode-btn" data-mode="writing">Writing</button>
      <button class="mode-btn" data-mode="listening">Listening</button>
      <button class="mode-btn" data-mode="speaking">Speaking</button>
    </div>

    <div class="label" style="margin-top:8px;">원격 조작</div>
    <div>
      <button id="btnPassage">현재 화면을 지문으로 OCR (저장만)</button>
      <button id="btnQuestion">현재 화면 캡처 + 풀이 요청</button>
    </div>

    <div id="status" style="margin-top:8px;">대기 중...</div>
  </div>

  <div class="card">
    <div class="label">저장된 지문 (Reading/Writing에서 사용)</div>
    <pre id="passageText"></pre>
  </div>

  <div class="card">
    <div class="label">마지막 OCR 텍스트 (문항/프롬프트)</div>
    <pre id="questionText"></pre>
  </div>

  <div class="card">
    <div class="label">AI 상세 답변 / 에세이 / 피드백</div>
    <pre id="detailText"></pre>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-database.js";

    // ===== Firebase 설정 (같은 프로젝트) =====
    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const modeButtons = document.querySelectorAll(".mode-btn");
    const btnPassage = document.getElementById("btnPassage");
    const btnQuestion = document.getElementById("btnQuestion");
    const statusEl = document.getElementById("status");
    const passageEl = document.getElementById("passageText");
    const questionEl = document.getElementById("questionText");
    const detailEl = document.getElementById("detailText");
    const answerEl = document.getElementById("answerValue");

    let currentMode = "reading";
    let passageText = "";
    let lastResultRequestId = null;

    // ===== 모드 선택 =====
    modeButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        modeButtons.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        currentMode = btn.dataset.mode || "reading";
        statusEl.textContent = `모드 변경: ${currentMode.toUpperCase()}`;
      });
    });

    // ===== 휴대폰에 캡처 명령 보내기 =====
    async function sendCapture(target) {
      const requestId = Date.now();

      statusEl.textContent =
        target === "passage"
          ? "휴대폰에 지문 캡처 요청 전송..."
          : "휴대폰에 문항 캡처 요청 전송...";

      await set(ref(db, "p2p/latestCommand"), {
        requestId,
        target,
        mode: currentMode,
        createdAt: Date.now()
      });
    }

    btnPassage.addEventListener("click", () => sendCapture("passage"));
    btnQuestion.addEventListener("click", () => sendCapture("question"));

    // ===== 휴대폰에서 올라오는 OCR 결과 수신 =====
    const resultRef = ref(db, "p2p/latestResult");
    onValue(resultRef, async snap => {
      const result = snap.val();
      if (!result) return;
      if (!result.requestId) return;
      if (result.requestId === lastResultRequestId) return;
      lastResultRequestId = result.requestId;

      const target = result.target || "question";
      const text = result.ocrText || "";

      if (target === "passage") {
        passageText = text;
        passageEl.textContent = text || "(지문 없음)";
        statusEl.textContent = "지문 OCR 수신 완료.";
        return;
      }

      // target === question
      questionEl.textContent = text || "(문항 텍스트 없음)";
      statusEl.textContent = "문항 OCR 수신 → AI 풀이 중...";

      try {
        const data = await solveWithAI(currentMode, passageText, text);
        renderAIResult(currentMode, data);
        statusEl.textContent = "AI 풀이 완료.";
      } catch (err) {
        console.error(err);
        statusEl.textContent = "AI 호출 오류: " + err.message;
      }
    });

    // ===== Netlify Functions 호출 =====
    async function solveWithAI(mode, passage, question) {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          mode,
          passage: passage || "",
          question: question || ""
        })
      });

      if (!res.ok) {
        const msg = await res.text();
        throw new Error("solve 함수 오류: " + msg);
      }
      return await res.json();
    }

    // ===== 영역별 UI 반영 =====
    function renderAIResult(mode, data) {
      const answer = data.answer || null;
      const raw = data.raw || "";

      if (answer) {
        answerEl.textContent = answer;
      } else {
        answerEl.textContent =
          mode === "writing" || mode === "speaking"
            ? "서술형"
            : "-";
      }

      if (mode === "writing") {
        detailEl.textContent = raw || "(에세이 없음)";
      } else if (mode === "speaking") {
        detailEl.textContent = raw || "(답변/피드백 없음)";
      } else if (mode === "listening") {
        detailEl.textContent = raw || "(리스닝 설명 없음)";
      } else {
        // reading 혹은 기타
        detailEl.textContent = raw || "(설명 없음)";
      }
    }
  </script>
</body>
</html>
