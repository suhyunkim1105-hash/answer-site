<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>answer-site | Remote</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #050608;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    .wrap {
      max-width: 900px;
      margin: 0 auto;
    }

    .mode-row {
      display: flex;
      gap: 8px;
      margin-bottom: 6px;
    }
    .mode-btn {
      flex: 1 1 0;
      padding: 8px 0;
      border-radius: 999px;
      border: 1px solid #333;
      background: #101218;
      color: #ddd;
      font-size: 13px;
      text-align: center;
      cursor: pointer;
    }
    .mode-btn.active {
      background: #0b84ff;
      border-color: #0b84ff;
      color: #fff;
      font-weight: 600;
    }

    #sectionStatus {
      font-size: 11px;
      color: #a5c7ff;
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .answer-card {
      background: #101218;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 8px;
      border: 1px solid #262b3a;
    }
    #answerMain {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 4px;
      word-break: break-word;
    }
    #answerMeta {
      font-size: 11px;
      color: #9fb3ff;
      margin-bottom: 6px;
    }
    #answerBody {
      font-size: 12px;
      white-space: pre-wrap;
      line-height: 1.4;
    }

    .controls-row {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .btn {
      width: 100%;
      border-radius: 999px;
      padding: 10px 0;
      border: none;
      font-size: 14px;
      cursor: pointer;
    }
    #btnSolve {
      background: #0b84ff;
      color: #fff;
      font-weight: 600;
    }
    #btnSolve:active {
      transform: scale(0.98);
    }
    #btnReset {
      background: #202534;
      color: #e4e4e4;
    }
    #btnSttToggle {
      background: #181b24;
      color: #e4e4e4;
      font-size: 13px;
    }

    #globalStatus {
      margin-top: 6px;
      font-size: 11px;
      color: #bbbbbb;
      min-height: 14px;
    }

    .debug-toggle {
      margin-top: 8px;
    }
    #btnToggleDebug {
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #333;
      background: #0b0f1a;
      color: #d6e4ff;
      cursor: pointer;
    }

    #debugPanel {
      margin-top: 6px;
      padding: 8px;
      border-radius: 10px;
      background: #05070f;
      border: 1px solid #222637;
      font-size: 11px;
      display: none;
    }
    #debugPanel h3 {
      margin: 6px 0 2px;
      font-size: 11px;
      color: #93b4ff;
    }
    #debugPanel pre {
      margin: 0 0 4px;
      max-height: 120px;
      overflow: auto;
      background: #070912;
      padding: 4px;
      border-radius: 6px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="mode-row">
    <button class="mode-btn active" id="btnModeReading">Reading</button>
    <button class="mode-btn" id="btnModeListening">Listening</button>
    <button class="mode-btn" id="btnModeWriting">Writing</button>
    <button class="mode-btn" id="btnModeSpeaking">Speaking</button>
  </div>

  <div id="sectionStatus">섹션: reading · OCR: conf=- · 카메라 상태: -</div>

  <div class="answer-card">
    <div id="answerMain">아직 풀이 전입니다.</div>
    <div id="answerMeta"></div>
    <div id="answerBody"></div>
  </div>

  <div class="controls-row">
    <button id="btnSolve" class="btn">이 질문 풀기</button>
    <button id="btnReset" class="btn">이 세션 초기화</button>
    <button id="btnSttToggle" class="btn">음성 인식 시작 (Listening/Speaking)</button>
  </div>

  <div id="globalStatus"></div>

  <div class="debug-toggle">
    <button id="btnToggleDebug">디버그 보기 토글 (OCR/음성/지문)</button>
  </div>

  <div id="debugPanel">
    <h3>OCR 텍스트 (현재 화면)</h3>
    <pre id="debugOcrCurrent">(없음)</pre>

    <h3>지문 텍스트 (누적)</h3>
    <pre id="debugOcrAccum">(없음)</pre>

    <h3>음성 텍스트 (STT)</h3>
    <pre id="debugSttText">(없음)</pre>

    <h3>AI 원문 응답</h3>
    <pre id="debugAiRaw"></pre>
  </div>
</div>

<script>
  // ===== Firebase 초기화 =====
  const firebaseConfig = {
    apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
    authDomain: "answer-site-p2p.firebaseapp.com",
    databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "answer-site-p2p",
    storageBucket: "answer-site-p2p.firebasestorage.app",
    messagingSenderId: "364227113735",
    appId: "1:364227113735:web:b18355cf0b16454663cba2",
    measurementId: "G-C8MRHK5ZGS"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const stateRef = db.ref("p2p/state");
  const cmdRef   = db.ref("p2p/command");

  // ===== DOM =====
  const btnModeReading   = document.getElementById("btnModeReading");
  const btnModeListening = document.getElementById("btnModeListening");
  const btnModeWriting   = document.getElementById("btnModeWriting");
  const btnModeSpeaking  = document.getElementById("btnModeSpeaking");

  const sectionStatus = document.getElementById("sectionStatus");
  const answerMainEl  = document.getElementById("answerMain");
  const answerMetaEl  = document.getElementById("answerMeta");
  const answerBodyEl  = document.getElementById("answerBody");

  const btnSolve     = document.getElementById("btnSolve");
  const btnReset     = document.getElementById("btnReset");
  const btnSttToggle = document.getElementById("btnSttToggle");

  const globalStatus = document.getElementById("globalStatus");

  const btnToggleDebug = document.getElementById("btnToggleDebug");
  const debugPanel     = document.getElementById("debugPanel");
  const debugOcrCurrent = document.getElementById("debugOcrCurrent");
  const debugOcrAccum   = document.getElementById("debugOcrAccum");
  const debugSttText    = document.getElementById("debugSttText");
  const debugAiRaw      = document.getElementById("debugAiRaw");

  // ===== 상태 변수 =====
  let currentMode = "reading";

  let lastOcrText = "";
  let lastOcrConfidence = null;
  let cameraBlocked = null;

  let accumulatedText = "";
  let sttFinalText = "";

  // ===== 모드 전환 =====
  function setMode(mode) {
    currentMode = mode;
    btnModeReading.classList.toggle("active", mode === "reading");
    btnModeListening.classList.toggle("active", mode === "listening");
    btnModeWriting.classList.toggle("active", mode === "writing");
    btnModeSpeaking.classList.toggle("active", mode === "speaking");

    stateRef.update({
      modeHint: currentMode,
      modeUpdatedAt: Date.now()
    });

    updateSectionStatus();
  }

  btnModeReading.onclick   = () => setMode("reading");
  btnModeListening.onclick = () => setMode("listening");
  btnModeWriting.onclick   = () => setMode("writing");
  btnModeSpeaking.onclick  = () => setMode("speaking");

  // ===== 섹션 상태 문구 =====
  function updateSectionStatus() {
    const confStr =
      typeof lastOcrConfidence === "number"
        ? lastOcrConfidence.toFixed(1) + "%"
        : "-";
    let camStr = "-";
    if (cameraBlocked === true) camStr = "가려짐";
    else if (cameraBlocked === false) camStr = "정상";

    sectionStatus.textContent =
      `섹션: ${currentMode} · OCR: conf=${confStr} · 카메라 상태: ${camStr}`;
  }

  // ===== Firebase state 구독 (OCR / 카메라 / 외부 STT) =====
  stateRef.on("value", snap => {
    const s = snap.val() || {};
    const ocrText = s.ocrText || "";
    const conf = typeof s.ocrConfidence === "number" ? s.ocrConfidence : null;
    const blocked = typeof s.cameraBlocked === "boolean" ? s.cameraBlocked : null;
    const audioText = s.audioText || "";

    if (ocrText && ocrText !== lastOcrText) {
      lastOcrText = ocrText;
      debugOcrCurrent.textContent = ocrText;

      // 누적 지문 (통합형 라이팅/리딩/리스닝용)
      const snippet = ocrText.slice(0, 200);
      if (!accumulatedText.includes(snippet)) {
        accumulatedText = (accumulatedText + "\n" + ocrText).trim();
        debugOcrAccum.textContent = accumulatedText || "(없음)";
      }
    }

    if (conf !== null) {
      lastOcrConfidence = conf;
    }

    if (blocked !== null) {
      cameraBlocked = blocked;
    }

    if (audioText && audioText !== sttFinalText) {
      // 다른 기기에서 STT 쓴 경우도 반영
      sttFinalText = audioText;
      debugSttText.textContent = sttFinalText;
    }

    updateSectionStatus();
  });

  // ===== STT (Web Speech API) =====
  let recognition = null;
  let sttRunning = false;

  function initStt() {
    const SR =
      window.SpeechRecognition || window.webkitSpeechRecognition || null;
    if (!SR) {
      btnSttToggle.disabled = true;
      btnSttToggle.textContent = "브라우저에서 STT 지원 안 됨";
      globalStatus.textContent = "이 브라우저에서는 Web Speech API(STT)를 사용할 수 없습니다.";
      return;
    }
    recognition = new SR();
    recognition.lang = "en-US";
    recognition.continuous = true;
    recognition.interimResults = true;
    recognition.maxAlternatives = 1;

    recognition.onstart = () => {
      sttRunning = true;
      globalStatus.textContent = "음성 인식 중...";
      btnSttToggle.textContent = "음성 인식 중지";
    };

    recognition.onerror = (e) => {
      sttRunning = false;
      btnSttToggle.textContent = "음성 인식 시작 (Listening/Speaking)";
      globalStatus.textContent = "STT 오류: " + e.error;
    };

    recognition.onend = () => {
      sttRunning = false;
      btnSttToggle.textContent = "음성 인식 시작 (Listening/Speaking)";
      globalStatus.textContent = "음성 인식이 중지되었습니다.";
    };

    recognition.onresult = (event) => {
      for (let i = event.resultIndex; i < event.results.length; i++) {
        const res = event.results[i];
        const transcript = (res[0].transcript || "").trim();
        if (!transcript) continue;

        if (res.isFinal) {
          sttFinalText += (sttFinalText ? " " : "") + transcript;
          debugSttText.textContent = sttFinalText || "(없음)";

          stateRef.update({
            audioText: sttFinalText,
            audioUpdatedAt: Date.now()
          });
        }
      }
    };
  }

  initStt();

  btnSttToggle.onclick = () => {
    if (!recognition) return;

    if (!sttRunning) {
      sttFinalText = ""; // 새 세트 녹음
      debugSttText.textContent = "(녹음 중...)";
      recognition.start();
    } else {
      recognition.stop();
    }
  };

  // ===== 세션 초기화 =====
  function resetSession() {
    accumulatedText = "";
    sttFinalText = "";
    lastOcrText = "";
    lastOcrConfidence = null;

    debugOcrCurrent.textContent = "(없음)";
    debugOcrAccum.textContent = "(없음)";
    debugSttText.textContent = "(없음)";
    debugAiRaw.textContent = "";

    answerMainEl.textContent = "아직 풀이 전입니다.";
    answerMetaEl.textContent = "";
    answerBodyEl.textContent = "";

    stateRef.update({
      ocrText: "",
      ocrConfidence: null,
      audioText: "",
      audioUpdatedAt: null
    });

    globalStatus.textContent = `현재 세션(${currentMode}) 초기화 완료.`;
    updateSectionStatus();
  }

  btnReset.onclick = resetSession;

  // ===== AI 호출 & 결과 렌더링 =====
  function renderResult(mode, raw) {
    const txt = raw || "";
    debugAiRaw.textContent = txt;

    let prob = null;
    const pMatch = txt.match(/\[P\]\s*([0-9.]+)/i);
    if (pMatch) {
      const val = parseFloat(pMatch[1]);
      if (!isNaN(val)) prob = val;
    }

    function setProb() {
      if (prob == null || isNaN(prob)) {
        answerMetaEl.textContent = "";
      } else {
        const pct = Math.round(prob * 100);
        answerMetaEl.textContent = `맞을 확률(추정): ${pct}%`;
      }
    }

    // ---- Reading / Listening ----
    if (mode === "reading" || mode === "listening") {
      const aMatch = txt.match(/\[ANSWER\]\s*([^\n]+)/i);
      const answerLine = aMatch ? aMatch[1].trim() : "?";

      const idx = txt.search(/\[WHY\]/i);
      const body = idx >= 0 ? txt.slice(idx + 5).trim() : txt;

      answerMainEl.textContent = answerLine || "?";
      setProb();
      answerBodyEl.textContent = body;
      return;
    }

    // ---- Writing ----
    if (mode === "writing") {
      let essay = "";
      let feedback = "";

      const essaySplit = txt.split(/\[ESSAY\]/i);
      if (essaySplit.length > 1) {
        const afterEssay = essaySplit[1];
        const parts = afterEssay.split(/\[FEEDBACK\]/i);
        essay = (parts[0] || "").trim();
        feedback = (parts[1] || "").trim();
      } else {
        essay = txt.trim();
      }

      answerMainEl.textContent = "모범 에세이";
      setProb();
      answerBodyEl.textContent =
        (essay ? "【ESSAY】\n" + essay + "\n\n" : "") +
        (feedback ? "【FEEDBACK】\n" + feedback : "");
      return;
    }

    // ---- Speaking : 스크립트만 ----
    if (mode === "speaking") {
      let model = "";
      const splitModel = txt.split(/\[MODEL\]/i);
      if (splitModel.length > 1) {
        const afterModel = splitModel[1];
        const parts2 = afterModel.split(/\[P\]/i);
        model = (parts2[0] || "").trim();
      } else {
        model = txt.trim();
      }

      answerMainEl.textContent =
        model || "(모델 스크립트를 받지 못했습니다.)";
      setProb();
      answerBodyEl.textContent = ""; // 본문은 비워둠
      return;
    }

    // ---- fallback ----
    answerMainEl.textContent = txt.slice(0, 80);
    setProb();
    answerBodyEl.textContent = txt;
  }

  async function doSolve() {
    const effectiveOcr = accumulatedText || lastOcrText || "";
    const payload = {
      mode: currentMode,
      ocrText: effectiveOcr,
      audioText: sttFinalText || ""
    };

    globalStatus.textContent = "AI 풀이 요청 중...";

    try {
      const res = await fetch("/.netlify/functions/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const text = await res.text();
      if (!res.ok) {
        answerMainEl.textContent = "[AI 오류]";
        answerMetaEl.textContent = "";
        answerBodyEl.textContent =
          "서버에서 정상적인 답을 받지 못했습니다.\n\n" + text;
        debugAiRaw.textContent = text;
        globalStatus.textContent = "AI 요청 오류 (HTTP " + res.status + ").";
        return;
      }

      renderResult(currentMode, text);
      globalStatus.textContent = "AI 풀이 완료.";
    } catch (e) {
      answerMainEl.textContent = "[AI 오류]";
      answerMetaEl.textContent = "";
      answerBodyEl.textContent =
        "네트워크 오류 또는 함수 호출 실패.\n" + e.toString();
      globalStatus.textContent = "AI 요청 중 네트워크 오류.";
    }
  }

  btnSolve.onclick = doSolve;

  // ===== 디버그 토글 =====
  btnToggleDebug.onclick = () => {
    debugPanel.style.display =
      debugPanel.style.display === "none" ? "block" : "none";
  };

  // 초기 상태 문구
  updateSectionStatus();
</script>
</body>
</html>

