<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>answer-site | Remote Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database-compat.js"></script>

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 8px;
      background: #050508;
      color: #f5f5f5;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }
    h1 {
      margin: 0 0 8px;
      font-size: 16px;
    }
    .status-bar {
      font-size: 12px;
      margin-bottom: 8px;
      color: #a0e7ff;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .layout {
      display: flex;
      gap: 8px;
      height: calc(100vh - 60px);
    }
    .col {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }
    .col-title {
      font-size: 12px;
      margin-bottom: 4px;
      color: #bbbbbb;
    }
    textarea, pre {
      flex: 1;
      width: 100%;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #0b0b10;
      color: #f5f5f5;
      font-size: 12px;
      resize: none;
      line-height: 1.4;
      white-space: pre-wrap;
      overflow-y: auto;
    }
    pre {
      margin: 0;
    }
    .controls {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    button {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 6px;
      border: 1px solid #555;
      background: #14141c;
      color: #f5f5f5;
      cursor: pointer;
    }
    button:active {
      transform: scale(0.97);
    }
    .tag {
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #444;
      background: #11131b;
      color: #aaaaaa;
    }
    .tag-ok { color: #72f1b8; border-color: #2f9f6b; }
    .tag-warn { color: #ffd16a; border-color: #b68522; }
    .tag-error { color: #ff7a7a; border-color: #b52c2c; }
  </style>
</head>
<body>
  <h1>answer-site Remote</h1>
  <div id="status" class="status-bar">Firebase 연결 준비 중...</div>

  <div class="controls">
    <span id="modeTag" class="tag">모드: -</span>
    <span id="cameraTag" class="tag">카메라: -</span>
    <span id="ocrTag" class="tag">OCR: -</span>
    <span id="solveTag" class="tag">풀이: -</span>

    <button id="btnManualSolve">수동 풀이 요청</button>
    <button id="btnReadAnswer">정답 읽어주기 (TTS)</button>
    <button id="btnStopTTS">TTS 정지</button>
  </div>

  <div class="layout">
    <div class="col">
      <div class="col-title">현재 OCR 텍스트 (카메라 폰 → Firebase)</div>
      <textarea id="ocrView" readonly></textarea>
    </div>
    <div class="col">
      <div class="col-title">논술 답안 (solve 함수 결과)</div>
      <pre id="answerView"></pre>
    </div>
  </div>

  <script>
    // --------- Firebase 초기화 ---------
    const firebaseConfig = {
      apiKey: "AIzaSyAvjpHfmbuHQq3ZeV6mNKQFI9LsnX-vf68",
      authDomain: "answer-site-p2p.firebaseapp.com",
      databaseURL: "https://answer-site-p2p-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "answer-site-p2p",
      storageBucket: "answer-site-p2p.firebasestorage.app",
      messagingSenderId: "364227113735",
      appId: "1:364227113735:web:b18355cf0b16454663cba2",
      measurementId: "G-C8MRHK5ZGS"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --------- DOM ---------
    const statusEl     = document.getElementById("status");
    const ocrView      = document.getElementById("ocrView");
    const answerView   = document.getElementById("answerView");
    const modeTag      = document.getElementById("modeTag");
    const cameraTag    = document.getElementById("cameraTag");
    const ocrTag       = document.getElementById("ocrTag");
    const solveTag     = document.getElementById("solveTag");
    const btnManual    = document.getElementById("btnManualSolve");
    const btnRead      = document.getElementById("btnReadAnswer");
    const btnStopTTS   = document.getElementById("btnStopTTS");

    function setStatus(msg) {
      statusEl.textContent = msg;
      console.log("[REMOTE]", msg);
    }
    function setTag(el, text, cls) {
      el.textContent = text;
      el.className = "tag " + (cls || "");
    }

    // --------- 상태 변수 ---------
    let lastOcrText = "";
    let lastOcrUpdatedAt = 0;
    let currentMode = "reading";
    let lastSolveCommandTs = 0;
    let lastSolvedSnippet = "";
    let solving = false;

    // --------- OCR / 상태 구독 ---------
    db.ref("p2p/state").on("value", snap => {
      const v = snap.val() || {};
      currentMode = v.modeHint || "reading";
      lastOcrText = v.ocrText || "";
      lastOcrUpdatedAt = v.ocrUpdatedAt || 0;
      const cameraBlocked = !!v.cameraBlocked;

      ocrView.value = lastOcrText;

      setTag(modeTag, `모드: ${currentMode}`, "tag-ok");
      setTag(cameraTag, cameraBlocked ? "카메라: 가려짐" : "카메라: 정상", cameraBlocked ? "tag-warn" : "tag-ok");

      const len = (lastOcrText || "").replace(/\s/g, "").length;
      if (len === 0) {
        setTag(ocrTag, "OCR: 텍스트 없음", "");
      } else {
        setTag(ocrTag, `OCR: 길이≈${len}`, "tag-ok");
      }
    }, err => {
      setStatus("Firebase 상태 구독 에러: " + err.toString());
      setTag(ocrTag, "OCR: 오류", "tag-error");
    });

    // --------- 커맨드 구독 (카메라에서 solve 신호) ---------
    db.ref("p2p/command").on("value", snap => {
      const cmd = snap.val();
      if (!cmd || cmd.type !== "solve") return;

      const ts = cmd.timestamp || 0;
      if (ts === 0 || ts === lastSolveCommandTs) return;
      lastSolveCommandTs = ts;

      setStatus(`solve command 수신 (timestamp=${ts})`);

      // 자동 solve: 너무 짧은 텍스트면 무시
      const cleanLen = (lastOcrText || "").replace(/\s/g, "").length;
      if (cleanLen < 50) {
        setStatus("자동 solve 무시: OCR 텍스트가 너무 짧음");
        setTag(solveTag, "풀이: 텍스트 부족 (자동 무시)", "tag-warn");
        return;
      }

      // 같은 스니펫이면 중복 solve 방지
      const snippet = (lastOcrText || "").slice(0, 200);
      if (snippet === lastSolvedSnippet) {
        setStatus("자동 solve 무시: 이전과 동일한 OCR 스니펫");
        setTag(solveTag, "풀이: 중복 요청 무시", "tag-warn");
        return;
      }

      lastSolvedSnippet = snippet;
      doSolve();
    }, err => {
      setStatus("Firebase command 구독 에러: " + err.toString());
      setTag(solveTag, "풀이: 오류", "tag-error");
    });

    // --------- Netlify Functions 호출 ---------
    const SOLVE_URL = "/.netlify/functions/solve";

    async function doSolve(manual) {
      if (solving) {
        setStatus("이미 solve 진행 중, 이번 요청은 무시");
        return;
      }
      const text = (lastOcrText || "").trim();
      const cleanLen = text.replace(/\s/g, "").length;
      if (cleanLen < 50) {
        setStatus("solve 중단: 텍스트가 너무 짧음");
        setTag(solveTag, "풀이: 텍스트 부족", "tag-warn");
        return;
      }

      try {
        solving = true;
        const modeLabel = manual ? "[수동]" : "[자동]";
        setStatus(`${modeLabel} solve 호출 중... (길이≈${cleanLen})`);
        setTag(solveTag, "풀이: 요청 중...", "");

        const res = await fetch(SOLVE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ocrText: text })
        });

        const raw = await res.text();
        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          setStatus(`${modeLabel} solve 실패: JSON 파싱 에러`);
          setTag(solveTag, "풀이: JSON 에러", "tag-error");
          answerView.textContent =
            "solve 응답이 JSON이 아님:\n\n" + raw.slice(0, 1000);
          return;
        }

        if (!res.ok) {
          setStatus(`${modeLabel} solve 실패: HTTP ${res.status}`);
          setTag(solveTag, "풀이: 서버 에러", "tag-error");
          answerView.textContent = "solve 에러 응답:\n\n" + JSON.stringify(data, null, 2);
          return;
        }

        const answer = (data.answer || "").trim();
        if (!answer) {
          setStatus(`${modeLabel} solve 실패: answer 필드 없음`);
          setTag(solveTag, "풀이: answer 없음", "tag-error");
          answerView.textContent = "solve 응답에 answer가 없습니다:\n\n" + JSON.stringify(data, null, 2);
          return;
        }

        setStatus(`${modeLabel} solve 완료 (model=${data.model || "?"}, usedLength=${data.usedLength || "?"})`);
        setTag(solveTag, "풀이: 완료", "tag-ok");
        answerView.textContent = answer;

        // 자동으로 한 번 읽어주기까지는 부담되면 주석 처리해도 됨
        // speakAnswer();
      } catch (err) {
        setStatus("solve 호출 중 예외 발생: " + err.toString());
        setTag(solveTag, "풀이: 예외", "tag-error");
        answerView.textContent = "solve 호출 중 예외 발생:\n\n" + (err.stack || err.toString());
      } finally {
        solving = false;
      }
    }

    btnManual.addEventListener("click", () => {
      doSolve(true);
    });

    // --------- TTS (Web Speech API) ---------
    let speaking = false;
    let currentUtterance = null;

    function speakAnswer() {
      if (!("speechSynthesis" in window)) {
        alert("이 브라우저는 TTS(음성 합성)를 지원하지 않습니다.");
        return;
      }
      const text = (answerView.textContent || "").trim();
      if (!text) {
        setStatus("TTS: 읽을 정답이 없습니다.");
        return;
      }

      // 이미 읽는 중이면 중단 토글
      if (speaking) {
        window.speechSynthesis.cancel();
        speaking = false;
        setStatus("TTS: 재생 중단");
        return;
      }

      const u = new SpeechSynthesisUtterance(text);
      u.lang = "ko-KR";
      u.rate = 0.9;   // 너무 빠르지 않게
      u.pitch = 1.0;

      u.onstart = () => {
        speaking = true;
        setStatus("TTS: 정답 읽는 중...");
      };
      u.onend = () => {
        speaking = false;
        setStatus("TTS: 완료");
      };
      u.onerror = (e) => {
        speaking = false;
        setStatus("TTS 에러: " + (e.error || e.toString()));
      };

      currentUtterance = u;
      window.speechSynthesis.speak(u);
    }

    function stopTTS() {
      if (!("speechSynthesis" in window)) return;
      window.speechSynthesis.cancel();
      speaking = false;
      setStatus("TTS: 강제 중단");
    }

    btnRead.addEventListener("click", speakAnswer);
    btnStopTTS.addEventListener("click", stopTTS);

    // --------- 초기 상태 ---------
    setStatus("Firebase 연결 완료. 카메라 폰에서 index.html 열고 OCR을 시작하면 여기로 들어온다.");
    setTag(solveTag, "풀이: 대기 중", "");
  </script>
</body>
</html>
